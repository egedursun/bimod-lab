{% extends layout_path %}
{% load markdown_extras %}
{% load static %}
{% load i18n %}

{% block title %}Chat{% endblock %}

{% block vendor_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/libs/bootstrap-maxlength/bootstrap-maxlength.css' %}"/>
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/bootstrap-maxlength/bootstrap-maxlength.js' %}"></script>
{% endblock vendor_js %}

{% block page_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/css/pages/app-chat.css' %}"/>
  <style>
    .markdown-content {
      width: 100%;
      overflow-x: auto;
    }

    /* Ensure images within markdown content fit within their container */
    .markdown-content img {
      max-width: 35%;
      height: auto;
    }

    .markdown-content table {
      margin-bottom: 1rem;
    }

    .markdown-content table th, .markdown-content table td {
      border: 1px solid #aaa;
      max-width: 80%;
    }

    /* todo: handle json showing in the chat */
    .markdown-content pre code {
      display: block;
      padding: 1rem;
      overflow: auto;
      background: #000000;
      border: 1px solid #ddd;
      border-radius: 10px;
      color: #ffffff;
      font-weight: bolder;
      font-size: 10px;
      font-family: monospace;
    }
  </style>
  <style>
    /* Add this to your CSS block or stylesheet */
    .floating-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      width: 90px;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
  </style>

{% endblock page_css %}

{% block page_js %}
  {{ block.super }}
  <script src="{% static 'js/app-chat.js' %}"></script>
{% endblock page_js %}

{% block content %}

  <div class="app-chat card">
    <div class="row g-0">
      <!-- Sidebar Left -->
      <div class="col app-chat-sidebar-left app-sidebar overflow-hidden" id="app-chat-sidebar-left">
        <div
          class="chat-sidebar-left-user sidebar-header d-flex flex-column justify-content-center align-items-center flex-wrap px-6 pt-12">
          <div class="avatar avatar-xl avatar-online chat-sidebar-avatar">
            <img src="

              {% if user.profile.profile_picture %}{{ user.profile.profile_picture.url }}{% else %}{% static 'img/avatars/0.png' %}{% endif %}"
                 alt="Avatar" class="rounded">
          </div>
          <i class="ti ti-x ti-lg cursor-pointer close-sidebar" data-bs-toggle="sidebar" data-overlay
             data-target="#app-chat-sidebar-left"></i>
        </div>
      </div>
      <!-- /Sidebar Left-->
    </div>

    <!-- Chat & Assistants -->
    <div class="row g-0">
      <div class="col-3">
        <div class="col w-100 m-6">
          <img src="https://fundpath.com/wp-content/uploads/2023/10/Fundpath-Header-Logo-New.svg"
               class="img-fluid w-100" alt="Fundpath Logo" style="max-width: 200px;">
        </div>
        <div class="col app-chat-contacts app-sidebar border-end overflow-auto" style="max-height: 400px; min-width: 400px;"
             id="app-chat-contacts">
          <div class="sidebar-body">
            <!-- Assistants -->
            <ul class="list-unstyled chat-contact-list mb-0 py-2" id="assistant-list">
              <li class="chat-contact-list-item chat-contact-list-item-title mt-0">
                <h5 class="text-primary mb-0"><strong>Experts</strong></h5>
              </li>

              <!-- ######## -->
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img
                      src="https://previews.123rf.com/images/oez/oez1412/oez141200001/34264920-data-analysis-concept-eps10-file-and-included-high-resolution-jpg.jpg"
                      alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ps-2 fw-normal"><strong>Data Analysis +
                      Insights</strong></h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 rounded mt-1"><strong>Fundpath</strong></small>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 rounded mt-1 mb-1">GPT-4o / v1.2</small>
                  </div>
                </div>
              </li>
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img
                      src="https://qph.cf2.poecdn.net/main-thumb-pb-1001649-200-ngjiofgphvrrncvfddprinlsnurnvbhv.jpeg"
                      alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ps-2 fw-normal"><strong>LinkedIn</strong></h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 rounded mt-1"><strong>Fundpath</strong></small>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 rounded mt-1 mb-1">GPT-4o / v1.0</small>
                  </div>
                </div>
              </li>
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img
                      src="https://imageio.forbes.com/specials-images/dam/imageserve/1129869424/0x0.jpg?format=jpg&height=900&width=1600&fit=bounds"
                      alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ps-2 fw-normal"><strong>Daily Tiles</strong></h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 rounded mt-1"><strong>Fundpath</strong></small>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 rounded mt-1">GPT-4o / v2.0</small>
                  </div>
                </div>
              </li>
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img
                      src="https://www.limeleads.com/wp-content/uploads/2023/09/is-email-marketing-still-relevant-1.jpeg"
                      alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ps-2 fw-normal"><strong>Email Marketing</strong></h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 rounded mt-1"><strong>Fundpath</strong></small>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 rounded mt-1">GPT-4o</small>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 rounded mt-1">v1.0</small>
                  </div>
                </div>
              </li>
              <!-- ######## -->
            </ul>
          </div>
        </div>
        <div class="col app-chat-contacts app-sidebar border-end overflow-auto" style="max-height: 400px; min-width: 400px;"
             id="app-chat-contacts">
          <div class="sidebar-body">
            <!-- Assistants -->
            <ul class="list-unstyled chat-contact-list mb-0 py-2" id="assistant-list">
              <li class="chat-contact-list-item chat-contact-list-item-title mt-0">
                <h5 class="text-primary mb-0"><strong>Plugins</strong></h5>
              </li>

              <!-- ######## -->
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img
                      src="https://10.apps.zdusercontent.com/10/assets/1721646571-19b7b11fb8bc53ccad3b057bfc8f3d85/logo.png"
                      alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ms-2 fw-normal"><strong>Salesforce</strong></h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 pb-1 rounded mt-1 mb-3"><strong>Cloud CRM
                      Service</strong></small>
                    <button class="btn btn-success w-100" style="max-height: 30px;"><i
                      class="fa fa-star me-3"></i><strong>Integrate</strong></button>
                  </div>
                </div>
              </li>
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img
                      src="https://seeklogo.com/images/S/semrush-logo-8042E9DECE-seeklogo.com.png?v=638342827230000000"
                      alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ms-2 fw-normal"><strong>Semrush</strong></h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 pb-1 rounded mt-1 mb-3"><strong>Digital Marketing
                      Strategies</strong></small>
                    <button class="btn btn-success w-100" style="max-height: 30px;"><i
                      class="fa fa-star me-3"></i><strong>Integrate</strong></button>
                  </div>
                </div>
              </li>
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img src="https://s3.amazonaws.com/www-inside-design/uploads/2018/10/mailchimp-sq-810x810.jpg"
                         alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ms-2 fw-normal"><strong>Mailchimp</strong></h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 pb-1 rounded mt-1 mb-3"><strong>Email SMTP
                      Service</strong></small>
                    <button class="btn btn-success w-100" style="max-height: 30px;"><i
                      class="fa fa-star me-3"></i><strong>Integrate</strong></button>
                  </div>
                </div>
              </li>
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img
                      src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTWDfbEE2hkbejshqVUzZrmrQva_tojucyrDA&s"
                      alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ms-2 fw-normal"><strong>Hubspot</strong></h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 pb-1 rounded mt-1 mb-3"><strong>Cloud CRM
                      Service</strong></small>
                    <button class="btn btn-success w-100" style="max-height: 30px;"><i
                      class="fa fa-star me-3"></i><strong>Integrate</strong></button>
                  </div>
                </div>
              </li>
              <!-- ######## -->
            </ul>
          </div>
        </div>
      </div>
      <div class="col-6 ms-0 me-0 ps-0 pe-0">
        <div class="app-chat-history">
          <div class="chat-history-wrapper">
            <div class="chat-history-header border-bottom">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex overflow-hidden align-items-center">
                  <i class="ti ti-menu-2 ti-lg cursor-pointer d-lg-none d-block" data-bs-toggle="sidebar"
                     data-overlay="" data-target="#app-chat-contacts"></i>
                  <div class="flex-shrink-0 avatar avatar-online">
                    <img src="https://previews.123rf.com/images/oez/oez1412/oez141200001/34264920-data-analysis-concept-eps10-file-and-included-high-resolution-jpg.jpg" alt="Avatar"
                         class="rounded-circle" data-bs-toggle="sidebar" data-overlay=""
                         data-target="#app-chat-sidebar-right">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4">
                    <h6 class="m-0 fw-normal">Data Analysis + Insights</h6>
                    <small class="user-status text-body">GPT4-o</small>
                  </div>
                </div>
                <div class="d-flex align-items-center">
                  <div class="dropdown">
                    <button
                      class="btn  btn-sm btn-icon btn-text-secondary text-secondary rounded-pill dropdown-toggle hide-arrow waves-effect waves-light"
                      data-bs-toggle="dropdown" aria-expanded="true" id="chat-header-actions"><i
                      class="ti ti-dots-vertical ti-md"></i></button>
                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="chat-header-actions">
                      <a class="dropdown-item waves-effect" href="javascript:void(0);">View Contact</a>
                      <a class="dropdown-item waves-effect" href="javascript:void(0);">Mute Notifications</a>
                      <a class="dropdown-item waves-effect" href="javascript:void(0);">Block Contact</a>
                      <a class="dropdown-item waves-effect" href="javascript:void(0);">Clear Chat</a>
                      <a class="dropdown-item waves-effect" href="javascript:void(0);">Report</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="chat-history-body ps" style="min-height: 730px;">
              <ul class="list-unstyled chat-history">
                <li class="chat-message chat-message-right">
                  <div class="d-flex overflow-hidden">
                    <div class="chat-message-wrapper flex-grow-0">
                      <div class="chat-message-text">
                        <p class="mb-0">Can you find the patterns and notable insights in my dataset?</p>
                      </div>
                      <div class="text-end text-muted mt-1">
                        <i class="ti ti-checks ti-16px text-success me-1"></i>
                        <small>10:00 AM</small>
                      </div>
                    </div>
                    <div class="user-avatar flex-shrink-0 ms-4">
                      <div class="avatar avatar-sm">
                        <img src="{% static 'img/avatars/x.png' %}" alt="Avatar"
                             class="rounded-circle">
                      </div>
                    </div>
                  </div>
                </li>
                <li class="chat-message">
                  <div class="d-flex overflow-hidden">
                    <div class="user-avatar flex-shrink-0 me-4">
                      <div class="avatar avatar-sm">
                        <img src="https://previews.123rf.com/images/oez/oez1412/oez141200001/34264920-data-analysis-concept-eps10-file-and-included-high-resolution-jpg.jpg" alt="Avatar"
                             class="rounded-circle">
                      </div>
                    </div>
                    <div class="chat-message-wrapper flex-grow-1">
                      <div class="chat-message-text">
                        <p class="mb-0">Hi Chris, sure, I can check for the patterns and insights by analyzing your dataset.</p>
                      </div>
                      <div class="chat-message-text mt-2">
                        <p class="mb-0">Is there specific information or topics you would like me to focus on?</p>
                      </div>
                      <div class="text-muted mt-1">
                        <small>10:02 AM</small>
                      </div>
                    </div>
                  </div>
                </li>
                <li class="chat-message chat-message-right">
                  <div class="d-flex overflow-hidden">
                    <div class="chat-message-wrapper flex-grow-1">
                      <div class="chat-message-text">
                        <p class="mb-0">We need to understand the statistical nature of the distribution of our customers and the most important products they are demanding.</p>
                      </div>
                      <div class="text-end text-muted mt-1">
                        <i class="ti ti-checks ti-16px text-success me-1"></i>
                        <small>10:03 AM</small>
                      </div>
                    </div>
                    <div class="user-avatar flex-shrink-0 ms-4">
                      <div class="avatar avatar-sm">
                        <img src="{% static 'img/avatars/x.png' %}" alt="Avatar"
                             class="rounded-circle">
                      </div>
                    </div>
                  </div>
                </li>
                <li class="chat-message">
                  <div class="d-flex overflow-hidden">
                    <div class="user-avatar flex-shrink-0 me-4">
                      <div class="avatar avatar-sm">
                        <img src="https://previews.123rf.com/images/oez/oez1412/oez141200001/34264920-data-analysis-concept-eps10-file-and-included-high-resolution-jpg.jpg" alt="Avatar"
                             class="rounded-circle">
                      </div>
                    </div>
                    <div class="chat-message-wrapper flex-grow-1">
                      <div class="chat-message-text">
                        <p class="mb-0">I understand, please give me a second to calculate.</p>
                      </div>
                      <div class="chat-message-text mt-2">
                        <p class="mb-0">I'm currently checking your dataset...</p>
                      </div>
                      <div class="chat-message-text mt-2">
                        <p class="mb-0">Analyzing your dataset...</p>
                      </div>
                      <div class="text-muted mt-1">
                        <small>10:05 AM</small>
                      </div>
                    </div>
                  </div>
                </li>
                <li class="chat-message chat-message-right">
                  <div class="d-flex overflow-hidden">
                    <div class="chat-message-wrapper flex-grow-1">
                      <div class="chat-message-text">
                        <p class="mb-0">Thanks, I am waiting.</p>
                      </div>
                      <div class="text-end text-muted mt-1">
                        <i class="ti ti-checks ti-16px text-success me-1"></i>
                        <small>10:06 AM</small>
                      </div>
                    </div>
                    <div class="user-avatar flex-shrink-0 ms-4">
                      <div class="avatar avatar-sm">
                        <img src="{% static 'img/avatars/x.png' %}" alt="Avatar"
                             class="rounded-circle">
                      </div>
                    </div>
                  </div>
                </li>
                <li class="chat-message">
                  <div class="d-flex overflow-hidden">
                    <div class="user-avatar flex-shrink-0 me-4">
                      <div class="avatar avatar-sm">
                        <img src="https://previews.123rf.com/images/oez/oez1412/oez141200001/34264920-data-analysis-concept-eps10-file-and-included-high-resolution-jpg.jpg" alt="Avatar"
                             class="rounded-circle">
                      </div>
                    </div>
                    <div class="chat-message-wrapper flex-grow-1">
                      <div class="chat-message-text">
                        <p class="mb-0">I will purchase it for sure. üëç</p>
                      </div>
                      <div class="chat-message-text mt-2">
                        <p class="mb-0">Thanks.</p>
                      </div>
                      <div class="text-muted mt-1">
                        <small>10:08 AM</small>
                      </div>
                    </div>
                  </div>
                </li>
                <li class="chat-message chat-message-right">
                  <div class="d-flex overflow-hidden">
                    <div class="chat-message-wrapper flex-grow-1">
                      <div class="chat-message-text">
                        <p class="mb-0">Great, Feel free to get in touch.</p>
                      </div>
                      <div class="text-end text-muted mt-1">
                        <i class="ti ti-checks ti-16px text-success me-1"></i>
                        <small>10:10 AM</small>
                      </div>
                    </div>
                    <div class="user-avatar flex-shrink-0 ms-4">
                      <div class="avatar avatar-sm">
                        <img src="{% static 'img/avatars/x.png' %}" alt="Avatar"
                             class="rounded-circle">
                      </div>
                    </div>
                  </div>
                </li>
                <li class="chat-message">
                  <div class="d-flex overflow-hidden">
                    <div class="user-avatar flex-shrink-0 me-4">
                      <div class="avatar avatar-sm">
                        <img src="https://previews.123rf.com/images/oez/oez1412/oez141200001/34264920-data-analysis-concept-eps10-file-and-included-high-resolution-jpg.jpg" alt="Avatar"
                             class="rounded-circle">
                      </div>
                    </div>
                    <div class="chat-message-wrapper flex-grow-1">
                      <div class="chat-message-text">
                        <p class="mb-0">Do you have design files for Vuexy?</p>
                      </div>
                      <div class="text-muted mt-1">
                        <small>10:15 AM</small>
                      </div>
                    </div>
                  </div>
                </li>
                <li class="chat-message chat-message-right">
                  <div class="d-flex overflow-hidden">
                    <div class="chat-message-wrapper flex-grow-1 w-50">
                      <div class="chat-message-text">
                        <p class="mb-0">Yes that's correct documentation file, Design files are included with the
                          template.</p>
                      </div>
                      <div class="text-end text-muted mt-1">
                        <i class="ti ti-checks ti-16px me-1"></i>
                        <small>10:15 AM</small>
                      </div>
                    </div>
                    <div class="user-avatar flex-shrink-0 ms-4">
                      <div class="avatar avatar-sm">
                        <img src="{% static 'img/avatars/x.png' %}" alt="Avatar"
                             class="rounded-circle">
                      </div>
                    </div>
                  </div>
                </li>
              </ul>
              <div class="ps__rail-x" style="left: 0px; bottom: -669px;">
                <div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div>
              </div>
              <div class="ps__rail-y" style="top: 669px; height: 547px; right: 0px;">
                <div class="ps__thumb-y" tabindex="0" style="top: 301px; height: 246px;"></div>
              </div>
            </div>
            <!-- Chat message form -->
            <div class="chat-history-footer shadow-xs">
              <form class="form-send-message d-flex justify-content-between align-items-center ">
                <input class="form-control message-input border-0 me-4 shadow-none"
                       placeholder="Type your message here...">
                <div class="message-actions d-flex align-items-center">
                  <i
                    class="speech-to-text ti ti-microphone ti-md btn btn-sm btn-text-secondary btn-icon rounded-pill cursor-pointer text-heading waves-effect waves-light"></i>
                  <label for="attach-doc" class="form-label mb-0">
                    <i
                      class="ti ti-paperclip ti-md cursor-pointer btn btn-sm btn-text-secondary btn-icon rounded-pill mx-1 text-heading waves-effect waves-light"></i>
                    <input type="file" id="attach-doc" hidden="">
                  </label>
                  <button class="btn btn-primary d-flex send-msg-btn waves-effect waves-light">
                    <span class="align-middle d-md-inline-block d-none">Send</span>
                    <i class="ti ti-send ti-16px ms-md-2 ms-0"></i>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div class="col-3">
        <div class="d-flex align-items-start pt-4 pb-1 ps-4 pe-4 card card-border-shadow-primary"
             style="min-height: 100px; max-width: 335px;">
          <div class="flex-shrink-0 avatar">
            <img src="{% static 'img/avatars/x.png' %}" alt="Avatar" class="rounded ms-6">
          </div>
          <div class="chat-contact-info flex-grow-1 ms-4 text-start">
            <h6 class="chat-contact-name text-truncate m-0 ms-2 mt-2 fw-normal"><strong>Chris Seymour</strong></h6>
            <small class="d-block text-truncate ps-2 pt-1 pe-2 pb-1 rounded mb-3"><strong>Administrator</strong></small>
          </div>
        </div>
        <div class="col app-chat-contacts app-sidebar border-end overflow-auto" style="max-height: 420px;"
             id="app-chat-chats">
          <div class="sidebar-body">
            <!-- Chats -->
            <ul class="list-unstyled chat-contact-list py-2 mb-0" id="chat-list">
              <li class="chat-contact-list-item chat-contact-list-item-title mt-0">
                <h5 class="text-primary mb-0"><strong>Your Chats</strong></h5>
              </li>
              <li class="chat-contact-list-item chat-list-item-0 d-none">
                <h6 class="text-muted mb-0"><strong>No Chats Found</strong></h6>
              </li>
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img
                      src="https://previews.123rf.com/images/oez/oez1412/oez141200001/34264920-data-analysis-concept-eps10-file-and-included-high-resolution-jpg.jpg"
                      alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ms-2 mt-2 fw-normal"><strong>Chat 1</strong></h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 pb-1 rounded mb-3"><strong>Data Analysis +
                      Insights</strong></small>
                  </div>
                </div>
              </li>
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img
                      src="https://previews.123rf.com/images/oez/oez1412/oez141200001/34264920-data-analysis-concept-eps10-file-and-included-high-resolution-jpg.jpg"
                      alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ms-2 mt-2 fw-normal"><strong>Chat 2</strong></h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 pb-1 rounded mb-3"><strong>Data Analysis +
                      Insights</strong></small>
                  </div>
                </div>
              </li>
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img
                      src="https://www.limeleads.com/wp-content/uploads/2023/09/is-email-marketing-still-relevant-1.jpeg"
                      alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ms-2 mt-2 fw-normal"><strong>Chat 3</strong></h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 pb-1 rounded mb-3"><strong>Email
                      Marketing</strong></small>
                  </div>
                </div>
              </li>
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img
                      src="https://imageio.forbes.com/specials-images/dam/imageserve/1129869424/0x0.jpg?format=jpg&height=900&width=1600&fit=bounds"
                      alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ms-2 mt-2 fw-normal"><strong>Chat 4</strong></h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 pb-1 rounded mb-3"><strong>Daily
                      Tiles</strong></small>
                  </div>
                </div>
              </li>
            </ul>
          </div>
          <hr>
        </div>
        <div class="col app-chat-contacts app-sidebar border-end overflow-auto" style="max-height: 420px;"
             id="app-chat-chats">
          <div class="sidebar-body">
            <!-- Chats -->
            <ul class="list-unstyled chat-contact-list py-2 mb-0" id="chat-list">
              <li class="chat-contact-list-item chat-contact-list-item-title mt-0">
                <h5 class="text-primary mb-0"><strong>Your Files</strong></h5>
              </li>
              <li class="chat-contact-list-item chat-list-item-0 d-none">
                <h6 class="text-muted mb-0"><strong>No Chats Found</strong></h6>
              </li>
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img src="https://cdn-icons-png.flaticon.com/512/9496/9496460.png" alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ms-2 mt-2 fw-normal"><strong>sample-data.csv</strong>
                    </h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 pb-1 rounded mb-3"><strong>Sample Dataset
                      Name</strong></small>
                  </div>
                </div>
              </li>
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img
                      src="https://assets-global.website-files.com/5d0a61f2903f45be8e0ba3b7/64e87576e8cf2659049823e6_png.png"
                      alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ms-2 mt-2 fw-normal">
                      <strong>sample-image.png</strong></h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 pb-1 rounded mb-3"><strong>Sample Image
                      Name</strong></small>
                  </div>
                </div>
              </li>
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img
                      src="https://uxwing.com/wp-content/themes/uxwing/download/file-and-folder-type/file-pdf-color-red-icon.png"
                      alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ms-2 mt-2 fw-normal">
                      <strong>sample-document.pdf</strong></h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 pb-1 rounded mb-3"><strong>Sample Document
                      Name</strong></small>
                  </div>
                </div>
              </li>
              <li class="card card-border-shadow-dark chat-contact-list-item mb-2">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 avatar">
                    <img
                      src="https://uxwing.com/wp-content/themes/uxwing/download/file-and-folder-type/file-py-color-green-icon.png"
                      alt="Avatar" class="rounded">
                  </div>
                  <div class="chat-contact-info flex-grow-1 ms-4 text-start">
                    <h6 class="chat-contact-name text-truncate m-0 ms-2 mt-2 fw-normal"><strong>sample-code.py</strong>
                    </h6>
                    <small class="d-block text-truncate ps-2 pt-1 pe-2 pb-1 rounded mb-3"><strong>Sample Code File
                      Name</strong></small>
                  </div>
                </div>
              </li>
            </ul>
          </div>
          <hr>
        </div>
      </div>
    </div>
    <!-- /Chat & Assistants -->

    <!-- Chat History -->

    <!-- /Chat History -->

    <!-- Sidebar Right -->
    {% if active_chat %}
      <div class="row g-0">
        <div class="col app-chat-sidebar-right app-sidebar overflow-hidden h-100" id="app-chat-sidebar-right">
          <div class="sidebar-header d-flex flex-column justify-content-center align-items-center flex-wrap px-6 pt-12">
            <div class="avatar avatar-xl avatar-online chat-sidebar-avatar">
              <img src="#" alt="Avatar" class="rounded">
            </div>
            <h5 class="mt-4 mb-0">{{ active_chat.assistant.name }}</h5>
            <span>{{ active_chat.assistant.organization }}</span>
            <i class="ti ti-x ti-lg cursor-pointer close-sidebar d-block" data-bs-toggle="sidebar" data-overlay
               data-target="#app-chat-sidebar-right"></i>
          </div>
          <div class="sidebar-body p-6 pt-0">
            <div class="my-6">
              <p class="text-uppercase mb-1 text-muted">Description</p>
              <p class="mb-0">{{ active_chat.assistant.description }}</p>
            </div>
            <div class="my-6">
              <p class="text-uppercase text-muted mb-1">Details</p>
              <ul class="list-unstyled d-grid gap-4 mb-0 ms-2 py-2 text-heading">
                <li class="d-flex align-items-center">
                  <i class='fa fa-robot'></i>
                  <span
                    class="align-middle ms-2"><strong>Model Name: </strong>{{ active_chat.assistant.llm_model.model_name|upper }}</span>
                </li>
                <li class="d-flex align-items-center">
                  <i class='fa fa-temperature-2'></i>
                  <span
                    class="align-middle ms-2"><strong>Temperature: </strong>{{ active_chat.assistant.llm_model.temperature }}</span>
                </li>
                <li class="d-flex align-items-center">
                  <i class='fa fa-chalkboard-teacher'></i>
                  <span
                    class="align-middle ms-2"><strong>Audience / Tone: </strong>{{ active_chat.assistant.audience|capfirst }} / {{ active_chat.assistant.tone|capfirst }}</span>
                </li>
                <li class="d-flex align-items-center">
                  <i class='fa fa-language'></i>
                  <span
                    class="align-middle ms-2"><strong>Language: </strong>{{ active_chat.assistant.response_language|upper }}</span>
                </li>
                <li class="d-flex align-items-center">
                  <i class='fa fa-lightbulb'></i>
                  <span
                    class="align-middle ms-2"><strong>Context Strategy: </strong>{{ active_chat.assistant.context_overflow_strategy|capfirst }}</span>
                </li>
                <li class="d-flex align-items-center">
                  <i class='fa fa-people-group'></i>
                  <span
                    class="align-middle ms-2"><strong>Audience: </strong>{{ active_chat.assistant.audience|capfirst }}</span>
                </li>
                <li class="d-flex align-items-center">
                  <i class='fa fa-timeline'></i>
                  <span
                    class="align-middle ms-2"><strong>Time / Place Awareness: </strong>{{ active_chat.assistant.time_awareness|capfirst }} / {{ active_chat.assistant.place_awareness }}</span>
                </li>
              </ul>
            </div>
            <hr>
            <div class="d-flex mt-6">
              <button class="btn btn-danger w-100" data-bs-toggle="sidebar" data-overlay
                      data-target="#app-chat-sidebar-right">Delete Chat<i class='ti ti-trash ti-16px ms-2'></i></button>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
    <!-- /Sidebar Right -->
  </div>

  <!-- Freeform Drawing Modal -->
  <div class="modal fade" id="canvasEditModal" tabindex="-1" aria-labelledby="canvasEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 60%;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="canvasEditModalLabel"><strong>Draw on Canvas</strong></h5>
          <button type="button" class="btn-close bg-danger-subtle" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <hr>
        <div class="modal-body" style="justify-content: center; display: flex; align-items: center;">
          <div id="canvasContainer" class="border border-label-primary mb-8"></div>
        </div>
        <div class="alert alert-solid-info d-flex align-items-center mt-4 mb-8" role="alert"
             style="margin-left: 20%; margin-right: 20%;">
                <span class="alert-icon rounded">
                    <i class="ti ti-info-circle"></i>
                </span>
          Use the drawing tool to draw on the canvas. You can switch to the eraser to remove any drawn sections.
        </div>
        <div class="d-flex align-items-center justify-content-center align-content-center mb-12">
          <i class="fa fa-brush me-1"></i>
          <i class="fa fa-circle-dot me-12"></i>
          <input type="range" class="form-range me-12" id="brushSize" min="1" max="100" value="50"
                 style="max-width: 400px;">
          <button type="button" class="btn btn-warning m-2" id="brushTool">
            <i class="fa fa-paint-brush"></i>
          </button>
          <button type="button" class="btn btn-warning m-2" id="eraserTool">
            <i class="fa fa-eraser"></i>
          </button>
          <button type="button" class="btn btn-danger m-2" id="resetTool">
            <i class="fa fa-trash"></i>
          </button>
          <button type="button" class="btn btn-primary m-2" id="saveCanvasEdits">
            <i class="fa fa-save me-2"></i>
            <strong>Save Canvas</strong>
          </button>
        </div>
      </div>
    </div>
  </div>
  <style>
    #canvasContainer {
      width: 100%;
      height: 500px;
      display: inline-block;
      background-color: white;
    }
  </style>

  <!-- Image Edit Modal -->
  <div class="modal fade" id="imageEditModal" tabindex="-1" aria-labelledby="imageEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 80%;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageEditModalLabel"><strong>Create an Image Mask</strong></h5>
          <button type="button" class="btn-close bg-danger-subtle" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <hr>
        <div class="modal-body" style="justify-content: center; display: flex; align-items: center;">
          <div id="imageCanvas" class="border border-label-primary border-3 rounded m-2 mb-8"></div>
        </div>
        <div class="alert alert-solid-info d-flex align-items-center mt-4 mb-8" role="alert"
             style="margin-left: 20%; margin-right: 20%;">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
          Please mark the places you would like to change within the image. You can use the drawing tool to draw on
          the image. Please make sure not marking the places you would like to keep as they are, for optimal results.
        </div>
        <div class="d-flex align-items-center mb-12">
          <i class="fa fa-paint-brush me-12" style="margin-left: 20%;"></i>
          <input type="range" class="form-range me-12" id="brushSize" min="1" max="100" value="50"
                 style="max-width: 400px;">
          <button type="button" class="btn btn-secondary m-2" id="eraserTool">
            <i class="fa fa-eraser me-2"></i>
            <strong>Reset Image</strong>
          </button>
          <button type="button" class="btn btn-primary m-2" id="saveImageEdits">
            <i class="fa fa-save me-2" style="margin-right: 20%;"></i>
            <strong>Submit Image</strong>
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    @keyframes border-color-change {
      0% {
        border-color: mediumslateblue;
      }
      100% {
        border-color: #ffbf00;
      }
    }
  </style>
  <style>
    /* Add hover effect and cursor pointer to template cards */
    .card-template {
      cursor: pointer;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    .card-template:hover {
      background-color: #f0f0f0;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    }
  </style>

  <script src="https://unpkg.com/konva@9.3.14/konva.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      let stage, layer, background;
      let isDrawing = false;
      let mode = 'draw';
      let brushSize = 25;

      function initCanvas() {
        stage = new Konva.Stage({
          container: 'canvasContainer',
          width: document.getElementById('canvasContainer').offsetWidth,
          height: document.getElementById('canvasContainer').offsetHeight
        });

        layer = new Konva.Layer();
        stage.add(layer);

        background = new Konva.Rect({
          x: 0,
          y: 0,
          width: stage.width(),
          height: stage.height(),
          fill: 'white'
        });
        layer.add(background);
        layer.draw();

        stage.on('mousedown touchstart', function () {
          isDrawing = true;
        });

        stage.on('mouseup touchend', function () {
          isDrawing = false;
        });

        stage.on('mousemove touchmove', function (e) {
          if (!isDrawing) return;

          const pos = stage.getPointerPosition();

          if (mode === 'draw') {
            layer.add(new Konva.Circle({
              x: pos.x,
              y: pos.y,
              radius: brushSize / 2,
              fill: 'black'
            }));
          } else if (mode === 'erase') {
            layer.add(new Konva.Circle({
              x: pos.x,
              y: pos.y,
              radius: brushSize / 2,
              fill: 'white',
              globalCompositeOperation: 'destination-out'
            }));
          }
          layer.batchDraw();
        });
      }

      $('#canvasEditModal').on('shown.bs.modal', function () {
        initCanvas();
      });

      document.getElementById('brushSize').addEventListener('input', function () {
        brushSize = this.value;
      });

      document.getElementById('brushTool').addEventListener('click', function () {
        mode = 'draw';
      });

      document.getElementById('eraserTool').addEventListener('click', function () {
        mode = 'erase';
      });

      document.getElementById('resetTool').addEventListener('click', function () {
        // clear the layer
        layer.destroyChildren();
        layer.add(background);
        layer.draw();
      });

      document.getElementById('saveCanvasEdits').addEventListener('click', function () {
        document.getElementById('sketch-image').value = stage.toDataURL({pixelRatio: 1});
        $('#canvasEditModal').modal('hide');
        // show the thumbnail in the image staging
        const stagingElement = document.getElementById('image_display_area');
        const divElement = stagingElement.appendChild(document.createElement('div'));
        divElement.innerHTML = `
          <div class="badge bg-info d-flex align-items-center my-2">
              <strong>SKETCH <i class="fa fa-lightbulb me-4"></i></strong>
              <img src="${stage.toDataURL({pixelRatio: 0.5})}" class="img-fluid rounded" style="max-width: 100px;" alt="Image">
          </div>
          `;
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const fileInput = document.getElementById('edit-image');
      const maskInput = document.getElementById('edit-image-mask');
      let stage, layer, imageNode;
      let isErasing = false;
      let brushSize = 50;
      let originalImage;

      fileInput.addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = new Image();
            img.onload = function () {
              originalImage = img.src;
              if (stage) {
                stage.destroy();
              }
              stage = new Konva.Stage({
                container: 'imageCanvas', // Make sure this matches your canvas container ID
                width: img.width,
                height: img.height
              });

              layer = new Konva.Layer();
              stage.add(layer);

              imageNode = new Konva.Image({
                image: img,
                width: img.width,
                height: img.height
              });

              layer.add(imageNode);
              layer.draw();

              stage.on('mousedown touchstart', function () {
                isErasing = true;
              });

              stage.on('mouseup touchend', function () {
                isErasing = false;
              });

              stage.on('mousemove touchmove', function (e) {
                if (!isErasing) {
                  return;
                }

                const pos = stage.getPointerPosition();
                layer.add(new Konva.Circle({
                  x: pos.x,
                  y: pos.y,
                  radius: brushSize / 2,
                  fill: 'black',
                  globalCompositeOperation: 'destination-out'
                }));
                layer.batchDraw();
              });

              $('#imageEditModal').modal('show');
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      document.getElementById('brushSize').addEventListener('input', function () {
        brushSize = this.value;
      });

      document.getElementById('eraserTool').addEventListener('click', function () {
        // clear the layer
        layer.destroyChildren();
        layer.add(imageNode);
        layer.draw();
      });

      document.getElementById('saveImageEdits').addEventListener('click', function () {
        maskInput.value = stage.toDataURL({pixelRatio: 1});
        $('#imageEditModal').modal('hide');
      });
    });

  </script>


  <!-- Include a markdown library, for example, Showdown.js -->
  <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const converter = new showdown.Converter();
      converter.setOption('tables', true);
      converter.setOption('ghCodeBlocks', true);
      document.querySelectorAll('.markdown-content').forEach(function (element) {
        element.innerHTML = converter.makeHtml(element.innerHTML);
      });

      document.querySelectorAll('.markdown-content').forEach(function (element) {
        element.innerHTML = converter.makeHtml(element.innerHTML);
      });

      // Function to apply syntax highlighting to JSON content
      function highlightJSON(json) {
        return json
          .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:\s*)?)/g, '<span class="string">$1</span>')
          .replace(/\b(true|false|null)\b/g, '<span class="boolean">$1</span>')
          .replace(/\b\d+(\.\d+)?\b/g, '<span class="number">$&</span>');
      }

      document.querySelectorAll('.markdown-content pre code').forEach(function (block) {
        let text = block.innerText;
        // Only highlight JSON code blocks
        if (text.trim().startsWith('{') && text.trim().endsWith('}')) {
          block.innerHTML = highlightJSON(text);
        }
        // add an icon under the code block
        const activeIcon = document.createElement('i');
        activeIcon.className = 'fa fa-circle text-success ms-2 mt-6';
        const iconText = document.createElement('span');
        iconText.className = 'text text-success fw-bolder';
        iconText.style.fontFamily = 'monospace';
        iconText.innerText = ' Systems Active';
        const logIcon = document.createElement('i');
        logIcon.className = 'fa fa-circle text-warning ms-12 mt-2';
        const logText = document.createElement('span');
        logText.className = 'text text-warning fw-bolder';
        logText.style.fontFamily = 'monospace';
        logText.innerText = ' Tools Running';
        block.parentElement.appendChild(activeIcon);
        block.parentElement.appendChild(iconText);
        block.parentElement.appendChild(logIcon);
        block.parentElement.appendChild(logText);
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const chatForm = document.querySelector('.form-send-message');
      const createChatForm = document.querySelector('#create-chat-form');

      const loadingBar = document.getElementById('loadingBar');
      const loadingBarWarning = document.getElementById('loadingBarWarning');
      const submitMessageButton = document.querySelector('#send-chat-message-button');
      const retryButton = document.querySelector('#retry-response-button');

      // if the button is clicked, set the value of the message to "Your response either failed, or I didn't like it. Please try again."
      retryButton.addEventListener('click', function () {
        const chatInput = document.querySelector('.message-input');
        chatInput.value = "Your answer wasn't satisfactory, or you have made an error, or you have failed to provide a valid and comprehensive answer to me. Please try again.";
        // automatically submit
        chatForm.submit();
      });

      const loadingBarCreateChat = document.getElementById('loadingBarCreateChat');
      const loadingBarWarningCreateChat = document.getElementById('loadingBarWarningCreateChat');

      chatForm.addEventListener('submit', function (event) {
        // Show the loading bar
        loadingBar.classList.remove('d-none');
        loadingBarWarning.classList.remove('d-none');
        submitMessageButton.disabled = true;
      });

      createChatForm.addEventListener('submit', function (event) {
        // Show the loading bar
        loadingBarCreateChat.classList.remove('d-none');
        loadingBarWarningCreateChat.classList.remove('d-none');
      });

    });

    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.card-template').forEach(function (template) {
        template.addEventListener('click', function () {
          const fullText = this.getAttribute('data-full-text');
          console.log(fullText);
          const chatInput = document.querySelector('.message-input');
          chatInput.value = fullText;

          navigator.clipboard.writeText(fullText).then(() => {
            const alertContainer = document.querySelector('.alert-container');
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-solid-success d-flex align-items-center mt-4';
            successAlert.role = 'alert';
            successAlert.innerHTML = `
          <span class="alert-icon rounded">
            <i class="ti ti-check"></i>
          </span>
          Template text copied to chat input!
        `;
            alertContainer.appendChild(successAlert);

            setTimeout(() => {
              successAlert.remove();
            }, 1000);
          }).catch(err => {
            alert('Failed to copy text: ' + err);
          });
        });
      });
    });

    document.querySelectorAll('.copy-btn-plain').forEach(function (btn) {
      btn.addEventListener('click', function () {
        const messageId = this.getAttribute('data-message-id');
        const templateTextElement = document.getElementById(`copied-message-${messageId}`);
        const textToCopy = templateTextElement ? templateTextElement.innerText : '';
        const converter = new showdown.Converter();

        navigator.clipboard.writeText(textToCopy).then(() => {
          const alertContainer = this.closest('.chat-history-wrapper').querySelector('.alert-container');
          const successAlert = document.createElement('div');
          successAlert.className = 'alert alert-solid-success d-flex align-items-center mt-4';
          successAlert.role = 'alert';
          successAlert.innerHTML = `
        <span class="alert-icon rounded">
          <i class="ti ti-check"></i>
        </span>
        Plain Text copied to clipboard!
      `;
          alertContainer.appendChild(successAlert);

          setTimeout(() => {
            successAlert.remove();
          }, 1000);
        }).catch(err => {
          alert('Failed to copy text: ' + err);
        });
      });
    });

    document.querySelectorAll('.copy-btn-html').forEach(function (btn) {
      btn.addEventListener('click', function () {
        const messageId = this.getAttribute('data-message-id');
        const templateTextElement = document.getElementById(`copied-message-${messageId}`);
        const textToCopy = templateTextElement ? templateTextElement.innerText : '';
        const converter = new showdown.Converter();
        const textToCopyHtml = converter.makeHtml(textToCopy);

        navigator.clipboard.writeText(textToCopyHtml).then(() => {
          const alertContainer = this.closest('.chat-history-wrapper').querySelector('.alert-container');
          const successAlert = document.createElement('div');
          successAlert.className = 'alert alert-solid-success d-flex align-items-center mt-4';
          successAlert.role = 'alert';
          successAlert.innerHTML = `
        <span class="alert-icon rounded">
          <i class="ti ti-check"></i>
        </span>
        Formatted HTML copied to clipboard!
      `;
          alertContainer.appendChild(successAlert);

          setTimeout(() => {
            successAlert.remove();
          }, 1000);
        }).catch(err => {
          alert('Failed to copy text: ' + err);
        });
      });
    });

    document.querySelectorAll('.copy-btn-markdown').forEach(function (btn) {
      btn.addEventListener('click', function () {
        const messageId = this.getAttribute('data-message-id');
        const templateTextElement = document.getElementById(`copied-message-${messageId}`);
        const textToCopy = templateTextElement ? templateTextElement.innerText : '';
        const converter = new showdown.Converter();
        const textToCopyMarkdown = converter.makeMarkdown(textToCopy);

        navigator.clipboard.writeText(textToCopyMarkdown).then(() => {
          const alertContainer = this.closest('.chat-history-wrapper').querySelector('.alert-container');
          const successAlert = document.createElement('div');
          successAlert.className = 'alert alert-solid-success d-flex align-items-center mt-4';
          successAlert.role = 'alert';
          successAlert.innerHTML = `
        <span class="alert-icon rounded">
          <i class="ti ti-check"></i>
        </span>
        Formatted Markdown copied to clipboard!
      `;
          alertContainer.appendChild(successAlert);

          setTimeout(() => {
            successAlert.remove();
          }, 1000);
        }).catch(err => {
          alert('Failed to copy text: ' + err);
        });
      });
    });

    document.addEventListener('DOMContentLoaded', function () {
      const chatInput = document.querySelector('.message-input');

      chatInput.addEventListener('input', function () {
        this.style.height = 'auto'; // Reset the height
        this.style.height = (this.scrollHeight) + 'px'; // Set the height to match the content
      });

      document.querySelectorAll('.card-template').forEach(function (template) {
        template.addEventListener('click', function () {
          const fullText = this.getAttribute('data-full-text');
          chatInput.value = fullText;
          chatInput.style.height = 'auto'; // Reset the height
          chatInput.style.height = (chatInput.scrollHeight) + 'px'; // Adjust height to match content

          navigator.clipboard.writeText(fullText).then(() => {
            const alertContainer = document.querySelector('.alert-container');
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-solid-success d-flex align-items-center mt-4';
            successAlert.role = 'alert';
            successAlert.innerHTML = `
          <span class="alert-icon rounded">
            <i class="ti ti-check"></i>
          </span>
          Template text copied to chat input!
        `;
            alertContainer.appendChild(successAlert);
            setTimeout(() => {
              successAlert.remove();
            }, 1000);
          }).catch(err => {
            alert('Failed to copy text: ' + err);
          });
        });
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const floatingButton = document.querySelector('.floating-button');
      floatingButton.addEventListener('click', function () {
        if (floatingButton.innerHTML.includes('Chat')) {
          window.scrollTo({
            top: document.body.scrollHeight,
            behavior: 'smooth'
          });
          floatingButton.innerHTML = '<i class="fa fa-robot rounded text-dark me-2"></i><span class="text-dark"><strong>List</strong></span>';
        } else {
          window.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
          floatingButton.innerHTML = '<i class="fa fa-message me-2 text-dark"></i><span class="text-dark"><strong>Chat</strong></span>';
        }
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const btnCollapseTemplates = document.querySelector('.btn-collapse-templates');
      const cardTemplateContainer = document.querySelector('#message-templates-container');
      btnCollapseTemplates.addEventListener('click', function () {
        cardTemplateContainerClasses = cardTemplateContainer.classList;
        if (cardTemplateContainerClasses.contains('d-none')) {
          cardTemplateContainer.classList.remove('d-none');
          // convert the icon to compress
          btnCollapseTemplates.innerHTML = '<i class="fa fa-compress-arrows-alt rounded"></i><small></small>';
        } else {
          cardTemplateContainer.classList.add('d-none');
          // convert the icon to expand
          btnCollapseTemplates.innerHTML = '<i class="fa fa-expand-arrows-alt rounded"></i><small></small>';
        }
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('attach-doc').addEventListener('change', function (event) {
        const fileList = Array.from(event.target.files);
        const fileDisplayArea = document.getElementById('file_display_area');
        fileDisplayArea.innerHTML = '<small class="text-muted mb-2 ms-6"><strong>Media File Staging</strong></small><hr>';
        fileList.forEach((file, index) => {
          const fileSize = (file.size / 1024).toFixed(2) + ' KB';
          const fileExtension = file.name.split('.').pop().toLowerCase();
          const iconMap = {
            'jpg': 'jpg.png',
            'png': 'png.png',
            'gif': 'gif.png',
            'svg': 'svg.png',
            'bmp': 'bmp.png',
            'tiff': 'tiff.png',
            'mp3': 'mp3.png',
            'wav': 'wav.png',
            'flac': 'flac.png',
            'aac': 'aac.png',
            'ogg': 'ogg.png',
            'mp4': 'mp4.png',
            'avi': 'avi.png',
            'mkv': 'mkv.png',
            'mov': 'mov.png',
            'zip': 'zip.png',
            'rar': 'rar.png',
            'tar': 'tar.png',
            'py': 'py.png',
            'js': 'js.png',
            'ts': 'ts.png',
            'php': 'php.png',
            'css': 'css.png',
            'html': 'html.png',
            'java': 'java.png',
            'c': 'c.png',
            'cpp': 'cpp.png',
            'h': 'h.png',
            'sh': 'sh.png',
            'go': 'go.png',
            'dart': 'dart.png',
            'yml': 'yml.png',
            'yaml': 'yaml.png',
            'sql': 'sql.png',
            'pkl': 'pkl.png',
            'csv': 'csv.png',
            'xlsx': 'xlsx.png',
            'json': 'json.png',
            'xml': 'xml.png',
            'tsv': 'tsv.png',
            'docx': 'docx.png',
            'pptx': 'pptx.png',
            'pdf': 'pdf.png',
            'txt': 'txt.png',
          };
          const icon = iconMap[fileExtension] || 'file.png';
          let filename_root = file.name.split(".")[0];
          let filename_extension = file.name.split(".")[1];
          if (filename_root.length > 64) {
            filename_root = filename_root.substring(0, 64) + '...';
          }
          const fileElement = document.createElement('div');
          fileElement.classList.add('col-lg-12');
          fileElement.innerHTML = `
                    <div class="badge bg-lighter d-flex align-items-center my-2">
                        <img src="{% static 'img/icons/misc/' %}${icon}" alt="${fileExtension}" width="15" class="me-2">
                        <span class="h6 mb-0 text-body"><strong>${filename_root}.${filename_extension}</strong> (${fileSize})</span>
                        <button type="button" class="btn-close ms-auto" aria-label="Remove" data-index="${index}"></button>
                    </div>
                `;
          fileDisplayArea.appendChild(fileElement);
        });

        document.querySelectorAll('.btn-close').forEach(button => {
          button.addEventListener('click', function () {
            const index = this.getAttribute('data-index');
            fileList.splice(index, 1);
            const dataTransfer = new DataTransfer();
            fileList.forEach(file => dataTransfer.items.add(file));
            document.getElementById('attach-doc').files = dataTransfer.files;
            this.parentElement.remove();
          });
        });
      });

      document.getElementById('attach-image').addEventListener('change', function (event) {
        const fileList = Array.from(event.target.files);
        const fileDisplayArea = document.getElementById('image_display_area');
        fileDisplayArea.innerHTML = '<small class="text-muted mb-2 ms-6"><strong>Media Image Staging</strong></small><hr>';
        fileList.forEach((file, index) => {
          const fileSize = (file.size / 1024).toFixed(2) + ' KB';
          const fileExtension = file.name.split('.').pop().toLowerCase();
          const image_data = null; // ????
          let filename_root = file.name.split(".")[0];
          let filename_extension = file.name.split(".")[1];
          if (filename_root.length > 64) {
            filename_root = filename_root.substring(0, 64) + '...';
          }
          const fileElement = document.createElement('div');
          fileElement.classList.add('col-lg-12');

          const reader = new FileReader();
          reader.onload = function (e) {
            const imageUrl = e.target.result;
            fileElement.innerHTML = `
                          <div class="badge bg-lighter d-flex align-items-center my-2">
                              <img src="${imageUrl}" alt="${fileExtension}" width="50" class="me-2">
                              <span class="h6 mb-0 text-body"><strong>${filename_root}.${filename_extension}</strong> (${fileSize})</span>
                              <button id="btn-close-image-${index}" type="button" class="btn-close ms-auto" aria-label="Remove" data-index="${index}"></button>
                          </div>
                      `;
            fileDisplayArea.appendChild(fileElement);

            document.getElementById(`btn-close-image-${index}`).addEventListener('click', function () {
              const index = this.getAttribute('data-index');
              fileList.splice(index, 1);
              const dataTransfer = new DataTransfer();
              fileList.forEach(file => dataTransfer.items.add(file));
              document.getElementById('attach-image').files = dataTransfer.files;
              this.parentElement.remove();
            });
          };
          reader.readAsDataURL(file);
        });

        document.querySelectorAll('.btn-close').forEach(button => {
          button.addEventListener('click', function () {
            const index = this.getAttribute('data-index');
            fileList.splice(index, 1);
            const dataTransfer = new DataTransfer();
            fileList.forEach(file => dataTransfer.items.add(file));
            document.getElementById('attach-doc').files = dataTransfer.files;
            this.parentElement.remove();
          });
        });

        document.getElementById('.btn-close-image').forEach(button => {
          button.addEventListener('click', function () {
            const index = this.getAttribute('data-index');
            fileList.splice(index, 1);
            const dataTransfer = new DataTransfer();
            fileList.forEach(file => dataTransfer.items.add(file));
            document.getElementById('attach-image').files = dataTransfer.files;
            this.parentElement.remove();
          });
        });
      });

      document.getElementById('edit-image').addEventListener('change', function (event) {
        const fileList = Array.from(event.target.files);
        const fileDisplayArea = document.getElementById('image_display_area');
        fileDisplayArea.innerHTML = '<small class="text-muted mb-2 ms-6"><strong>Image Modification Staging</strong></small><hr>';
        fileList.forEach((file, index) => {
          const fileSize = (file.size / 1024).toFixed(2) + ' KB';
          const fileExtension = file.name.split('.').pop().toLowerCase();
          const image_data = null; // ????
          let filename_root = file.name.split(".")[0];
          let filename_extension = file.name.split(".")[1];
          if (filename_root.length > 64) {
            filename_root = filename_root.substring(0, 64) + '...';
          }
          const fileElement = document.createElement('div');
          fileElement.classList.add('col-lg-12');

          const reader = new FileReader();
          reader.onload = function (e) {
            const imageUrl = e.target.result;
            fileElement.innerHTML = `
                          <div class="badge bg-warning d-flex align-items-center my-2">
                              <strong>MOD <i class="fa fa-bolt-lightning me-4"></i></strong>
                              <img src="${imageUrl}" alt="${fileExtension}" width="50" class="me-2">
                              <span class="h6 mb-0 text-white"><strong>${filename_root}.${filename_extension}</strong> (${fileSize})</span>
                              <button id="btn-close-image-${index}" type="button" class="btn-close ms-auto" aria-label="Remove" data-index="${index}"></button>
                          </div>
                      `;
            fileDisplayArea.appendChild(fileElement);

            document.getElementById(`btn-close-image-${index}`).addEventListener('click', function () {
              const index = this.getAttribute('data-index');
              fileList.splice(index, 1);
              const dataTransfer = new DataTransfer();
              fileList.forEach(file => dataTransfer.items.add(file));
              document.getElementById('attach-image').files = dataTransfer.files;
              this.parentElement.remove();
            });
          };
          reader.readAsDataURL(file);
        });

        document.querySelectorAll('.btn-close').forEach(button => {
          button.addEventListener('click', function () {
            const index = this.getAttribute('data-index');
            fileList.splice(index, 1);
            const dataTransfer = new DataTransfer();
            fileList.forEach(file => dataTransfer.items.add(file));
            document.getElementById('attach-doc').files = dataTransfer.files;
            this.parentElement.remove();
          });
        });

        document.getElementById('.btn-close-image').forEach(button => {
          button.addEventListener('click', function () {
            const index = this.getAttribute('data-index');
            fileList.splice(index, 1);
            const dataTransfer = new DataTransfer();
            fileList.forEach(file => dataTransfer.items.add(file));
            document.getElementById('attach-image').files = dataTransfer.files;
            this.parentElement.remove();
          });
        });
      });
    });
  </script>

{% endblock %}
