<!--
~ Copyright (c) 2024 BMD™ Autonomous Holdings. All rights reserved.
~
~ Project: Bimod.io™
~ File: list_starred_messages.html
~ Last Modified: 2024-10-05 01:39:48
~ Author: Ege Dogan Dursun (Co-Founder & Chief Executive Officer / CEO @ BMD™ Autonomous Holdings)
~ Created: 2024-10-05 14:42:44
~
~ This software is proprietary and confidential. Unauthorized copying,
~ distribution, modification, or use of this software, whether for
~ commercial, academic, or any other purpose, is strictly prohibited
~ without the prior express written permission of BMD™ Autonomous
~ Holdings.
~
~  For permission inquiries, please contact: admin@Bimod.io.
~
-->

{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Starred Messages{% endblock %}

{% block page_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/css/pages/page-profile.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/sweetalert2/sweetalert2.css' %}" />
  <style>
    /* Ensure images within markdown content fit within their container */
    .markdown-content img {
      max-width: 100%;
      height: auto;
    }
  </style>
{% endblock page_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/sweetalert2/sweetalert2.js' %}"></script>
{% endblock vendor_js %}

{% block content %}

  <div class="row g-6 mb-6">
    <div class="col-sm-6 col-xl-4">
      <h3 class="mb-0">
        <strong>Starred Responses</strong>
      </h3>
    </div>
  </div>

  <div class="tips-section alert alert-secondary alert-dismissible d-flex col-lg-12 align-items-center" role="alert">
    <img src="{% static 'img/custom-illustrations-v2/i2-16.png' %}" width="25%" style="border-radius: 25px;"
         class="justify-content-end me-8" alt="Illustration for tip">
    <span class="alert-icon rounded ms-4">
    <i class="ti ti-bookmark"></i>
  </span>
    <div class="d-flex flex-column ps-1">
      <h5 class="alert-heading mb-2">Tip</h5>
      <p class="mb-0">
        The starred messages are the messages you have starred for quick reference. You can view the starred messages
        here and copy the message content to the clipboard. The starred messages are used to keep track of the important
        messages that you want to refer to later. You can also delete the starred messages if you no longer need them.
      </p>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
      </button>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div
        class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-danger{% endif %}"
        role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <hr>

  <!-- Starred Messages Cards -->
  <div class="row g-6 mt-4">
    {% for org_name, assistants in org_assistants_messages.items %}
      <div class="col-12 mb-8">
        <h4>
          <strong>
            <i class="fa fa-building me-4"></i>
            {{ org_name }}
          </strong>
        </h4>
        {% for assistant_name, messages in assistants.items %}
          <div class="mb-4 card card-border-shadow-primary p-8">
            <div class="d-flex">
              <img src="
                {% if messages.0.assistant.assistant_image %}{{ messages.0.assistant.assistant_image.url }}{% else %}{% static 'img/avatars/org-0.jpg' %}{% endif %}"
                   alt="Avatar" class="rounded me-4" style="width: 80px; height: 80px;" />
              <h5>
                <strong>{{ assistant_name }}</strong>
              </h5>
            </div>
            <div class="row mt-4">
              {% for message in messages %}
                <div class="col-xl-6 col-lg-6 col-md-6 mb-6 d-flex">
                  <div class="card w-100">
                    <div class="card-header pb-4">
                      <div class="d-flex align-items-start">
                        <div class="d-flex align-items-center">
                          <div class="me-4">
                            <img src="

                              {% if message.assistant.assistant_image %}{{ message.assistant.assistant_image.url }}{% else %}{% static 'img/avatars/org-0.jpg' %}{% endif %}"
                                 alt="Avatar" class="rounded" width="70" height="70" />
                          </div>
                          <div class="me-2">
                            <div class="label btn-primary rounded mt-2 pt-1 pb-1 ps-2 pe-2">
                              <div class="client-info text-body"><strong class="text-white"><span
                                class="fw-medium me-4"><i class="fa fa-building me-4"></i> Chat Name: </span><span>
                                {{ message.chat.chat_name }}
                              </span></strong></div>
                            </div>
                            <div
                              class="label {% if message.sender_type == "USER" %}btn-info{% else %}btn-danger{% endif %} rounded mt-2 pt-1 pb-1 ps-2 pe-2">
                              <div class="client-info text-body"><strong class="text-white"><span
                                class="fw-medium me-4"><i
                                class="fa fa-building me-4"></i>Sender Role: </span><span>{{ message.sender_type|lower|capfirst }}</span></strong>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="ms-auto">
                          <div class="dropdown z-2">
                            <button type="button"
                                    class="btn btn-icon btn-text-secondary rounded-pill dropdown-toggle hide-arrow p-0"
                                    data-bs-toggle="dropdown" aria-expanded="false"><i
                              class="ti ti-dots-vertical ti-md text-muted"></i></button>
                            <ul class="dropdown-menu dropdown-menu-end">
                              <li><a class="dropdown-item text-danger"
                                     href="{% url 'starred_messages:delete' message.id %}">
                                <i class="fa fa-trash me-2"></i>
                                <strong>Delete</strong>
                              </a></li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="card card-border-primary p-4 mt-4 mb-4">
                        <p class="card-text truncated-text" id="truncated-{{ message.id }}">
                          {{ message.message_text|linebreaksbr|safe|slice:":400" }}
                          {% if message.message_text|length > 200 %}...{% endif %}</p>
                        <div id="full-text-{{ message.id }}" class="collapse">
                          <hr>
                          <p class="text-primary mb-2"><strong>Full Text</strong></p>
                          <p class="card-text markdown-content">{{ message.message_text|linebreaksbr|safe }}</p>
                          <hr>
                          <small class="text-muted"><strong>Image Content</strong></small>
                          <div class="row mb-4">
                            {% for image_url in message.message_image_urls %}
                              <div class="col-6 mt-4">
                                <img src="{{ base_url }}/{{ image_url }}" alt="Image" class="img-fluid rounded" />
                              </div>
                            {% empty %}
                              <div class="col-12 mt-4">
                                <div class="alert alert-warning p-4 border border-2 border-warning rounded" role="alert">
                                  <i class="fa fa-exclamation-triangle me-2"></i>
                                  <strong>No image content found for this message.</strong>
                                </div>
                              </div>
                            {% endfor %}
                          </div>
                          <hr>
                          <small class="text-muted"><strong>File Content</strong></small>
                          <div class="row mb-4 w-100">
                            {% for file_url in message.message_file_urls %}
                              <div class="col-6 mt-4 ms-4 bg-label-primary p-2 rounded">
                                <i class="fa fa-file text-dark me-2"></i>
                                <strong><a href="{{ base_url }}/{{ file_url }}" target="_blank"
                                           class="text-dark">{{ file_url }}</a></strong>
                              </div>
                            {% empty %}
                              <div class="col-12 mt-4">
                                <div class="alert alert-warning p-4 border border-2 border-warning rounded" role="alert">
                                  <i class="fa fa-exclamation-triangle me-2"></i>
                                  <strong>No file content found for this message.</strong>
                                </div>
                              </div>
                            {% endfor %}
                          </div>
                          <hr>
                        </div>
                        <hr>
                        <strong><small>
                          <a href="javascript:void(0);" class="expand-btn" data-bs-toggle="collapse"
                             data-bs-target="#full-text-{{ message.id }}" aria-expanded="false"
                             aria-controls="full-text-{{ message.id }}">
                            <i class="fa fa-expand"></i><span class="ms-2">Expand / Collapse</span>
                          </a>
                          <a href="javascript:void(0);" class="copy-btn ms-12" data-message-id="{{ message.id }}">
                            <i class="fa fa-copy"></i><span class="ms-2">Copy to Clipboard</span>
                          </a>
                        </small></strong>
                      </div>
                      <small class="mt-8"><strong>
                        <i class="fa fa-calendar me-2"></i>
                        Starred At: &nbsp;</strong> {{ message.starred_at|date:"d M Y, H:i" }}
                      </small>
                      <div class="alert-container"></div>
                    </div>
                  </div>
                </div>
              {% empty %}
                <div class="col-12 ms-8 me-8">
                  <div class="alert alert-warning" role="alert">
                    No starred messages found for assistant.
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% empty %}
          <div class="alert alert-warning ms-8 me-8" role="alert">
            No starred messages found for assistant.
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>
  <!--/ Starred Messages Cards -->

  <!-- Include a markdown library, for example, Showdown.js -->
  <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const converter = new showdown.Converter();
      document.querySelectorAll('.markdown-content').forEach(function(element) {
        element.innerHTML = converter.makeHtml(element.innerHTML);
      });

      document.querySelectorAll('.expand-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          const target = document.querySelector(this.getAttribute('data-bs-target'));
          const truncatedText = document.getElementById(`truncated-${this.getAttribute('data-bs-target').split('-')[2]}`);

          if (target.classList.contains('show')) {
            truncatedText.style.display = 'block';
          } else {
            truncatedText.style.display = '';
          }
        });
      });

      document.querySelectorAll('.copy-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          const messageId = this.getAttribute('data-message-id');
          const messageTextElement = document.getElementById(`full-text-${messageId}`);
          const textToCopy = messageTextElement ? messageTextElement.innerText : '';

          navigator.clipboard.writeText(textToCopy).then(() => {
            const alertContainer = this.closest('.card-body').querySelector('.alert-container');
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-solid-success d-flex align-items-center mt-4';
            successAlert.role = 'alert';
            successAlert.innerHTML = `
          <span class="alert-icon rounded">
            <i class="ti ti-check"></i>
          </span>
          Starred Message copied to clipboard!
        `;
            alertContainer.appendChild(successAlert);

            setTimeout(() => {
              successAlert.remove();
            }, 1000);
          }).catch(err => {
            alert('Failed to copy text: ' + err);
          });
        });
      });

      document.querySelectorAll('.text-danger').forEach(function(button) {
        button.addEventListener('click', function(event) {
          event.preventDefault();
          const form = button.closest('a').getAttribute('href');

          Swal.fire({
            title: 'Are you sure?',
            text: 'You won\'t be able to revert this action.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            customClass: {
              confirmButton: 'btn btn-danger me-2 waves-effect waves-light',
              cancelButton: 'btn btn-label-secondary waves-effect waves-light'
            },
            buttonsStyling: false
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = form;
            }
          });
        });
      });
    });

  </script>

{% endblock %}
