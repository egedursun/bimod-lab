  <!--
  ~ Copyright (c) 2024 BMD™ Autonomous Holdings. All rights reserved.
  ~
  ~ Project: Bimod.io™
  ~ File: manage_script_connections.html
  ~ Last Modified: 2024-10-05 01:39:48
  ~ Author: Ege Dogan Dursun (Co-Founder & Chief Executive Officer / CEO @ BMD™ Autonomous Holdings)
  ~ Created: 2024-10-05 14:42:38
  ~
  ~ This software is proprietary and confidential. Unauthorized copying,
  ~ distribution, modification, or use of this software, whether for
  ~ commercial, academic, or any other purpose, is strictly prohibited
  ~ without the prior express written permission of BMD™ Autonomous
  ~ Holdings.
  ~
  ~  For permission inquiries, please contact: admin@Bimod.io.
  ~
  -->

{% extends layout_path %}

{% load static %}
{% load i18n %}
{% load get_script_item %}

{% block title %}Manage Script Connections{% endblock %}

{% block vendor_css %}
  {{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-bs5/datatables.bootstrap5.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}"/>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.7.2/font/bootstrap-icons.min.css">
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
  <script src="{% static 'vendor/libs/datatables-bs5/datatables-bootstrap5.js' %}"></script>
  <script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
  {{ block.super }}
  <script src="{% static 'js/app-assistant-connections.js' %}"></script>
{% endblock page_js %}

{% block content %}
  <div class="row g-6 mb-6">
    <div class="col-sm-6 col-xl-4">
      <h3 class="mb-0"><strong>Manage Script Connections</strong></h3>
    </div>
  </div>

  <a href="{% url 'mm_scripts:list' %}">
    <button class="btn btn-secondary mb-8">
      <i class="fa fa-dashboard me-4"></i>
      <strong> Manage Custom Scripts</strong>
    </button>
  </a>
  <a href="{% url 'mm_scripts:store' %}">
    <button class="btn btn-warning ms-4 mb-8">
      <i class="fa fa-store me-4"></i>
      <strong> Script Store</strong>
    </button>
  </a>

  <div class="tips-section alert alert-secondary alert-dismissible d-flex col-lg-12 align-items-center" role="alert">
    <img src="{% static 'img/custom-illustrations-v2/i2-32.png' %}" width="25%" style="border-radius: 25px;"
         class="justify-content-end me-8" alt="Illustration for tip">
    <span class="alert-icon rounded ms-4">
    <i class="bi bi-info-circle"></i>
  </span>
    <div class="d-flex flex-column ps-1">
      <h5 class="alert-heading mb-2">Tip</h5>
      <p class="mb-0">
        Welcome to the Assistant Connections Manager! Here you can see all the scripts connected to your assistants.
        You can also connect new scripts to your assistants or remove existing connections. To connect a new script,
        select the script from the dropdown and click on the "Create Connection" button. To remove a connection, click
        on
        the "Remove Connection" button.
      </p>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
      </button>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div
        class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-danger{% endif %}"
        role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <hr>

  {% for organization in connected_organizations %}
    <div class="card mb-6">
      <div class="card-header border-bottom">
        <a data-bs-toggle="collapse" href="#collapse-{{ organization.id }}" role="button" aria-expanded="true"
           aria-controls="collapse-{{ organization.id }}">
          <div class="d-flex">
            <img src="

              {% if organization.organization_image %}{{ organization.organization_image.url }}{% else %}{% static 'img/avatars/org-0.png' %}{% endif %}"
                 class="rounded me-4" width="60" height="60" alt="Organization Image">
            <strong>{{ organization.name }}</strong>
          </div>
        </a>
        <i class="fa fa-arrow-alt-circle-up toggle-icon mt-8" data-target="#collapse-{{ organization.id }}"></i>
        <span data-bs-toggle="collapse" href="#collapse-{{ organization.id }}" role="button" aria-expanded="true"
              aria-controls="collapse-{{ organization.id }}">
      <strong>&nbsp; See Connected Scripts</strong>
    </span>
      </div>
      <div id="collapse-{{ organization.id }}" class="card-datatable table-responsive collapse show overflow-auto">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table">
              <thead class="border-top">
              <tr>
                <th></th>
                <th>Assistant</th>
                <th>Manage Internal Scripts</th>
                <th>Connect Internal Scripts</th>
                <th>Manage External Scripts</th>
              </tr>
              </thead>
              <tbody>
              {% for assistant in assistants %}
                {% if assistant.organization == organization %}
                  <tr>
                    <td><img class="avatar avatar-lg rounded" alt="Assistant image" src="
                      {% if assistant.assistant_image %}{{ assistant.assistant_image.url }}{% else %}{% static 'img/avatars/org-0.png' %}{% endif %}">
                    </td>
                    <td style="min-width: 300px;">
                      <strong><i class="fa fa-robot me-4"></i>{{ assistant.name }}</strong>
                      <br>
                      <i class="fa fa-info-circle me-5 mt-2"></i><small>{{ assistant.description|linebreaksbr }}</small>
                    </td>
                    <td>
                      <ul class="list-unstyled overflow-auto bg-label-secondary rounded p-2" style="max-height: 400px;">
                        {% for reference in assistant_script_map|get_script_item:assistant.id %}
                          <li class="m-3 p-3 bg-label-primary border rounded d-flex align-items-start"
                              style="min-width: 400px;">
                            <!-- Script Image -->
                            <img class="avatar avatar-lg rounded me-4"
                                 src="

                                   {% if reference.custom_script.script_picture %}{{ reference.custom_script.script_picture.url }}{% else %}{% static 'img/avatars/org-0.png' %}{% endif %}"
                                 alt="{{ reference.custom_script.name }}"
                                 style="width: 60px; height: 60px; object-fit: cover;">

                            <!-- Script Details -->
                            <div class="flex-grow-1 d-flex flex-column">
                              <div class="d-flex justify-content-between align-items-center">
                                <!-- Script Name -->
                                <strong class="text-dark"><small>{{ reference.custom_script.name }}</small></strong>

                                <!-- Script Visibility Badge -->
                                <span
                                  class="badge {% if reference.custom_script.is_public %}bg-success{% else %}bg-warning{% endif %} px-1 py-1">
                        <i class="fa fa-globe me-1"></i>{{ reference.custom_script.is_public|yesno:"Public,Private" }}
                    </span>
                              </div>

                              <!-- Remove Connection Button -->
                              <div class="d-flex justify-content-end mt-2">
                                <form method="post">
                                  {% csrf_token %}
                                  <input type="hidden" name="assistant_id" value="{{ assistant.id }}">
                                  <input type="hidden" name="reference_id" value="{{ reference.id }}">
                                  <input type="hidden" name="action" value="remove">
                                  <button type="submit" class="btn btn-danger btn-sm d-flex align-items-center">
                                    <i class="fa fa-trash me-1"></i><strong>Disconnect</strong>
                                  </button>
                                </form>
                              </div>
                            </div>
                          </li>
                        {% empty %}
                          <div class="alert alert-warning p-2 m-2" role="alert">
                            <div class="">
                              <i class="fa fa-exclamation-triangle me-4"></i>
                              <strong>No internal scripts connected to this assistant.</strong>
                            </div>
                          </div>
                        {% endfor %}
                      </ul>
                    </td>
                    <td>
                      <form method="post" class="d-inline-block">
                        {% csrf_token %}
                        <input type="hidden" name="assistant_id" value="{{ assistant.id }}">
                        <input type="hidden" name="action" value="add">
                        <select name="script_id" class="form-select form-select-sm">
                          <option value="">Select Script</option>
                          {% for script in scripts %}
                            <!-- put only if not already in the script references -->
                            {% if script.id not in assistant_script_map|get_script_ids:assistant.id %}
                              <option value="{{ script.id }}">{{ script.name }}</option>
                            {% endif %}
                          {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-sm btn-primary mt-1 w-100"
                                style="min-width: 180px;">
                          <i class="fa fa-plus me-4"></i>
                          <strong>Connect</strong>
                        </button>
                      </form>
                    </td>
                    <td style="min-width: 400px;">
                      <ul class="list-unstyled overflow-auto bg-label-secondary rounded p-2" style="max-height: 400px;">
                        {% for reference in external_script_references_map|get_script_item:assistant.id %}
                          <li class="m-3 p-3 bg-label-primary border rounded d-flex align-items-start"
                              style="min-width: 400px;">
                            <!-- Script Image -->
                            <img class="avatar avatar-lg rounded me-4"
                                 src="
                                   {% if reference.custom_script.script_picture %}{{ reference.custom_script.script_picture.url }}{% else %}{% static 'img/avatars/org-0.png' %}{% endif %}"
                                 alt="{{ reference.custom_script.name }}"
                                 style="width: 60px; height: 60px; object-fit: cover;">

                            <!-- Script Details -->
                            <div class="flex-grow-1 d-flex flex-column">
                              <div class="d-flex justify-content-between align-items-center">
                                <!-- Script Name -->
                                <strong class="text-dark"><small>{{ reference.custom_script.name }}</small></strong>

                                <!-- Script Visibility Badge -->
                                <span
                                  class="badge {% if reference.custom_script.is_public %}bg-success{% else %}bg-warning{% endif %} px-1 py-1">
                        <i class="fa fa-globe me-1"></i>{{ reference.custom_script.is_public|yesno:"Public,Private" }}
                    </span>
                              </div>
                              <!-- Remove Connection Button -->
                              <div class="d-flex justify-content-end mt-2">
                                <form method="post">
                                  {% csrf_token %}
                                  <input type="hidden" name="assistant_id" value="{{ assistant.id }}">
                                  <input type="hidden" name="reference_id" value="{{ reference.id }}">
                                  <input type="hidden" name="action" value="remove">
                                  <button type="submit" class="btn btn-danger btn-sm d-flex align-items-center">
                                    <i class="fa fa-trash me-1"></i><strong>Disconnect</strong>
                                  </button>
                                </form>
                              </div>
                            </div>
                          </li>
                        {% empty %}
                          <div class="alert alert-warning p-2 m-2" role="alert">
                            <div class="">
                              <i class="fa fa-exclamation-triangle me-4"></i>
                              <strong>No external scripts connected to this assistant.</strong>
                            </div>
                          </div>
                        {% endfor %}
                      </ul>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      $('.select2').select2();

      document.querySelectorAll('.toggle-icon').forEach(function (icon) {
        icon.addEventListener('click', function () {
          var target = document.querySelector(this.getAttribute('data-target'));
          var bootstrapCollapse = new bootstrap.Collapse(target, {
            toggle: false
          });
          if (target.classList.contains('show')) {
            bootstrapCollapse.hide();
            this.classList.remove('fa-arrow-alt-circle-up');
            this.classList.add('fa-arrow-alt-circle-down');
          } else {
            bootstrapCollapse.show();
            this.classList.remove('fa-arrow-alt-circle-down');
            this.classList.add('fa-arrow-alt-circle-up');
          }
        });
      });

      document.querySelectorAll('.collapse').forEach(function (collapse) {
        collapse.addEventListener('show.bs.collapse', function () {
          var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
          if (icon) {
            icon.classList.remove('fa-arrow-alt-circle-down');
            icon.classList.add('fa-arrow-alt-circle-up');
          }
        });

        collapse.addEventListener('hide.bs.collapse', function () {
          var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
          if (icon) {
            icon.classList.remove('fa-arrow-alt-circle-up');
            icon.classList.add('fa-arrow-alt-circle-down');
          }
        });
      });
    });
  </script>

{% endblock %}
