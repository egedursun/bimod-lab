  <!--
  ~ Copyright (c) 2024 BMD™ Autonomous Holdings. All rights reserved.
  ~
  ~ Project: Bimod.io™
  ~ File: list_transactions.html
  ~ Last Modified: 2024-10-05 01:39:48
  ~ Author: Ege Dogan Dursun (Co-Founder & Chief Executive Officer / CEO @ BMD™ Autonomous Holdings)
  ~ Created: 2024-10-05 14:42:43
  ~
  ~ This software is proprietary and confidential. Unauthorized copying,
  ~ distribution, modification, or use of this software, whether for
  ~ commercial, academic, or any other purpose, is strictly prohibited
  ~ without the prior express written permission of BMD™ Autonomous
  ~ Holdings.
  ~
  ~  For permission inquiries, please contact: admin@Bimod.io.
  ~
  -->

{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Transactions{% endblock %}

{% block vendor_css %}
  {{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-bs5/datatables.bootstrap5.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/sweetalert2/sweetalert2.css' %}"/>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.7.2/font/bootstrap-icons.min.css">
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
  <script src="{% static 'vendor/libs/datatables-bs5/datatables-bootstrap5.js' %}"></script>
  <script src="{% static 'vendor/libs/sweetalert2/sweetalert2.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
  {{ block.super }}
  <script src="{% static 'js/transactions-list.js' %}"></script>
  <script src="{% static 'js/transactions-delete.js' %}"></script>
{% endblock page_js %}

{% block content %}

  <div class="row g-6 mb-6">
    <div class="col-sm-6 col-xl-3">
      <h3 class="mb-0"><strong>Transactions &amp; Balance</strong></h3>
    </div>
    <!-- Add more statistics cards if necessary -->
  </div>

  <div class="tips-section alert alert-secondary alert-dismissible d-flex col-lg-12 align-items-center" role="alert">
    <img src="{% static 'img/custom-illustrations-v2/i2-12.png' %}" width="25%" style="border-radius:25px;"
         class="justify-content-end me-8" alt="Illustration for tip">
    <span class="alert-icon rounded">
    <i class="ti ti-bookmark"></i>
  </span>
    <div class="d-flex flex-column ps-1">
      <h5 class="alert-heading mb-2">Tip</h5>
      <p class="mb-0">
        In this page, you can view all the transactions you have made. You can also top-up the balance for your
        organizations, and view the total cost of the services you have used. To filter the transactions, use the
        filter options at the top of the page. "All Transactions" button will show all the transactions you have made,
        regardless of the time period. "Update" button will show the transactions you have made in the specified
        time period you have entered.
      </p>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
      </button>
    </div>
  </div>
  <hr>
  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %}"
           role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
  <div class="row mb-6 mt-8 card card-border-shadow-primary p-8">
    <div class="col-sm-12 col-xl-12">
       <img src="{% static 'img/llm_transactions/tx-3.png' %}"
                   class="rounded" style="width: 100%;" alt="Illustration for tips">
      <h5 class="text-muted mt-8"><strong>Transfer Balance</strong></h5>
      <hr>
      <form method="post" action="{% url 'organization:balance_transfer' %}">
        {% csrf_token %}
        <div class="mb-3">
          <label for="source_org" class="form-label"><i class="fa fa-minus-circle me-2"></i>Source Organization</label>
          <select class="form-select" id="source_org" name="source_org" required>
            {% for org in user_organizations %}
              <option value="{{ org.id }}">
                {{ org.name }} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [ Balance: ${{ org.balance }} ]
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label for="destination_org" class="form-label"><i class="fa fa-plus-circle me-2"></i>Target
            Organization</label>
          <select class="form-select" id="destination_org" name="destination_org" required>
            {% for org in user_organizations %}
              <option value="{{ org.id }}">
                {{ org.name }} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [ Balance: ${{ org.balance }} ]
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label for="transfer_amount" class="form-label">Transfer Amount</label>
          <input type="number" class="form-control" id="transfer_amount" name="transfer_amount"
                 placeholder="Enter amount to transfer" required>
        </div>
        <hr>
        <button type="submit" class="btn btn-success mt-4 w-25"><strong>
          <i class="fa fa-exchange me-2"></i>
          Transfer Balance
        </strong></button>
      </form>
    </div>
  </div>

  <hr>

  <!-- Tabs for Filtering -->
  <div class="row g-4 mb-4 card card-border-shadow-primary p-8 mt-8">
    <div class="col-xl-12">
      <h5 class="text-muted"><strong>Filter Transactions</strong></h5>
      <div class="card text-center mb-4">
        <div class="card-header">
          <div class="nav-align-top">
            <ul class="nav nav-pills" role="tablist">
              <li class="nav-item" role="presentation">
                <form method="post" action="{% url 'llm_transaction:list' %}">
                  {% csrf_token %}
                  <strong class="me-4">Last</strong>
                  <label class="me-4">
                    <input type="number" name="delta_specifier" value="{{ delta_specifier }}" class="form-control"
                           id="delta_specifier"/>
                  </label>
                  <label class="me-4">
                    <select class="form-select" id="time_specifier" name="time_specifier">
                      {% for key, value in filter_types %}
                        <option value="{{ key }}"
                          {% if time_specifier %}
                            {% if key == time_specifier %}
                                selected
                            {% endif %}
                          {% else %}
                            {% if key == 'days' %}
                                selected
                            {% endif %}
                          {% endif %}>
                          {{ value }}
                        </option>
                      {% endfor %}
                    </select>
                  </label>
                  <label>
                    <button type="submit"
                            class="nav-link waves-effect waves-light {% if filter == 'specific' %}active{% endif %} me-4"
                            name="filter" value="specific"><strong>
                      <i class="fa fa-search me-2"></i>
                      Update Transactions
                    </strong>
                    </button>
                    <button type="submit" class="nav-link waves-effect waves-light

                      {% if filter %}{% if filter == 'all' %}active{% endif %}{% else %}{% if filter != 'specific' %}active{% endif %}{% endif %}"
                            name="filter" value="all"><strong>
                      <i class="fa fa-globe me-2"></i>
                      Show All Transactions
                    </strong>
                    </button>
                  </label>
                </form>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Display overall user total costs -->
  <div class="row g-4 mb-4 card card-border-shadow-primary p-8">
    <div class="col-sm-12 col-xl-12">
      <div class="card">
        <div class="card-body bg-label-success rounded">
          <div class="d-flex align-items-start justify-content-between">
            <div class="content-left">
              <div class="d-flex align-items-end">
                <h3 class="mb-0 me-2">${{ cost_sums.total_billable_cost }}</h3>
                <small class="text-primary"></small>
              </div>
              <small><strong>Total Cost</strong></small>
            </div>
            <span class="badge bg-label-primary rounded p-2">
              <i class="ti ti-arrows-transfer-down ti-sm"></i>
            </span>
          </div>
        </div>
      </div>
      <div class="tips-section alert alert-solid-info d-flex align-items-center mt-6" role="alert">
        <span class="alert-icon rounded">
          <i class="ti ti-bell"></i>
        </span>
        Total billable cost is the cost you are responsible for the services provided
        by {% get_theme_variables 'template_name' %}. This reflects
        an exact value regarding the cost associated with using {% get_theme_variables 'template_name' %}.
      </div>
    </div>
  </div>

  {% for organization_data in data %}
    <div class="row g-6 mb-6">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <p>
              <a data-bs-toggle="collapse" href="#collapse-{{ organization_data.organization.id }}" role="button"
                 aria-expanded="true" aria-controls="collapse-{{ organization_data.organization.id }}">
                <div class="d-flex">
                  <img src="
                    {% if organization_data.organization.organization_image %}{{ organization_data.organization.organization_image.url }}{% else %}{% static 'img/avatars/org-0.png' %}{% endif %}"
                       class="rounded" width="60" height="60" alt="Organization Image">
                    <h4 class="mb-0 mt-4"><strong>{{ organization_data.organization.name }}</strong></h4>
                </div>
                <small class="text-muted"><strong>{{ organization_data.organization.email }}</strong></small>
              </a>
            </p>
            <i class="fa fa-arrow-alt-circle-up toggle-icon mt-5"
               data-target="#collapse-{{ organization_data.organization.id }}"></i>
            <span data-bs-toggle="collapse" href="#collapse-{{ organization_data.organization.id }}" role="button"
                  aria-expanded="true" aria-controls="collapse-{{ organization_data.organization.id }}">
          <strong>&nbsp; See List of Transactions</strong>
        </span>
          </div>
          <div id="collapse-{{ organization_data.organization.id }}" class="card-body collapse show">
            <!-- New Balance and Top-up Form in Separate Equal Height and Width Cards -->
            <div class="row g-4 mb-4">
              <!-- Balance Card -->
              <div class="col-3">
                <div class="card h-100">
                  <div class="card-body d-flex align-items-center">
                    <div class="content-left">
                      <h5 class="mb-4"><strong>Account Balance</strong></h5>
                      <div class="d-flex align-items-end justify-content-center">
                        <h3 class="mb-0 me-2"><i class="fa fa-wallet me-4 fa-xl text-success"></i> $<span
                          id="balance-{{ organization_data.organization.id }}">{{ organization_data.organization.balance|floatformat:4 }}</span>
                        </h3>
                        <small class="text-primary"></small>
                      </div>
                    </div>
                </span>
                  </div>
                </div>
              </div>

              <!-- Top-up Form Card -->
              <div class="col-9 border border-success border-2 rounded">
                <h6 class="mt-4"><strong class="ms-6 mt-2 mb-2">
                  <i class="fa fa-plus-circle me-2"></i>
                  Add Balance to Organization
                </strong></h6>
                <div class="card">
                  <img src="{% static 'img/llm_transactions/tx-1.png' %}"
                   class="rounded w-100" alt="Illustration for tips">
                  <div class="card-header">
                    <a href="{% url 'llm_transaction:auto_top_up_create' %}">
                      <button class="btn btn-primary w-100" type="submit">
                        <i class="fa fa-refresh me-2"></i><strong>Create Automated Balance Top-Up Plan</strong>
                      </button>
                    </a>
                    <div class="tips-section alert alert-solid-info d-flex align-items-center mt-6" role="alert">
                      <span class="alert-icon rounded">
                        <i class="ti ti-bell"></i>
                      </span>
                      Create an automated balance top-up plan to ensure that your organization's balance is always
                      sufficient to cover the costs, without needing to manually top up your balance each time.
                    </div>
                  </div>
                  <hr>
                  <div class="card-body">
                    <br>

                    <div class="row">
                      <form method="post" action="{% url 'organization:add_credits' %}" class="w-100">
                        {% csrf_token %}
                        <input type="hidden" name="org_id" value="{{ organization_data.organization.id }}">
                        <label for="promo_code" class="form-label mb-2"><strong>Do you have a promo code?</strong></label>
                        <input type="text" class="form-control mb-2" name="promo_code" value="" placeholder="You have a referral or promo code?">
                        <label for="topup_amount" class="form-label mb-2"><strong>Enter amount in USD to add to the balance.</strong></label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="input-group-text pt-2 pb-2 me-2"><strong>$ (USD)</strong></span>
                          </div>
                          <input type="number" class="form-control rounded me-2" name="topup_amount" placeholder="Enter amount to add to the balance" required>
                          <button class="btn btn-success rounded" type="submit">
                            <strong><i class="fa fa-plus me-2"></i> Add Balance</strong>
                          </button>
                        </div>
                      </form>
                    </div>

                    <div class="row">
                      <!-- Separate Form for Adding Free Credits -->
                      {% if user.profile.free_credits > 0 %}
                        <form method="post" action="{% url 'organization:add_gift_credits' %}" class="mt-4">
                          {% csrf_token %}
                          <input type="hidden" name="org_id" value="{{ organization_data.organization.id }}">
                          <div class="alert alert-solid-success d-flex align-items-center mt-6" role="alert">
                            <span class="alert-icon rounded">
                              <i class="ti ti-bell"></i>
                            </span>
                            <strong>You have <span class="p-1 bg-label-primary rounded">${{ user.profile.free_credits }}</span> 'FREE' credits available. Would you want to add them to this organization?</strong>
                            <button type="submit" class="btn btn-primary ms-4">
                              <i class="fa fa-exchange me-2"></i><strong>Add Free Credits</strong>
                            </button>
                          </div>
                        </form>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-4 mb-4">
              <div class="col-sm-12 col-xl-12">
                <div class="card">
                  <div class="card-body bg-label-info rounded">
                    <div class="d-flex align-items-start justify-content-between">
                      <div class="content-left">
                        <div class="d-flex align-items-end">
                          <h3 class="mb-0 me-2">${{ organization_data.cost_sums.total_billable_cost }}</h3>
                          <small class="text-primary"></small>
                        </div>

                        <small><strong>Total Cost (Organization)</strong></small>
                      </div>
                      <span class="badge bg-label-primary rounded p-2">
                    <i class="ti ti-arrows-transfer-down ti-sm"></i>
                  </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {% for llm_data in organization_data.llm_models %}
              <div class="card mb-4">
                <div class="card-header">
                  <h4 class="mb-0">{{ llm_data.model.nickname }}</h4>
                  <small class="text-muted">{{ llm_data.model.description }}</small>
                  <br>
                  <i class="fa fa-money-bill-transfer mt-5"></i>
                  <span>
              <strong
                class="bg-label-info rounded p-1 pe-3">&nbsp; Total Cost (Total): ${{ llm_data.cost_sums.total_billable_cost }}</strong>
            </span>
                </div>
                <div id="collapse-{{ organization_data.organization.id }}" class="card-body collapse show">
                  <div class="table-responsive">
                    <table class="table datatables-transaction">
                      <thead>
                      <tr>
                        <th>Id</th>
                        <th>User</th>
                        <th>Assistant</th>
                        <th>Transaction Role Type</th>
                        <th>Transaction Source</th>
                        <th>Encoding Engine</th>
                        <th>Number of Tokens</th>
                        <th>Total Billable Cost</th>
                        <th>Created At</th>
                      </tr>
                      </thead>
                      <tbody>
                      {% for transaction in llm_data.transactions %}
                        <tr>
                          <td>{{ transaction.id }}</td>
                          <td><strong>{{ transaction.responsible_user.username }}</strong></td>
                          <td><strong>{{ transaction.responsible_assistant.name }}</strong></td>
                          <td>{{ transaction.transaction_type }}</td>
                          <td>{{ transaction.transaction_source }}</td>
                          <td>{{ transaction.encoding_engine }}</td>
                          <td><strong>{{ transaction.number_of_tokens }}</strong></td>
                          <td><strong>$ {{ transaction.total_billable_cost }}</strong></td>
                          <td>{{ transaction.created_at }}</td>
                        </tr>
                      {% endfor %}
                      <tr class="bg-light">
                        <td colspan="3"><strong>Total</strong></td>
                        <td colspan="4"></td>
                        <td><strong>$ {{ llm_data.cost_sums.total_billable_cost }}</strong></td>
                        <td colspan="1"></td>
                      </tr>
                      </tbody>
                    </table>
                    <nav aria-label="Page navigation">
                      <ul class="pagination pagination-rounded pt-8 overflow-auto pb-4 ps-4">
                        {% if llm_data.transactions.has_previous %}
                          <li class="page-item">
                            <a class="page-link" href="?page=1"><i class="ti ti-chevrons-left ti-sm"></i></a>
                          </li>
                          <li class="page-item">
                            <a class="page-link" href="?page={{ llm_data.transactions.previous_page_number }}"><i
                              class="ti ti-chevron-left ti-sm"></i></a>
                          </li>
                        {% endif %}
                        {% for page_num in llm_data.transactions.paginator.page_range %}
                          <li class="page-item {% if llm_data.transactions.number == page_num %}active{% endif %}">
                            <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                          </li>
                        {% endfor %}
                        {% if llm_data.transactions.has_next %}
                          <li class="page-item">
                            <a class="page-link" href="?page={{ llm_data.transactions.next_page_number }}"><i
                              class="ti ti-chevron-right ti-sm"></i></a>
                          </li>
                          <li class="page-item">
                            <a class="page-link" href="?page={{ llm_data.transactions.paginator.num_pages }}"><i
                              class="ti ti-chevrons-right ti-sm"></i></a>
                          </li>
                        {% endif %}
                      </ul>
                    </nav>
                  </div>
                </div>
              </div>
            {% empty %}
              <div class="alert alert-warning p-8" role="alert">
                <div class="">
                  <i class="fa fa-exclamation-triangle me-4"></i>
                  <strong>No LLM Model Configurations for this organization have been created yet.</strong>
                </div>
                <a href="{% url 'llm_core:create' %}">
                  <button class="btn btn-success mt-4"><strong>
                    <i class="fa fa-plus me-4"></i>
                    Create Model Configuration
                  </strong></button>
                </a>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  {% endfor %}

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Function to store the collapsed tab state
      function storeCollapsedTabState() {
        const collapsedTabs = [];
        document.querySelectorAll('.collapse:not(.show)').forEach(collapse => {
          collapsedTabs.push(collapse.id);
        });
        localStorage.setItem('collapsedTabs', JSON.stringify(collapsedTabs));
      }

      // Function to restore the collapsed tab state
      function restoreCollapsedTabState() {
        const collapsedTabs = JSON.parse(localStorage.getItem('collapsedTabs'));
        if (collapsedTabs && Array.isArray(collapsedTabs)) {
          collapsedTabs.forEach(tabId => {
            const collapseElement = document.getElementById(tabId);
            if (collapseElement) {
              new bootstrap.Collapse(collapseElement, {
                toggle: true
              });
            }
          });
        }
      }

      // Store the collapsed tab state on collapse and expand events
      document.querySelectorAll('.collapse').forEach(collapse => {
        collapse.addEventListener('show.bs.collapse', storeCollapsedTabState);
        collapse.addEventListener('hide.bs.collapse', storeCollapsedTabState);
      });

      // Restore the collapsed tab state on page load
      restoreCollapsedTabState();

      // Toggle icon logic
      document.querySelectorAll('.toggle-icon').forEach(function (icon) {
        icon.addEventListener('click', function () {
          var target = document.querySelector(this.getAttribute('data-target'));
          var bootstrapCollapse = new bootstrap.Collapse(target, {
            toggle: true
          });
          if (target.classList.contains('show')) {
            bootstrapCollapse.hide();
            icon.classList.remove('fa-arrow-alt-circle-up');
            icon.classList.add('fa-arrow-alt-circle-down');
          } else {
            bootstrapCollapse.show();
            icon.classList.remove('fa-arrow-alt-circle-down');
            icon.classList.add('fa-arrow-alt-circle-up');
          }
        });
      });

      // Update toggle icons based on collapse state
      document.querySelectorAll('.collapse').forEach(function (collapse) {
        collapse.addEventListener('show.bs.collapse', function () {
          var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
          if (icon) {
            icon.classList.remove('fa-arrow-alt-circle-down');
            icon.classList.add('fa-arrow-alt-circle-up');
          }
        });

        collapse.addEventListener('hide.bs.collapse', function () {
          var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
          if (icon) {
            icon.classList.remove('fa-arrow-alt-circle-up');
            icon.classList.add('fa-arrow-alt-circle-down');
          }
        });
      });
    });
  </script>

{% endblock %}
