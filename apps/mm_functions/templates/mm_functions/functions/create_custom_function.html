  <!--
  ~ Copyright (c) 2024 BMD™ Autonomous Holdings. All rights reserved.
  ~
  ~ Project: Bimod.io™
  ~ File: create_custom_function.html
  ~ Last Modified: 2024-10-05 01:39:48
  ~ Author: Ege Dogan Dursun (Co-Founder & Chief Executive Officer / CEO @ BMD™ Autonomous Holdings)
  ~ Created: 2024-10-05 14:42:40
  ~
  ~ This software is proprietary and confidential. Unauthorized copying,
  ~ distribution, modification, or use of this software, whether for
  ~ commercial, academic, or any other purpose, is strictly prohibited
  ~ without the prior express written permission of BMD™ Autonomous
  ~ Holdings.
  ~
  ~  For permission inquiries, please contact: admin@Bimod.io.
  ~
  -->

{% extends layout_path %}

{% load static %}
{% load i18n %}
{% load field_to_label %}

{% block title %}Create Custom Function{% endblock %}

{% block vendor_css %}
  {{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/flatpickr/flatpickr.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/material.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <style>
    .CodeMirror {
    transform: scale(1.43);
    transform-origin: top left;
    width: calc(100% / 1.43);
    max-height: calc((100% / 1.43));
    overflow: auto;
    border-radius: 5px;
    font-family: monospace;
    font-size: 0.70rem;
    margin-bottom: 15%;
  }
  </style>
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/cleavejs/cleave.js' %}"></script>
  <script src="{% static 'vendor/libs/cleavejs/cleave-phone.js' %}"></script>
  <script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
  <script src="{% static 'vendor/libs/flatpickr/flatpickr.js' %}"></script>
  <script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock vendor_js %}

{% block page_js %}
  {{ block.super }}
  <script src="{% static 'js/form-layouts.js' %}"></script>
{% endblock page_js %}

{% block content %}
  <!-- Basic Layout -->
  <div class="row">
    <div class="col-xl mb-6">
      <div class="card">
        <div class="card-datatable table-responsive">
          <a href="{% url 'mm_functions:list' %}">
            <button class="btn btn-secondary ms-4 mt-4 mb-8">
              <i class="fa fa-dashboard me-4"></i>
              <strong> Manage Custom Functions</strong>
            </button>
          </a>
        </div>
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <strong>Create New Custom Function</strong>
          </h5>
          <small class="text-muted float-end"></small>
        </div>
        <div class="card-body">
          <div class="tips-section alert alert-secondary alert-dismissible d-flex col-lg-12 align-items-center" role="alert">
            <img src="{% static 'img/custom-illustrations-v2/i2-79.png' %}" width="25%" style="border-radius: 25px;"
                 class="justify-content-end me-8" alt="Illustration for tip">
            <span class="alert-icon rounded">
            <i class="ti ti-bookmark"></i>
          </span>
            <div class="d-flex flex-column ps-1">
              <h5 class="alert-heading mb-2">Tip</h5>
              <p class="mb-0">
                In this page, you can create a new custom function. Fill out the form fields and click on the "Create"
                button to create the custom function. You can also share the function in the function store by checking
                the "Share in Function Store" checkbox.
              </p>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
              </button>
            </div>
          </div>
          {% if messages %}
            {% for message in messages %}
              <div
                class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-danger{% endif %}"
                role="alert">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row p-8">
              <div class="mb-6 col-4">
                <label class="form-label" for="name">Name</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="Enter function name"
                       required/>
              </div>
              <div class="mb-6 col-4">
                <label class="form-label" for="description">Description</label>
                <textarea class="form-control" id="description" name="description" rows="1"
                          placeholder="Enter function description" required></textarea>
              </div>
              <div class="mb-6 col-4">
                <label class="form-label" for="function_picture">Thumbnail Image</label>
                <input type="file" class="form-control" id="function_picture" name="function_picture"/>
              </div>
              <hr>
              <div class="mb-6 col-12">
                <label class="form-label" for="packages">Packages</label>
                <table id="packagesTable" class="table table-bordered">
                  <thead>
                  <tr>
                    <th>Package Name</th>
                    <th>Version</th>
                    <th></th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr>
                    <td><input type="text" name="packages[][name]" placeholder="Enter package name"
                               class="form-control">
                    </td>
                    <td><input type="text" name="packages[][version]" placeholder="(Leave empty if not relevant)"
                               class="form-control"></td>
                    <td>
                      <button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i
                        class="fa fa-remove"></i></button>
                    </td>
                  </tr>
                  </tbody>
                </table>
                <button type="button" onclick="addRow('packagesTable')" class="btn btn-secondary d-grid w-20 mt-4">
                  <strong>Add New Row</strong></button>
              </div>
              <div class="mb-6 col-12">
                <label class="form-label" for="requirements_txt">Upload Requirements File (requirements.txt)</label>
                <input type="file" class="form-control" id="requirements_txt" name="requirements_txt" accept=".txt"
                       onchange="parseRequirementsFile(this)"/>
              </div>
              <hr>
              <div class="mb-6 col-12">
                <label class="form-label" for="input_fields">Input Fields</label>
                <table id="inputFieldsTable" class="table table-bordered">
                  <thead>
                  <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Type</th>
                    <th>Required</th>
                    <th></th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr>
                    <td><input type="text" name="input_fields[][name]" placeholder="Enter field name"
                               class="form-control"></td>
                    <td><input type="text" name="input_fields[][description]" placeholder="Enter description"
                               class="form-control"></td>
                    <td>
                      <select name="input_fields[][type]" class="form-select">
                        <option value="str">String</option>
                        <option value="int">Integer</option>
                        <option value="float">Float</option>
                        <option value="bool">Boolean</option>
                        <option value="tuple">Tuple</option>
                        <option value="list">List</option>
                        <option value="dict">Dictionary</option>
                      </select>
                    </td>
                    <td><input type="checkbox" name="input_fields[][required]" class="form-check-input"></td>
                    <td>
                      <button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i
                        class="fa fa-remove"></i></button>
                    </td>
                  </tr>
                  </tbody>
                </table>
                <button type="button" onclick="addRow('inputFieldsTable')" class="btn btn-secondary d-grid w-20 mt-4">
                  <strong>Add New Row</strong></button>
              </div>
              <div class="mb-6 col-12">
                <label class="form-label" for="output_fields">Output Fields</label>
                <table id="outputFieldsTable" class="table table-bordered">
                  <thead>
                  <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Type</th>
                    <th></th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr>
                    <td><input type="text" name="output_fields[][name]" placeholder="Enter field name"
                               class="form-control"></td>
                    <td><input type="text" name="output_fields[][description]" placeholder="Enter description"
                               class="form-control"></td>
                    <td>
                      <select name="output_fields[][type]" class="form-select">
                        <option value="str">String</option>
                        <option value="int">Integer</option>
                        <option value="float">Float</option>
                        <option value="bool">Boolean</option>
                        <option value="tuple">Tuple</option>
                        <option value="list">List</option>
                        <option value="dict">Dictionary</option>
                      </select>
                    </td>
                    <td>
                      <button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i
                        class="fa fa-remove"></i></button>
                    </td>
                  </tr>
                  </tbody>
                </table>
                <button type="button" onclick="addRow('outputFieldsTable')" class="btn btn-secondary d-grid w-20 mt-4">
                  <strong>Add New Row</strong></button>
              </div>
              <hr>
              <div class="mb-6 col-12">
                <label class="form-label" for="secrets">Secrets</label>
                <table id="secretsTable" class="table table-bordered">
                  <thead>
                  <tr>
                    <th>Name</th>
                    <th>Key</th>
                    <th></th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr>
                    <td><input type="text" name="secrets[][name]" placeholder="Enter secret name" class="form-control">
                    </td>
                    <td><input type="password" name="secrets[][key]" placeholder="Enter secret value"
                               class="form-control"></td>
                    <td>
                      <button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i
                        class="fa fa-remove"></i></button>
                    </td>
                  </tr>
                  </tbody>
                </table>
                <button type="button" onclick="addRow('secretsTable')" class="btn btn-secondary d-grid w-20 mt-4">
                  <strong>Add
                    New Row</strong></button>
              </div>
              <div class="mb-6 col-12">
                <label class="form-label" for="env_file">Upload Environment / Secrets File (.json)</label>
                <input type="file" class="form-control" id="env_file" name="env_file" accept="env"
                       onchange="parseSecretsFile(this)"/>
              </div>
              <hr>
              <div class="mb-6 col-12 rounded">
                <label class="form-label" for="code_text">Code</label>
                <textarea class="form-control" id="code_text" name="code_text"
                          placeholder="Enter the code for the function"></textarea>
              </div>
              <div class="mb-6 col-12">
                <label class="form-label" for="code_file">Upload Code File (.py)</label>
                <input type="file" class="form-control" id="code_file" name="code_file" accept=".py"
                       onchange="parseCodeFile(this)"/>
              </div>
              <div class="mb-6 col-8">
                <label class="form-label" for="categories">Categories</label>
                <div id="categories" class="form-control overflow-auto" style="max-height: 200px;">
                  {% for value, label in CUSTOM_FUNCTION_CATEGORIES %}
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input category-checkbox" name="categories"
                             value="{{ value }}" id="category-{{ value }}">
                      <label class="form-check-label" for="category-{{ value }}">{{ label }}</label>
                    </div>
                  {% endfor %}
                </div>
                <small id="categoryLimitAlert" class="text-danger" style="display: none;">You can select up to 5
                  categories.</small>
              </div>
              <div class="mb-6 col-4 form-check bg-label-primary p-4 rounded border border-1 border-primary mt-6">
                <input type="checkbox" class="form-check-input ms-4 mt-2" id="is_public" name="is_public">
                <label class="form-check-label ms-4 mt-4" for="is_public">
                  <strong>Share in Function Store</strong>
                  <br>
                  <small>
                    <i class="fa fa-info-circle me-2 mt-4"></i> For your contribution to the community, if you choose to
                    share your function in the public store, there will be a 50% discount on your requests for this
                    function.
                  </small>
                </label>
              </div>
            </div>
            <hr>
            <input type="hidden" name="created_by_user" value="{{ request.user.id }}">
            <button type="submit" class="btn btn-primary d-grid mt-4 w-25"><strong>
              <i class="fa fa-plus me-4"></i>
              Create Custom Function</strong></button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    function addRow(tableId) {
      const tableBody = document.querySelector(`#${tableId} tbody`);
      let newRow;
      if (tableId === 'packagesTable') {
        newRow = `
        <tr>
          <td><input type="text" name="packages[][name]" placeholder="Enter package name" class="form-control"></td>
          <td><input type="text" name="packages[][version]" placeholder="Enter version" class="form-control"></td>
          <td><button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i class="fa fa-remove"></i></button></td>
        </tr>
      `;
      } else if (tableId === 'inputFieldsTable') {
        newRow = `
        <tr>
          <td><input type="text" name="input_fields[][name]" placeholder="Enter field name" class="form-control"></td>
          <td><input type="text" name="input_fields[][description]" placeholder="Enter description" class="form-control"></td>
          <td>
            <select name="input_fields[][type]" class="form-select">
              <option value="str">String</option>
              <option value="int">Integer</option>
              <option value="float">Float</option>
              <option value="bool">Boolean</option>
              <option value="tuple">Tuple</option>
              <option value="list">List</option>
              <option value="dict">Dictionary</option>
            </select>
          </td>
          <td><input type="checkbox" name="input_fields[][required]" class="form-check-input"></td>
          <td><button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i class="fa fa-remove"></i></button></td>
        </tr>
      `;
      } else if (tableId === 'outputFieldsTable') {
        newRow = `
        <tr>
          <td><input type="text" name="output_fields[][name]" placeholder="Enter field name" class="form-control"></td>
          <td><input type="text" name="output_fields[][description]" placeholder="Enter description" class="form-control"></td>
          <td>
            <select name="output_fields[][type]" class="form-select">
              <option value="str">String</option>
              <option value="int">Integer</option>
              <option value="float">Float</option>
              <option value="bool">Boolean</option>
              <option value="tuple">Tuple</option>
              <option value="list">List</option>
              <option value="dict">Dictionary</option>
            </select>
          </td>
          <td><button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i class="fa fa-remove"></i></button></td>
        </tr>
      `;
      } else if (tableId === 'secretsTable') {
        newRow = `
        <tr>
          <td><input type="text" name="secrets[][name]" placeholder="Enter secret name" class="form-control"></td>
          <td><input type="text" name="secrets[][key]" placeholder="Enter secret value" class="form-control"></td>
          <td><button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i class="fa fa-remove"></i></button></td>
        </tr>
      `;
      }
      tableBody.insertAdjacentHTML('beforeend', newRow);
    }

    function removeRow(button) {
      const row = button.closest('tr');
      row.remove();
    }

    function parseRequirementsFile(input) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target.result;
          const packages = content.split('\n').map(line => {
            const [name, version] = line.split('==');
            return {name, version: version || ''};
          }).filter(pkg => pkg.name);

          const tableBody = document.querySelector('#packagesTable tbody');
          tableBody.innerHTML = '';
          packages.forEach(pkg => {
            const newRow = `
            <tr>
              <td><input type="text" name="packages[][name]" value="${pkg.name}" class="form-control"></td>
              <td><input type="text" name="packages[][version]" value="${pkg.version}" class="form-control"></td>
              <td><button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i class="fa fa-remove"></i></button></td>
            </tr>
          `;
            tableBody.insertAdjacentHTML('beforeend', newRow);
          });
        };
        reader.readAsText(file);
      }
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var codeTextArea = document.getElementById('code_text');

      if (codeTextArea) {
        var editor = CodeMirror.fromTextArea(codeTextArea, {
          mode: "python",
          theme: "material",
          lineNumbers: true,
          matchBrackets: true,
          autoRefresh: true,
        });

        // Ensure the original textarea is updated on form submission
        document.querySelector('form').addEventListener('submit', function () {
          codeTextArea.value = editor.getValue();
        });

        // Function to handle the file upload and set the content in CodeMirror
        function parseCodeFile(input) {
          const file = input.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const content = e.target.result;
              editor.setValue(content);  // Update CodeMirror content
            };
            reader.readAsText(file);
          }
        }

        // Attach event listener to file input
        document.getElementById('code_file').addEventListener('change', function () {
          parseCodeFile(this);
        });
      } else {
        console.error('Code textarea not found');
      }

      function parseSecretsFile(input) {
        const file = input.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const content = e.target.result;
            const secrets = JSON.parse(content);

            const tableBody = document.querySelector('#secretsTable tbody');
            tableBody.innerHTML = ''; // Clear existing rows

            Object.keys(secrets).forEach(key => {
              const newRow = `
            <tr>
              <td><input type="text" name="secrets[][name]" value="${key}" class="form-control"></td>
              <td><input type="password" name="secrets[][key]" value="${secrets[key]}" class="form-control"></td>
              <td><button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i class="fa fa-remove"></i></button></td>
            </tr>
          `;
              tableBody.insertAdjacentHTML('beforeend', newRow);
            });
          };
          reader.readAsText(file);
        }
      }

      // Attach event listener to .env file input
      document.getElementById('env_file').addEventListener('change', function () {
        parseSecretsFile(this);
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
      const maxCategories = 5;
      const categoryLimitAlert = document.getElementById('categoryLimitAlert');

      categoryCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function () {
          const checkedCheckboxes = document.querySelectorAll('.category-checkbox:checked');
          if (checkedCheckboxes.length > maxCategories) {
            this.checked = false;
            categoryLimitAlert.style.display = 'block';
          } else {
            categoryLimitAlert.style.display = 'none';
          }
        });
      });
    });
  </script>

{% endblock %}
