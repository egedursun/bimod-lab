  <!--
  ~ Copyright (c) 2024 BMD™ Autonomous Holdings. All rights reserved.
  ~
  ~ Project: Jupi.tr™
  ~ File: list_message_templates.html
  ~ Last Modified: 2024-10-01 23:45:03
  ~ Author: Ege Dogan Dursun (Co-Founder & Chief Executive Officer / CEO @ BMD™ Autonomous Holdings)
  ~ Created: 2024-10-05 01:36:42
  ~
  ~ This software is proprietary and confidential. Unauthorized copying,
  ~ distribution, modification, or use of this software, whether for
  ~ commercial, academic, or any other purpose, is strictly prohibited
  ~ without the prior express written permission of BMD™ Autonomous
  ~ Holdings.
  ~
  ~  For permission inquiries, please contact: admin@jupi.tr.
  ~
  -->

{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Message Templates{% endblock %}

{% block page_css %}
  {{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/css/pages/page-profile.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/sweetalert2/sweetalert2.css' %}"/>
{% endblock page_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/sweetalert2/sweetalert2.js' %}"></script>
{% endblock vendor_js %}

{% block content %}
  <div class="row g-6 mb-6">
    <div class="col-sm-6 col-xl-4 label4">
      <h3 class="mb-0">
        <strong>Message Templates</strong>
      </h3>
    </div>
  </div>

  <div class="tips-section alert alert-secondary alert-dismissible d-flex col-lg-12 align-items-center" role="alert">
    <img src="{% static 'img/custom-illustrations-v2/i2-13.png' %}" width="25%" style="border-radius: 25px;"
         class="justify-content-end me-8" alt="Illustration for tip">
    <span class="alert-icon rounded ms-4">
    <i class="ti ti-bookmark"></i>
  </span>
    <div class="d-flex flex-column ps-1">
      <h5 class="alert-heading mb-2">Tip</h5>
      <p class="mb-0">
        In this page, you can view all the message templates of the organizations you have created. You can also
        update or delete any message template that belongs to you as an administrator. To create a new message
        template, click on the "Add Message Template" button, which is located in the tab on the left side of your
        screen. The message templates are user for quick references that you can use in your chats with the
        assistants.
      </p>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
      </button>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div
        class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-danger{% endif %}"
        role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <hr>

  <div class="card-datatable table-responsive mt-4">
    <a href="{% url 'message_templates:create' %}">
      <button class="btn btn-success mt-4 w-25">
        <i class="fa fa-add me-4"></i>
        <strong> Add Message Template</strong>
      </button>
    </a>
  </div>

  <!-- Message Templates Cards -->
  <div class="row g-6 mt-4">
    {% for message_template in message_templates %}
      <div class="col-xl-6 col-lg-6 col-md-6 mb-6 d-flex">
        <div class="card w-100">
          <div class="card-header pb-4">
            <div class="d-flex align-items-start">
              <div class="d-flex align-items-center">
                <div class="me-4">
                  <img src="{{ message_template.user.profile.profile_picture.url }}" alt="Avatar" class="rounded"
                       width="80px;"/>
                </div>
                <div class="me-2">
                  <p class="ms-2 mb-0"><strong>
                    <i class="fa fa-user me-2"></i>
                    {{ message_template.user.username }}
                  </strong></p>
                  <div class="label border border-info rounded mt-4 p-2">
                    <div class="client-info text-body"><strong><span
                      class="fw-medium"></span><span>
                      <i class="fa fa-building me-2"></i>
                      {{ message_template.organization.name }}
                    </span></strong></div>
                  </div>
                </div>
              </div>
              <div class="ms-auto">
                <div class="dropdown z-2">
                  <button type="button"
                          class="btn btn-icon btn-text-secondary rounded-pill dropdown-toggle hide-arrow p-0"
                          data-bs-toggle="dropdown" aria-expanded="false"><i
                    class="ti ti-dots-vertical ti-md text-muted"></i></button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item text-primary"
                           href="{% url 'message_templates:update' message_template.id %}"><strong>Update
                      Template</strong></a></li>
                    <li><a class="dropdown-item text-danger"
                           href="{% url 'message_templates:delete' message_template.id %}"><strong>Delete</strong></a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="card card-border-primary p-4 mt-4 mb-4">
              <p class="card-text truncated-text" id="truncated-{{ message_template.id }}">
                {{ message_template.template_text|linebreaksbr|safe|slice:":400" }}
                {% if message_template.template_text|length > 200 %}...{% endif %}</p>
              <div id="full-text-{{ message_template.id }}" class="collapse">
                <hr>
                <p class="text-primary mb-2"><strong>Full Text</strong></p>
                <p class="card-text markdown-content">{{ message_template.template_text|linebreaksbr|safe }}</p>
              </div>
              <hr>
              <strong><small>
                <a href="javascript:void(0);" class="expand-btn me-12" data-bs-toggle="collapse"
                   data-bs-target="#full-text-{{ message_template.id }}" aria-expanded="false"
                   aria-controls="full-text-{{ message_template.id }}">
                  <i class="fa fa-expand"></i><span class="ms-2">Expand / Collapse</span>
                </a>
                <a href="javascript:void(0);" class="copy-btn ms-12" data-template-id="{{ message_template.id }}">
                  <i class="fa fa-copy"></i><span class="ms-2">Copy to Clipboard</span>
                </a>
              </small></strong>
            </div>
            <small class="mt-8"><strong>
              <i class="fa fa-calendar me-2"></i>
              Created At: &nbsp;
            </strong> {{ message_template.created_at|date:"d M Y, H:i" }}
            </small>
            <div class="alert-container"></div>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="alert alert-warning ms-8 me-8" role="alert" style="max-width: 90%">
        <i class="fa fa-exclamation-triangle me-4"></i>
        <strong>No message templates found for your organizations.</strong>
      </div>
    {% endfor %}
  </div>
  <!--/ Message Templates Cards -->

  <!-- Include a markdown library, for example, Showdown.js -->
  <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const converter = new showdown.Converter();
      document.querySelectorAll('.markdown-content').forEach(function (element) {
        element.innerHTML = converter.makeHtml(element.innerHTML);
      });

      document.querySelectorAll('.expand-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const target = document.querySelector(this.getAttribute('data-bs-target'));
          const truncatedText = document.getElementById(`truncated-${this.getAttribute('data-bs-target').split('-')[2]}`);

          target.addEventListener('shown.bs.collapse', function () {
            truncatedText.style.display = '';
          });

          target.addEventListener('hidden.bs.collapse', function () {
            truncatedText.style.display = 'block';
          });
        });
      });

      document.querySelectorAll('.copy-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const templateId = this.getAttribute('data-template-id');
          const templateTextElement = document.getElementById(`full-text-${templateId}`);
          const textToCopy = templateTextElement ? templateTextElement.innerText : '';

          navigator.clipboard.writeText(textToCopy).then(() => {
            const alertContainer = this.closest('.card-body').querySelector('.alert-container');
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-solid-success d-flex align-items-center mt-4';
            successAlert.role = 'alert';
            successAlert.innerHTML = `
          <span class="alert-icon rounded">
            <i class="ti ti-check"></i>
          </span>
          Text copied to clipboard!
        `;
            alertContainer.appendChild(successAlert);

            setTimeout(() => {
              successAlert.remove();
            }, 1000);
          }).catch(err => {
            alert('Failed to copy text: ' + err);
          });
        });
      });

      document.querySelectorAll('.text-danger').forEach(function (button) {
        button.addEventListener('click', function (event) {
          event.preventDefault();
          const form = button.closest('a').getAttribute('href');

          Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this action.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            customClass: {
              confirmButton: 'btn btn-danger me-2 waves-effect waves-light',
              cancelButton: 'btn btn-label-secondary waves-effect waves-light'
            },
            buttonsStyling: false
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = form;
            }
          });
        });
      });
    });
  </script>

{% endblock %}
