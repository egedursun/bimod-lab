{% extends layout_path %}

{% load static %}
{% load i18n %}
{% load field_to_label %}

{% block title %}Create Assistant{% endblock %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/flatpickr/flatpickr.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/cleavejs/cleave.js' %}"></script>
<script src="{% static 'vendor/libs/cleavejs/cleave-phone.js' %}"></script>
<script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
<script src="{% static 'vendor/libs/flatpickr/flatpickr.js' %}"></script>
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
{{ block.super }}
<script src="{% static 'js/form-layouts.js' %}"></script>
{% endblock page_js %}

{% block content %}
<!-- Basic Layout -->
<div class="row">
  <div class="col-xl mb-6">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Create a New Assistant</h5> <small class="text-muted float-end"></small>
      </div>
      <div class="card-body">
        <div class="alert alert-secondary alert-dismissible d-flex col-lg-10 align-items-center" role="alert">
        <img src="{% static 'img/custom-illustrations/boy-red-1.png' %}" width="25%" class="justify-content-end">
        <span class="alert-icon rounded">
          <i class="ti ti-bookmark"></i>
        </span>
        <div class="d-flex flex-column ps-1">
          <h5 class="alert-heading mb-2">Tip</h5>
          <p class="mb-0">
            In this page, you can create a new assistant. You can select an organization and an LLM model from the dropdowns
            and then provide a name, description, instructions, audience, tone, and an image for the assistant. Once you have
            filled out all the fields, click on the "Create" button to create the assistant.
          </p>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
          </button>
        </div>
      </div>
        {% if messages %}
          {% for message in messages %}
            <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-danger{% endif %}" role="alert">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-6">
            <label class="form-label" for="organization">Organization</label>
            <select class="form-select" id="organization" name="organization">
              <option value="" disabled selected>Select Organization</option>
              {% for organization in organizations %}
                <option value="{{ organization.id }}" data-llm-models="{{ organization.llm_models|join:',' }}">{{ organization.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-6">
            <label class="form-label" for="llm_model">LLM Model</label>
            <select class="form-select" id="llm_model" name="llm_model">
              <option value="" disabled selected>Select LLM Model</option>
              {% for llm_model in llm_models %}
                <option value="{{ llm_model.id }}" class="llm-model-option" data-org-id="{{ llm_model.organization.id }}">{{ llm_model.nickname }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-6">
            <label class="form-label" for="name">Name</label>
            <input type="text" class="form-control" id="name" name="name" placeholder="Enter assistant name" />
          </div>
          <div class="mb-6">
            <label class="form-label" for="description">Description</label>
            <textarea class="form-control" id="description" name="description" placeholder="Enter assistant description"></textarea>
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
            This description will not be used to communicate or train the assistant. It is for human-readers to understand the assistant's purpose.
          </div>
          <div class="mb-6">
            <label class="form-label" for="instructions">Instructions</label>
            <textarea class="form-control" id="instructions" name="instructions" placeholder="Enter instructions"></textarea>
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
            These instructions will be used to train the assistant. For example, "This assistant is designed to help students with their homework."
          </div>
          <div class="mb-6">
            <label class="form-label" for="response_template">Response Template</label>
            <textarea class="form-control" id="response_template" name="response_template" placeholder="Enter response template"></textarea>
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
            This response template will be used to generate responses for the assistant. If you don't have a solid
            response template for the assistant, you can leave this field empty. You can also put a sample response
            in this field to make it more clear for the assistant to understand how it should respond to the user.
          </div>
          <div class="mb-6">
            <label class="form-label" for="audience">Audience</label>
            <input type="text" class="form-control" id="audience" name="audience" placeholder="Enter audience" />
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
            Describe the audience for this assistant. For example, "This assistant is designed for students in the 9th grade."
          </div>
          <div class="mb-6 col-lg-6">
            <label class="form-label" for="max_retry_count">Maximum Response Retry Count</label>
            <!-- slider bar here -->
            <input type="range" class="form-range" id="max_retry_count" name="max_retry_count" min="0" max="10" step="1" value="3" oninput="this.nextElementSibling.value = this.value">
            <output>3</output>
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
            The maximum number of times the assistant will retry generating a response if it fails to generate a
            response the first time. Please be aware that setting this value too high may cause the assistant to
            spend too much time and credits to generate a response.
          </div>
          <div class="mb-6">
            <label class="form-label" for="tone">Tone</label>
            <input type="text" class="form-control" id="tone" name="tone" placeholder="Enter tone" />
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
            Describe the tone for this assistant. For example, "This assistant intends to be friendly and helpful, in a casual tone."
          </div>
          <div class="mb-6">
            <label class="form-label" for="response_language">Response Language</label>
            <select class="form-select" id="response_language" name="response_language">
              <option value="">Select Response Language</option>
              {% for language in response_languages %}
                <option value="{{ language.0 }}" {% if language.0 == "auto" %}selected{% endif %}>{{ language.1 }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
              <span class="alert-icon rounded">
                <i class="ti ti-info-circle"></i>
              </span>
              Select the language in which the assistant will respond to the user. If you select "auto", the
              assistant will automatically detect the language of the user's input and respond in the same language.
          </div>
          <div class="mb-6">
            <label class="form-label" for="time_awareness">Time &amp; Location Awareness (Recommended)</label>
            <br>
            <label class="switch switch-square switch-lg mt-2">
              <input type="checkbox" class="switch-input" id="awarenessCheckbox" checked>
              <span class="switch-toggle-slider">
                <!-- Hidden fields for time_awareness and place_awareness -->
                <input type="hidden" name="time_awareness" id="timeAwareness" value="on">
                <input type="hidden" name="place_awareness" id="placeAwareness" value="on">
                <span class="switch-on"><i class="ti ti-check"></i></span>
                <span class="switch-off"><i class="ti ti-x"></i></span>
              </span>
            </label>
          </div>
          <div class="mb-6">
            <label class="form-label" for="assistant_image">Assistant Image</label>
            <input type="file" class="form-control" id="assistant_image" name="assistant_image" />
          </div>
          <button type="submit" class="btn btn-primary d-grid w-100">Create Assistant</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'js/form-layouts.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const organizationSelect = document.getElementById('organization');
    const llmModelSelect = document.getElementById('llm_model');
    const llmModelOptions = Array.from(llmModelSelect.options);

    organizationSelect.addEventListener('change', function () {
      const selectedOrgId = this.value;

      // Clear current options
      llmModelSelect.innerHTML = '<option value="" disabled selected>Select LLM Model</option>';

      // Filter and add options based on selected organization
      llmModelOptions.forEach(option => {
        if (option.dataset.orgId === selectedOrgId) {
          llmModelSelect.appendChild(option);
        }
      });

      // Enable the LLM model select box
      llmModelSelect.disabled = false;
    });
  });
</script>


<script>
  document.addEventListener('DOMContentLoaded', function() {
    const checkbox = document.getElementById('awarenessCheckbox');
    const timeAwarenessField = document.getElementById('timeAwareness');
    const placeAwarenessField = document.getElementById('placeAwareness');

    checkbox.addEventListener('change', function() {
      if (checkbox.checked) {
        timeAwarenessField.value = 'on';
        placeAwarenessField.value = 'on';
      } else {
        timeAwarenessField.value = 'off';
        placeAwarenessField.value = 'off';
      }
    });
  });
</script>

{% endblock %}
