  <!--
  ~ Copyright (c) 2024 BMD™ Autonomous Holdings. All rights reserved.
  ~
  ~ Project: Bimod.io™
  ~ File: create_assistant.html
  ~ Last Modified: 2024-10-05 01:39:47
  ~ Author: Ege Dogan Dursun (Co-Founder & Chief Executive Officer / CEO @ BMD™ Autonomous Holdings)
  ~ Created: 2024-10-05 14:42:38
  ~
  ~ This software is proprietary and confidential. Unauthorized copying,
  ~ distribution, modification, or use of this software, whether for
  ~ commercial, academic, or any other purpose, is strictly prohibited
  ~ without the prior express written permission of BMD™ Autonomous
  ~ Holdings.
  ~
  ~  For permission inquiries, please contact: admin@Bimod.io.
  ~
  -->

{% extends layout_path %}

{% load static %}
{% load i18n %}
{% load field_to_label %}

{% block title %}Create Assistant{% endblock %}

{% block vendor_css %}
  {{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/flatpickr/flatpickr.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}"/>
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/cleavejs/cleave.js' %}"></script>
  <script src="{% static 'vendor/libs/cleavejs/cleave-phone.js' %}"></script>
  <script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
  <script src="{% static 'vendor/libs/flatpickr/flatpickr.js' %}"></script>
  <script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
  {{ block.super }}
  <script src="{% static 'js/form-layouts.js' %}"></script>
  <script>
    $(document).ready(function () {
      $('#project_items').select2({
        placeholder: 'Select Team Members',
        allowClear: true,
        width: '100%'
      });
    });
  </script>
  {% endblock page_js %}

  {% block content %}
  <!-- Basic Layout -->
  <div class="row">
    <div class="col-xl mb-6">
      <div class="card">
        <div class="card-datatable table-responsive">
          <a href="{% url 'assistants:list' %}">
            <button class="btn btn-secondary ms-4 mt-4 mb-8">
              <i class="fa fa-dashboard me-4"></i>
              <strong> Manage Assistants</strong>
            </button>
          </a>
        </div>
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><strong>Create New Assistant</strong></h5> <small class="text-muted float-end"></small>
        </div>
        <div class="card-body">
          <div class="tips-section alert alert-secondary alert-dismissible d-flex col-lg-12 align-items-center"
               role="alert">
            <img src="{% static 'img/custom-illustrations-v2/i2-40.png' %}" width="25%" style="border-radius:25px;"
                 class="justify-content-end me-8" alt="Illustration for tip">
            <span class="alert-icon rounded">
              <i class="ti ti-bookmark"></i>
            </span>
            <div class="d-flex flex-column ps-1">
              <h5 class="alert-heading mb-2">Tip</h5>
              <p class="mb-0">
                In this page, you can create a new assistant. You can select an organization and an LLM model from the
                dropdowns
                and then provide a name, description, instructions, audience, tone, and an image for the assistant. Once
                you have
                filled out all the fields, click on the "Create" button to create the assistant.
              </p>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
              </button>
            </div>
          </div>
          {% if messages %}
            {% for message in messages %}
              <div
                class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-danger{% endif %}"
                role="alert">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
          <hr>
          <form method="post" enctype="multipart/form-data" class="mt-4">
            {% csrf_token %}
            <div class="row p-8">
              <div class="col-3 mb-6">
                <label class="form-label" for="organization">Organization</label>
                <select class="form-select" id="organization" name="organization">
                  <option value="" disabled selected>Select Organization</option>
                  {% for organization in organizations %}
                    <option value="{{ organization.id }}"
                            data-llm-models="{{ organization.llm_models|join:',' }}">{{ organization.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-3 mb-6">
                <label class="form-label" for="llm_model">LLM Model</label>
                <select class="form-select" id="llm_model" name="llm_model">
                  <option value="" disabled selected>Select LLM Model</option>
                  {% for llm_model in llm_models %}
                    <option value="{{ llm_model.id }}" class="llm-model-option"
                            data-org-id="{{ llm_model.organization.id }}">{{ llm_model.nickname }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-3 mb-6">
                <label class="form-label" for="ner_integration">Named Entity Recognition (NER)</label>
                <select class="form-select" id="ner_integration" name="ner_integration">
                  <option value="" selected>No NER Policy</option>
                  {% for ner_policy in ner_integrations %}
                    <option value="{{ ner_policy.id }}" class="ner-policy-option"
                            data-org-id="{{ ner_policy.organization.id }}">{{ ner_policy.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-3 mb-6">
                <label class="form-label" for="name">Name</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="Enter assistant name"/>
              </div>
              <div class="col-4 mb-6">
                <label class="form-label" for="description">Description</label>
                <textarea class="form-control" id="description" name="description"
                          placeholder="Enter assistant description" rows="2"></textarea>
              </div>
              <div class="col-4 mb-6">
                <label class="form-label" for="instructions">Instructions</label>
                <textarea class="form-control" id="instructions" name="instructions"
                          placeholder="Enter instructions"></textarea>
              </div>
              <div class="col-4 mb-6">
                <label class="form-label" for="response_template">Response Template</label>
                <textarea class="form-control" id="response_template" name="response_template" rows="2"
                          placeholder="Enter response template"></textarea>
              </div>
              <div class="col-3 mb-6">
                <label class="form-label" for="audience">Audience</label>
                <input type="text" class="form-control" id="audience" name="audience" placeholder="Enter audience"/>
              </div>
              <div class="col-3 mb-6">
                <label class="form-label" for="tone">Tone</label>
                <input type="text" class="form-control" id="tone" name="tone" placeholder="Enter tone"/>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="time_awareness">Time &amp; Location Awareness</label>
                <br>
                <label class="switch switch-square switch-lg mt-2">
                  <input type="checkbox" class="switch-input" id="awarenessCheckbox" checked>
                  <span class="switch-toggle-slider">
                    <!-- Hidden fields for time_awareness and place_awareness -->
                    <input type="hidden" name="time_awareness" id="timeAwareness" value="on">
                    <input type="hidden" name="place_awareness" id="placeAwareness" value="on">
                    <span class="switch-on"><i class="ti ti-check"></i></span>
                    <span class="switch-off"><i class="ti ti-x"></i></span>
                  </span>
                </label>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="image_generation_capability">Image Generation &amp; Manipulation</label>
                <br>
                <label class="switch switch-square switch-lg mt-2">
                  <input type="checkbox" class="switch-input" id="imageGenerationCapabilityCheckbox" checked>
                  <span class="switch-toggle-slider">
                    <input type="hidden" name="image_generation_capability" id="image_generation_capability" value="on">
                    <span class="switch-on"><i class="ti ti-check"></i></span>
                    <span class="switch-off"><i class="ti ti-x"></i></span>
                  </span>
                </label>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="max_retry_count">Max Retries</label>
                <!-- slider bar here -->
                <input type="range" class="form-range" id="max_retry_count" name="max_retry_count" min="0" max="10"
                       step="1" value="3" oninput="this.nextElementSibling.value = this.value">
                <output>3</output>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="tool_max_attempts_per_instance">Max Tool Retries</label>
                <!-- slider bar here -->
                <input type="range" class="form-range" id="tool_max_attempts_per_instance"
                       name="tool_max_attempts_per_instance" min="0" max="10" step="1" value="3"
                       oninput="this.nextElementSibling.value = this.value">
                <output>3</output>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="tool_max_chains">Max Pipelines</label>
                <!-- slider bar here -->
                <input type="range" class="form-range" id="tool_max_chains" name="tool_max_chains" min="0" max="20"
                       step="1" value="3" oninput="this.nextElementSibling.value = this.value">
                <output>3</output>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="max_context_messages">Max Message Memory</label>
                <!-- slider bar here -->
                <input type="range" class="form-range" id="max_context_messages" name="max_context_messages" min="10"
                       max="100" step=1" value="50" oninput="this.nextElementSibling.value = this.value">
                <output>50</output>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="response_language">Response Language</label>
                <select class="form-select" id="response_language" name="response_language">
                  <option value="">Select Response Language</option>
                  {% for language in response_languages %}
                    <option value="{{ language.0 }}"
                            {% if language.0 == "auto" %}selected{% endif %}>{{ language.1 }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="assistant_image">Assistant Image</label>
                <input type="file" class="form-control" id="assistant_image" name="assistant_image"/>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="context_overflow_strategy">Context Overflow Management Strategy</label>
                <select class="form-select" id="context_overflow_strategy" name="context_overflow_strategy">
                  {% for strategy in context_overflow_strategies %}
                    <option value="{{ strategy.0 }}" {% if forloop.first %}selected{% endif %}>{{ strategy.1 }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="multi_step_reasoning_capability_choice">Multi-Step Reasoning <span class="text-warning"><strong>(† higher costs)</strong></span></label>
                <select class="form-select" id="multi_step_reasoning_capability_choice" name="multi_step_reasoning_capability_choice">
                  {% for choice in reasoning_capability_choices %}
                    <option value="{{ choice.0 }}" {% if forloop.first %}selected{% endif %}>{{ choice.1 }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-6 col-12">
                <label class="form-label" for="glossary">Glossary</label>
                <table id="keyValueTable" class="table table-bordered">
                  <thead>
                  <tr>
                    <th>Term</th>
                    <th>Definition</th>
                    <th></th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr>
                    <td style="width:47%;"><input type="text" name="terms[]" placeholder="Enter term"
                                                  class="form-control"></td>
                    <td style="width:47%;"><input type="text" name="definitions[]"
                                                  placeholder="Enter definition for the term" class="form-control"></td>
                    <td>
                      <button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i
                        class="fa fa-remove"></i></button>
                    </td>
                  </tr>
                  </tbody>
                </table>
                <button type="button" onclick="addRow()" class="btn btn-success d-grid w-20 mt-4"><strong>
                  <i class="fa fa-plus me-2"></i>
                  Add New Row</strong></button>
              </div>
              <div class="mb-6 col-6">
                <label class="form-label" for="csv_file">Import Glossary from CSV</label>
                <input type="file" class="form-control" id="csv_file" accept=".csv"/>
              </div>
              <div class="mb-6 col-6">
                <label class="form-label" for="project_items">Related Projects</label>
                <select class="form-select select2" id="project_items" name="project_items[]" multiple>
                  {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.project_name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <hr>
            <button type="submit" class="btn btn-primary mt-8 d-grid w-25"><strong>
              <i class="fa fa-plus me-2"></i>
              Create Assistant
            </strong></button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="{% static 'js/form-layouts.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const organizationSelect = document.getElementById('organization');
      const llmModelSelect = document.getElementById('llm_model');
      const llmModelOptions = Array.from(llmModelSelect.options);

      organizationSelect.addEventListener('change', function () {
        const selectedOrgId = this.value;

        // Clear current options
        llmModelSelect.innerHTML = '<option value="" disabled selected>Select LLM Model</option>';

        // Filter and add options based on selected organization
        llmModelOptions.forEach(option => {
          if (option.dataset.orgId === selectedOrgId) {
            llmModelSelect.appendChild(option);
          }
        });

        // Enable the LLM model select box
        llmModelSelect.disabled = false;
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const checkbox = document.getElementById('awarenessCheckbox');
      const timeAwarenessField = document.getElementById('timeAwareness');
      const placeAwarenessField = document.getElementById('placeAwareness');

      checkbox.addEventListener('change', function () {
        if (checkbox.checked) {
          timeAwarenessField.value = 'on';
          placeAwarenessField.value = 'on';
        } else {
          timeAwarenessField.value = 'off';
          placeAwarenessField.value = 'off';
        }
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const checkbox = document.getElementById('imageGenerationCapabilityCheckbox');
      const imageGenerationCapabilityField = document.getElementById('image_generation_capability');

      checkbox.addEventListener('change', function () {
        if (checkbox.checked) {
          imageGenerationCapabilityField.value = 'on';
        } else {
          imageGenerationCapabilityField.value = 'off';
        }
      });
    });
  </script>

  <script>
    function addRow() {
      const tableBody = document.querySelector('#keyValueTable tbody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
          <td><input type="text" name="terms[]" placeholder="Enter term" class="form-control"></td>
          <td><input type="text" name="definitions[]" placeholder="Enter definition for the term" class="form-control"></td>
          <td><button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i class="fa fa-remove"></i></button></td>
      `;
      tableBody.appendChild(newRow);
    }

    function removeRow(button) {
      const row = button.closest('tr');
      row.remove();
    }

    document.getElementById('csv_file').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) {
        return;
      }

      const reader = new FileReader();
      reader.onload = function (event) {
        // remove the existing row
        const tableBody = document.querySelector('#keyValueTable tbody');
        tableBody.innerHTML = '';
        const text = event.target.result;
        const rows = text.split('\n');

        rows.forEach(row => {
          const cols = row.split(',');
          if (cols.length === 2) {
            addRowWithValues(cols[0].trim(), cols[1].trim());
          }
        });
      };

      reader.readAsText(file);
    });

    function addRowWithValues(term, definition) {
      const tableBody = document.querySelector('#keyValueTable tbody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
          <td><input type="text" name="terms[]" value="${term}" class="form-control"></td>
          <td><input type="text" name="definitions[]" value="${definition}" class="form-control"></td>
          <td><button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i class="fa fa-remove"></i></button></td>
      `;
      tableBody.appendChild(newRow);
    }
  </script>

{% endblock %}
