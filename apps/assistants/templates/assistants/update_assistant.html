{% extends layout_path %}

{% load static %}
{% load i18n %}
{% load field_to_label %}

{% block title %}Update Assistant{% endblock %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/flatpickr/flatpickr.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/cleavejs/cleave.js' %}"></script>
<script src="{% static 'vendor/libs/cleavejs/cleave-phone.js' %}"></script>
<script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
<script src="{% static 'vendor/libs/flatpickr/flatpickr.js' %}"></script>
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
{{ block.super }}
<script src="{% static 'js/form-layouts.js' %}"></script>
{% endblock page_js %}

{% block content %}
<!-- Basic Layout -->
<div class="row">
  <div class="col-xl mb-6">
    <div class="card">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          {% if assistant.assistant_image %}
            <img src="{{ assistant.assistant_image.url }}" class="rounded" width="170" height="170" alt="Assistant Image">
          {% else %}
            <img src="{% static 'img/avatars/org-0.png' %}" class="rounded" width="170" height="170" alt="Assistant Image">
          {% endif %}
          <h3 class="mb-0">
            <strong>
              {{ assistant.name }}
            </strong>
            <br><br>
            <small class="text">
              <i class="fas fa-building"></i>
              Audience:
              <strong>{{ assistant.audience }}</strong>
            </small>
            <br>
            <small class="text">
              <i class="fas fa-user-astronaut"></i>
              Tone:
              <strong>{{ assistant.tone }}</strong>
            </small>
          </h3>
          <br><br>
        </div>
      </div>
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Update Assistant Information</h5> <small class="text-muted float-end"></small>
      </div>
      <div class="card-body">
        <div class="alert alert-secondary alert-dismissible d-flex col-lg-10 align-items-center" role="alert">
          <img src="{% static 'img/custom-illustrations/boy-red-3.png' %}" width="25%" class="justify-content-end">
        <span class="alert-icon rounded">
          <i class="ti ti-bookmark"></i>
        </span>
        <div class="d-flex flex-column ps-1">
          <h5 class="alert-heading mb-2">Tip</h5>
          <p class="mb-0">
            In this page, you can update the information of an assistant. You can change the name, description, instructions,
            audience, tone, and the image of the assistant. Once you have updated the information, click on the "Update Information"
            button to save the changes.
          </p>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
          </button>
        </div>
      </div>
        {% if error_messages %}
          {% for key, message in error_messages.items %}
            <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-danger{% endif %}" role="alert">
              <strong>{{ key | field_name_to_label }}:</strong> {{ message }}
            </div>
          {% endfor %}
        {% endif %}
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-6">
            <label class="form-label" for="name">Name</label>
            <input type="text" class="form-control" id="name" name="name" placeholder="Enter assistant name" value="{{ assistant.name }}"/>
            <div class="form-text"></div>
          </div>
          <div class="mb-6">
            <label class="form-label" for="description">Description</label>
            <input type="text" class="form-control" id="description" name="description" placeholder="Enter assistant description" value="{{ assistant.description }}"/>
            <div class="form-text"></div>
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
            This description will not be used to communicate or train the assistant. It is for human-readers to understand the assistant's purpose.
          </div>
          <div class="mb-6">
            <label class="form-label" for="instructions">Instructions</label>
            <textarea class="form-control" id="instructions" name="instructions" placeholder="Enter assistant instructions">{{ assistant.instructions }}</textarea>
            <div class="form-text"></div>
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
            These instructions will be used to train the assistant. For example, "This assistant is designed to help students with their homework."
          </div>
          <div class="mb-6">
            <label class="form-label" for="response_template">Response Template</label>
            <textarea class="form-control" id="response_template" name="response_template" placeholder="Enter assistant response template">{{ assistant.response_template }}</textarea>
            <div class="form-text"></div>
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
            This response template will be used to generate responses for the assistant. If you don't have a solid
            response template for the assistant, you can leave this field empty. You can also put a sample response
            in this field to make it more clear for the assistant to understand how it should respond to the user.
          </div>
          <div class="mb-6">
            <label class="form-label" for="audience">Audience</label>
            <input type="text" class="form-control" id="audience" name="audience" placeholder="Enter assistant audience" value="{{ assistant.audience }}"/>
            <div class="form-text"></div>
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
            Describe the audience for this assistant. For example, "This assistant is designed for students in the 9th grade."
          </div>
          <div class="mb-6 col-lg-6">
            <label class="form-label" for="max_retry_count">Maximum Response Retry Count</label>
            <input type="range" class="form-range" id="max_retry_count" name="max_retry_count" min="0" max="10" step="1" value="{{ assistant.max_retry_count }}" oninput="this.nextElementSibling.value = this.value">
            <output>{{ assistant.max_retry_count }}</output>
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
            The maximum number of times the assistant will retry generating a response if it fails to generate a response the first time. Please be aware that setting this value too high may cause the assistant to spend too much time and credits to generate a response.
          </div>
          <div class="mb-6 col-lg-6">
            <label class="form-label" for="tool_max_attempts_per_instance">Maximum Tool Retry Count</label>
            <!-- slider bar here -->
            <input type="range" class="form-range" id="tool_max_attempts_per_instance" name="tool_max_attempts_per_instance" min="0" max="10" step="1" value="{{ assistant.tool_max_attempts_per_instance }}" oninput="this.nextElementSibling.value = this.value">
            <output>{{ assistant.tool_max_attempts_per_instance }}</output>
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
            The maximum number of times the assistant will retry using a tool if it fails to retrieve a data
            the first time. Please be aware that setting this value too high may cause the assistant to spend
            too much time and credits to retrieve data.
          </div>
          <div class="mb-6 col-lg-6">
            <label class="form-label" for="tool_max_chains">Maximum Pipeline Length</label>
            <!-- slider bar here -->
            <input type="range" class="form-range" id="tool_max_chains" name="tool_max_chains" min="0" max="20" step="1" value="{{ assistant.tool_max_chains }}" oninput="this.nextElementSibling.value = this.value">
            <output>{{ assistant.tool_max_chains }}</output>
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
            The maximum number of tools the assistant will use in a single response, one used after the other.
            Please be aware that setting this value too high may cause the assistant to spend too much time and
            credits to generate a response, similar to the maximum response retry count and maximum tool retry count.
          </div>
          <div class="mb-6">
            <label class="form-label" for="tone">Tone</label>
            <input type="text" class="form-control" id="tone" name="tone" placeholder="Enter assistant tone" value="{{ assistant.tone }}"/>
            <div class="form-text"></div>
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
            <span class="alert-icon rounded">
              <i class="ti ti-info-circle"></i>
            </span>
            Describe the tone for this assistant. For example, "This assistant intends to be friendly and helpful, in a casual tone."
          </div>
          <div class="mb-6">
            <label class="form-label" for="llm_model">LLM Model</label>
            <select class="form-select" id="llm_model" name="llm_model">
              {% for model in llm_models %}
                <option value="{{ model.id }}" {% if assistant.llm_model.id == model.id %}selected{% endif %}>{{ model.nickname }}</option>
              {% endfor %}
            </select>
            <div class="form-text"></div>
          </div>
          <div class="mb-6">
            <label class="form-label" for="response_language">Response Language</label>
            <select class="form-select" id="response_language" name="response_language">
              <option value="">Select Response Language</option>
              {% for language in response_languages %}
                <option value="{{ language.0 }}" {% if language.0 == assistant.response_language %}selected{% endif %}>{{ language.1 }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="alert alert-solid-info d-flex align-items-center mt-6" role="alert">
              <span class="alert-icon rounded">
                <i class="ti ti-info-circle"></i>
              </span>
              Select the language in which the assistant will respond to the user. If you select "auto", the
              assistant will automatically detect the language of the user's input and respond in the same language.
          </div>
          <div class="mb-6">
              <label class="form-label" for="time_awareness">Time &amp; Location Awareness (Recommended)</label>
              <br>
              <label class="switch switch-square switch-lg mt-2">
                <input type="checkbox" class="switch-input" id="awarenessCheckbox" {% if assistant.time_awareness and assistant.place_awareness %}checked{% endif %}>
                <span class="switch-toggle-slider">
                  <!-- Hidden fields for time_awareness and place_awareness -->
                  <input type="hidden" name="time_awareness" id="timeAwareness" value="{% if assistant.time_awareness %}on{% else %}off{% endif %}">
                  <input type="hidden" name="place_awareness" id="placeAwareness" value="{% if assistant.place_awareness %}on{% else %}off{% endif %}">
                  <span class="switch-on"><i class="ti ti-check"></i></span>
                  <span class="switch-off"><i class="ti ti-x"></i></span>
                </span>
              </label>
            </div>
          <div class="mb-6">
            <label class="form-label" for="assistant_image">Assistant Image</label>
            <input type="file" class="form-control" id="assistant_image" name="assistant_image"/>
            <div class="form-text"></div>
          </div>
          <button type="submit" class="btn btn-primary d-grid w-100">Update Assistant</button>
        </form>
      </div>
    </div>
  </div>
</div>


<script>
  document.addEventListener('DOMContentLoaded', function() {
    const checkbox = document.getElementById('awarenessCheckbox');
    const timeAwarenessField = document.getElementById('timeAwareness');
    const placeAwarenessField = document.getElementById('placeAwareness');

    checkbox.addEventListener('change', function() {
      if (checkbox.checked) {
        timeAwarenessField.value = 'on';
        placeAwarenessField.value = 'on';
      } else {
        timeAwarenessField.value = 'off';
        placeAwarenessField.value = 'off';
      }
    });
  });
</script>

{% endblock %}
