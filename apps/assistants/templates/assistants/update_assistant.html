  <!--
  ~ Copyright (c) 2024 BMD™ Autonomous Holdings. All rights reserved.
  ~
  ~ Project: Bimod.io™
  ~ File: update_assistant.html
  ~ Last Modified: 2024-10-05 01:39:47
  ~ Author: Ege Dogan Dursun (Co-Founder & Chief Executive Officer / CEO @ BMD™ Autonomous Holdings)
  ~ Created: 2024-10-05 14:42:38
  ~
  ~ This software is proprietary and confidential. Unauthorized copying,
  ~ distribution, modification, or use of this software, whether for
  ~ commercial, academic, or any other purpose, is strictly prohibited
  ~ without the prior express written permission of BMD™ Autonomous
  ~ Holdings.
  ~
  ~  For permission inquiries, please contact: admin@Bimod.io.
  ~
  -->

{% extends layout_path %}

{% load static %}
{% load i18n %}
{% load field_to_label %}

{% block title %}Update Assistant{% endblock %}

{% block vendor_css %}
  {{ block.super }}

<link rel="stylesheet" href="{% static 'vendor/libs/flatpickr/flatpickr.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}"/>
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/cleavejs/cleave.js' %}"></script>
  <script src="{% static 'vendor/libs/cleavejs/cleave-phone.js' %}"></script>
  <script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
  <script src="{% static 'vendor/libs/flatpickr/flatpickr.js' %}"></script>
  <script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
  {{ block.super }}
  <script src="{% static 'js/form-layouts.js' %}"></script>
{% endblock page_js %}

{% block content %}

  <a href="{% url 'assistants:list' %}">
    <button class="btn btn-secondary my-4 w-25">
      <i class="fa fa-chevron-left me-4"></i>
      <strong> Back to Assistants</strong>
    </button>
  </a>

  <!-- Basic Layout -->
  <div class="row">
    <div class="col-xl mb-6">
      <div class="card">
        <div class="card">
          <div class="card-header d-flex justify-content-start align-items-center">
            {% if assistant.assistant_image %}
              <img src="{{ assistant.assistant_image.url }}" class="rounded" width="170" height="170"
                   alt="Assistant Image">
            {% else %}
              <img src="{% static 'img/avatars/org-0.png' %}" class="rounded" width="170" height="170"
                   alt="Assistant Image">
            {% endif %}
            <h3 class="mb-0 ms-4">
              <strong>
                {{ assistant.name }}
              </strong>
              <br>
              <small class="text">
                <i class="fas fa-building"></i>
                Organization:
                <strong>{{ assistant.organization.name }}</strong>
              </small>
              <br>
              <small class="text">
                <i class="fas fa-microphone"></i>
                Audience:
                <strong>{{ assistant.audience }}</strong>
              </small>
              <br>
              <small class="text">
                <i class="fas fa-user-astronaut"></i>
                Tone:
                <strong>{{ assistant.tone }}</strong>
              </small>
            </h3>
            <br><br>
          </div>
        </div>

        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><strong>Update Assistant</strong></h5> <small class="text-muted float-end"></small>
        </div>

        <div class="card-body">
          <div class="tips-section alert alert-secondary alert-dismissible d-flex col-lg-12 align-items-center"
               role="alert">
            <img src="{% static 'img/custom-illustrations-v2/i2-43.png' %}" width="25%" style="border-radius:25px;"
                 class="justify-content-end me-8" alt="Illustration for tip">
            <span class="alert-icon rounded">
          <i class="ti ti-bookmark"></i>
        </span>
            <div class="d-flex flex-column ps-1">
              <h5 class="alert-heading mb-2">Tip</h5>
              <p class="mb-0">
                In this page, you can update the information of an assistant. You can change the name, description,
                instructions,
                audience, tone, and the image of the assistant. Once you have updated the information, click on the
                "Update Information"
                button to save the changes.
              </p>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
              </button>
            </div>
          </div>

          {% if error_messages %}
            {% for key, message in error_messages.items %}
              <div
                class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-danger{% endif %}"
                role="alert">
                <strong>{{ key | field_name_to_label }}:</strong> {{ message }}
              </div>
            {% endfor %}
          {% endif %}

          {% if messages %}
            {% for message in messages %}
              <div
                class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-danger{% endif %}"
                role="alert">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}

          <form method="post" enctype="multipart/form-data" class="mt-4">
            {% csrf_token %}
            <div class="row p-8">
              <div class="mb-6 col-3">
                <label class="form-label" for="llm_model">LLM Model</label>
                <select class="form-select" id="llm_model" name="llm_model">
                  {% for model in llm_models %}
                    <option value="{{ model.id }}"
                            {% if assistant.llm_model.id == model.id %}selected{% endif %}>{{ model.nickname }}</option>
                  {% endfor %}
                </select>
                <div class="form-text"></div>
              </div>
              <div class="col-3 mb-6">
                <label class="form-label" for="name">Name</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="Enter assistant name"
                       value="{{ assistant.name }}"/>
                <div class="form-text"></div>
              </div>
              <div class="col-3 mb-6">
                <label class="form-label" for="description">Description</label>
                <input type="text" class="form-control" id="description" name="description"
                       placeholder="Enter assistant description" value="{{ assistant.description }}"/>
                <div class="form-text"></div>
              </div>
              <div class="col-3 mb-6">
                <label class="form-label" for="ner_integration">Named Entity Recognition (NER)</label>
                <select class="form-select" id="ner_integration" name="ner_integration">
                  {% if assistant.ner_integration %}
                    <option value="{{ assistant.ner_integration.id }}" class="ner-policy-option"
                            data-org-id="{{ assistant.ner_integration.organization.id }}"
                            selected>{{ assistant.ner_integration.name }}</option>
                  {% endif %}
                  <option value="" class="ner-policy-option" {% if not assistant.ner_integration %}selected{% endif %}>
                    No NER Policy
                  </option>
                  {% for ner_policy in ner_integrations %}
                    {% if assistant.ner_integration and ner_policy.id == assistant.ner_integration.id %}
                      <!-- ... -->
                    {% else %}
                      <option value="{{ ner_policy.id }}" class="ner-policy-option"
                              data-org-id="{{ ner_policy.organization.id }}">{{ ner_policy.name }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
              <div class="col-6 mb-6">
                <label class="form-label" for="instructions">Instructions</label>
                <textarea class="form-control" id="instructions" name="instructions"
                          placeholder="Enter assistant instructions">{{ assistant.instructions }}</textarea>
                <div class="form-text"></div>
              </div>
              <div class="col-6 mb-6">
                <label class="form-label" for="response_template">Response Template</label>
                <textarea class="form-control" id="response_template" name="response_template"
                          placeholder="Enter assistant response template">{{ assistant.response_template }}</textarea>
                <div class="form-text"></div>
              </div>
              <div class="col-3 mb-6">
                <label class="form-label" for="audience">Audience</label>
                <input type="text" class="form-control" id="audience" name="audience"
                       placeholder="Enter assistant audience" value="{{ assistant.audience }}"/>
                <div class="form-text"></div>
              </div>
              <div class="col-3 mb-6">
                <label class="form-label" for="tone">Tone</label>
                <input type="text" class="form-control" id="tone" name="tone" placeholder="Enter assistant tone"
                       value="{{ assistant.tone }}"/>
                <div class="form-text"></div>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="time_awareness">Time &amp; Location Awareness</label>
                <br>
                <label class="switch switch-square switch-lg mt-2">
                  <input type="checkbox" class="switch-input" id="awarenessCheckbox"
                         {% if assistant.time_awareness and assistant.place_awareness %}checked{% endif %}>
                  <span class="switch-toggle-slider">
                <!-- Hidden fields for time_awareness and place_awareness -->
                <input type="hidden" name="time_awareness" id="timeAwareness"
                       value="{% if assistant.time_awareness %}on{% else %}off{% endif %}">
                <input type="hidden" name="place_awareness" id="placeAwareness"
                       value="{% if assistant.place_awareness %}on{% else %}off{% endif %}">
                <span class="switch-on"><i class="ti ti-check"></i></span>
                <span class="switch-off"><i class="ti ti-x"></i></span>
              </span>
                </label>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="image_generation_capability">Image Generation &amp; Manipulation</label>
                <br>
                <label class="switch switch-square switch-lg mt-2">
                  <input type="checkbox" class="switch-input" id="imageGenerationCapabilityCheckbox"
                         {% if assistant.image_generation_capability %}checked{% endif %}>
                  <span class="switch-toggle-slider">
                <input type="hidden" name="image_generation_capability" id="image_generation_capability"
                       value="{% if assistant.image_generation_capability %}on{% else %}off{% endif %}">
                <span class="switch-on"><i class="ti ti-check"></i></span>
                <span class="switch-off"><i class="ti ti-x"></i></span>
              </span>
                </label>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="max_retry_count">Max Retries</label>
                <input type="range" class="form-range" id="max_retry_count" name="max_retry_count" min="0" max="10"
                       step="1" value="{{ assistant.max_retry_count }}"
                       oninput="this.nextElementSibling.value = this.value">
                <output>{{ assistant.max_retry_count }}</output>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="tool_max_attempts_per_instance">Max Tool Retries</label>
                <input type="range" class="form-range" id="tool_max_attempts_per_instance"
                       name="tool_max_attempts_per_instance" min="0" max="10" step="1"
                       value="{{ assistant.tool_max_attempts_per_instance }}"
                       oninput="this.nextElementSibling.value = this.value">
                <output>{{ assistant.tool_max_attempts_per_instance }}</output>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="tool_max_chains">Max Pipelines</label>
                <input type="range" class="form-range" id="tool_max_chains" name="tool_max_chains" min="0" max="20"
                       step="1" value="{{ assistant.tool_max_chains }}"
                       oninput="this.nextElementSibling.value = this.value">
                <output>{{ assistant.tool_max_chains }}</output>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="max_context_messages">Max Message Memory</label>
                <!-- slider bar here -->
                <input type="range" class="form-range" id="max_context_messages" name="max_context_messages" min="10"
                       max="100" step=1" value="{{ assistant.max_context_messages }}"
                       oninput="this.nextElementSibling.value = this.value">
                <output>{{ assistant.max_context_messages }}</output>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="response_language">Response Language</label>
                <select class="form-select" id="response_language" name="response_language">
                  <option value="">Select Response Language</option>
                  {% for language in response_languages %}
                    <option value="{{ language.0 }}"
                            {% if language.0 == assistant.response_language %}selected{% endif %}>{{ language.1 }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="assistant_image">Assistant Image</label>
                <input type="file" class="form-control" id="assistant_image" name="assistant_image"/>
                <div class="form-text"></div>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="multi_step_reasoning_capability_choice">Multi-Step Reasoning <span class="text-warning"><strong>(† increases costs)</strong></span></label>
                <select class="form-select" id="multi_step_reasoning_capability_choice" name="multi_step_reasoning_capability_choice">
                  {% for choice in reasoning_capability_choices %}
                    <option value="{{ choice.0 }}"
                            {% if choice.0 == assistant.multi_step_reasoning_capability_choice %}selected{% endif %}>{{ choice.1 }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="context_overflow_strategy">Context Overflow Management Strategy</label>
                <select class="form-select" id="context_overflow_strategy" name="context_overflow_strategy">
                  {% for strategy in context_overflow_strategies %}
                    <option value="{{ strategy.0 }}"
                            {% if strategy.0 == assistant.context_overflow_strategy %}selected{% endif %}>{{ strategy.1 }}</option>
                  {% endfor %}
                </select>
              </div>
              <div id="memory-vectorizer-selection-bar" class="mb-6 col-6 d-none">
                <label class="form-label" for="vectorizer_name">Chat Memory Vectorizer</label>
                <select class="form-select" id="vectorizer_name" name="vectorizer_name">
                  <option value="" disabled selected>Select Vectorizer</option>
                  {% for vectorizer in vectorizers %}
                    <option value="{{ vectorizer.0 }}"
                            {% if vectorizer.0 == assistant.vectorizer_name %}selected{% endif %}>{{ vectorizer.1 }}</option>
                  {% endfor %}
                </select>
              </div>
              <div id="memory-vectorizer-api-key-bar" class="mb-6 col-6 d-none">
                <label class="form-label" for="vectorizer_api_key">Vectorizer API Key</label>
                <input type="text" class="form-control" id="vectorizer_api_key" name="vectorizer_api_key"
                       placeholder="Enter the API key for your OpenAI account"
                       value="{{ assistant.vectorizer_api_key }}"/>
              </div>
              <div class="mb-6 col-12">
                <label class="form-label" for="glossary">Glossary</label>
                <table id="keyValueTable" class="table table-bordered">
                  <thead>
                  <tr>
                    <th>Term</th>
                    <th>Definition</th>
                    <th></th>
                  </tr>
                  </thead>
                  <tbody>
                  {% for glossary_item, glossary_definition in assistant.glossary.items %}
                    <tr>
                      <td><input type="text" name="terms[]" placeholder="Enter term" class="form-control"
                                 value="{{ glossary_item }}"></td>
                      <td><input type="text" name="definitions[]" placeholder="Enter definition for the term"
                                 class="form-control" value="{{ glossary_definition }}"></td>
                      <td>
                        <button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i
                          class="fa fa-remove"></i></button>
                      </td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
                <button type="button" onclick="addRow()" class="btn btn-success d-grid w-20 mt-4"><strong>
                  <i class="fa fa-plus me-2"></i>Add New Row</strong></button>
              </div>
            </div>
            <hr>
            <button type="submit" class="btn btn-primary d-grid mt-8 w-25"><strong>
              <i class="fa fa-save me-2"></i>Update Assistant</strong></button>
          </form>
        </div>
      </div>
    </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const checkbox = document.getElementById('awarenessCheckbox');
      const timeAwarenessField = document.getElementById('timeAwareness');
      const placeAwarenessField = document.getElementById('placeAwareness');

      checkbox.addEventListener('change', function () {
        if (checkbox.checked) {
          timeAwarenessField.value = 'on';
          placeAwarenessField.value = 'on';
        } else {
          timeAwarenessField.value = 'off';
          placeAwarenessField.value = 'off';
        }
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const checkbox = document.getElementById('imageGenerationCapabilityCheckbox');
      const imageGenerationCapabilityField = document.getElementById('image_generation_capability');

      checkbox.addEventListener('change', function () {
        if (checkbox.checked) {
          imageGenerationCapabilityField.value = 'on';
        } else {
          imageGenerationCapabilityField.value = 'off';
        }
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const contextOverflowStrategySelect = document.getElementById('context_overflow_strategy');
      const maxContextMessagesInput = document.getElementById('max_context_messages');
      const memoryVectorizerSelectionBar = document.getElementById('memory-vectorizer-selection-bar');
      const memoryVectorizerApiKeyBar = document.getElementById('memory-vectorizer-api-key-bar');
      const memoryVectorizerAlertBar = document.getElementById('memory-vectorizer-alert-bar');

      if (contextOverflowStrategySelect.value === 'vectorize') {
        memoryVectorizerSelectionBar.classList.remove('d-none');
        memoryVectorizerApiKeyBar.classList.remove('d-none');
        memoryVectorizerAlertBar.classList.remove('d-none');
      }

      contextOverflowStrategySelect.addEventListener('change', function () {
        const selectedStrategy = this.value;

        if (selectedStrategy === 'vectorize') {
          console.log("entering inside for removal...");
          memoryVectorizerSelectionBar.classList.remove('d-none');
          memoryVectorizerApiKeyBar.classList.remove('d-none');
          memoryVectorizerAlertBar.classList.remove('d-none');
        } else {
          memoryVectorizerSelectionBar.classList.add('d-none');
          memoryVectorizerApiKeyBar.classList.add('d-none');
          memoryVectorizerAlertBar.classList.add('d-none');
        }
      });

      maxContextMessagesInput.addEventListener('input', function () {
        const selectedStrategy = contextOverflowStrategySelect.value;

        if (selectedStrategy === 'vectorize') {
          memoryVectorizerSelectionBar.classList.remove('d-none');
          memoryVectorizerApiKeyBar.classList.remove('d-none');
          memoryVectorizerAlertBar.classList.remove('d-none');
        }
      });
    });
  </script>

  <script>
    function addRow() {
      const tableBody = document.querySelector('#keyValueTable tbody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
          <td><input type="text" name="terms[]" placeholder="Enter term" class="form-control"></td>
          <td><input type="text" name="definitions[]" placeholder="Enter definition for the term" class="form-control"></td>
          <td><button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i class="fa fa-remove"></i></button></td>
      `;
      tableBody.appendChild(newRow);
    }

    function removeRow(button) {
      const row = button.closest('tr');
      row.remove();
    }

    document.getElementById('keyValueForm').addEventListener('submit', function (event) {
      event.preventDefault();
      const formData = new FormData(this);
      const keys = formData.getAll('keys[]');
      const values = formData.getAll('values[]');

      const keyValuePairs = keys.map((key, index) => ({
        key: key,
        value: values[index]
      }));

      console.log(keyValuePairs);
      // You can send keyValuePairs to the server or process them as needed
    });
  </script>

{% endblock %}
