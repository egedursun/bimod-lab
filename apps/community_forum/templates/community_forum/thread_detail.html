  <!--
  ~ Copyright (c) 2024 BMD® Autonomous Holdings. All rights reserved.
  ~
  ~ Project: Bimod.io
  ~ File: thread_detail.html
  ~ Last Modified: 2024-09-25 17:51:06
  ~ Author: Ege Dogan Dursun (Co-Founder & Chief Executive Officer / CEO @ BMD® Autonomous Holdings)
  ~ Created: 2024-10-01 23:21:46
  ~
  ~ This software is proprietary and confidential. Unauthorized copying,
  ~ distribution, modification, or use of this software, whether for
  ~ commercial, academic, or any other purpose, is strictly prohibited
  ~ without the prior express written permission of BMD® Autonomous
  ~ Holdings.
  ~
  ~  For permission inquiries, please contact: admin@bimod.io.
  ~
  -->


{% extends layout_path %}

{% load static %}
{% load i18n %}
{% load field_to_label %}

{% block title %}Thread Details{% endblock %}

{% block vendor_css %}
  {{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-bs5/datatables.bootstrap5.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/sweetalert2/sweetalert2.css' %}"/>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.7.2/font/bootstrap-icons.min.css">
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
  <script src="{% static 'vendor/libs/datatables-bs5/datatables-bootstrap5.js' %}"></script>
  <script src="{% static 'vendor/libs/sweetalert2/sweetalert2.js' %}"></script>
  <script src="{% static 'vendor/libs/plyr/plyr.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
  {{ block.super }}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Restore and update the collapse state
      function storeCollapsedTabState() {
        const collapsedTabs = [];
        document.querySelectorAll('.collapse:not(.show)').forEach(collapse => {
          collapsedTabs.push(collapse.id);
        });
        localStorage.setItem('collapsedTabs', JSON.stringify(collapsedTabs));
      }

      function restoreCollapsedTabState() {
        const collapsedTabs = JSON.parse(localStorage.getItem('collapsedTabs'));
        if (collapsedTabs && Array.isArray(collapsedTabs)) {
          collapsedTabs.forEach(tabId => {
            const collapseElement = document.getElementById(tabId);
            if (collapseElement) {
              new bootstrap.Collapse(collapseElement, {
                toggle: true
              });
            }
          });
        }
      }

      document.querySelectorAll('.collapse').forEach(collapse => {
        collapse.addEventListener('show.bs.collapse', storeCollapsedTabState);
        collapse.addEventListener('hide.bs.collapse', storeCollapsedTabState);
      });

      restoreCollapsedTabState();

      // Toggle icon logic
      document.querySelectorAll('.toggle-icon').forEach(function (icon) {
        icon.addEventListener('click', function () {
          var target = document.querySelector(this.getAttribute('data-target'));
          var bootstrapCollapse = new bootstrap.Collapse(target, {
            toggle: true
          });
          if (target.classList.contains('show')) {
            bootstrapCollapse.hide();
            icon.classList.remove('fa-arrow-alt-circle-up');
            icon.classList.add('fa-arrow-alt-circle-down');
          } else {
            bootstrapCollapse.show();
            icon.classList.remove('fa-arrow-alt-circle-down');
            icon.classList.add('fa-arrow-alt-circle-up');
          }
        });
      });
    });
  </script>
{% endblock page_js %}

{% block content %}

  <a href="{% url 'community_forum:thread_list' slug=thread.category.slug %}">
    <button class="btn btn-secondary ms-4 mt-4 mb-8">
      <i class="fa fa-chevron-left me-4"></i>
      <strong> Back to Threads</strong>
    </button>
  </a>

  <a href="{% url 'community_forum:post_create' thread_id=thread.id %}" class="btn btn-success mt-4 ms-4 mb-8">
    <i class="fa fa-add me-4"></i>
    <strong>Create New Post</strong>
  </a>

  <div class="container-fluid">
    <div class="row mb-4">
      <div class="col-12">
        <h3 class="mb-0"><strong>Posts - {{ thread.title }}</strong></h3>
      </div>
    </div>

    <div class="tips-section alert alert-secondary alert-dismissible d-flex col-lg-12 align-items-center" role="alert">
      <img src="{% static 'img/custom-illustrations-v2/i2-47.png' %}" width="25%" style="border-radius:25px;"
           class="justify-content-end me-8" alt="Illustration for tip">
      <span class="alert-icon rounded">
        <i class="ti ti-bookmark"></i>
      </span>
      <div class="d-flex flex-column ps-1">
        <h5 class="alert-heading mb-2">Tip</h5>
        <p class="mb-0">
          This is the thread detail page. Here you can view all the posts under the "{{ thread.title }}" thread. Click
          on a
          post to view its details. You can also create a new post by clicking on the "Create New Post" button below.
          The comments for each post are paginated, and you can navigate through the comments using the pagination
          links.
          You can also add comments to each post by filling out the comment form at the bottom of each post.
        </p>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
        </button>
      </div>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div
          class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-danger{% endif %}"
          role="alert">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <hr>

    <!-- Search and Filter Form -->
    <div class="row g-4 mb-4 mt-8 card card-border-shadow-primary p-4">
      <div class="col-xl-12">
        <h5 class="text-muted"><strong>Search Posts</strong></h5>
        <div class="card text-center mb-4">
          <div class="card-header">
            <div class="nav-align-top">
              <form method="get" action=".">
                <div class="input-group mb-3">
                  <input type="text" name="search" value="{{ search_query }}" class="form-control"
                         placeholder="Search posts by content">
                  <button type="submit" class="btn btn-primary"><strong>Search</strong></button>
                  <a href="." class="btn btn-secondary"><strong>Clear</strong></a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-8">
      <div class="card-header">
        <h5 class="card-title"><strong>Posts</strong></h5>
        <strong class="text-muted">
          <small><i class="fa fa-bookmark me-2"></i> This is the thread detail page. Here you can view all the posts
            under the "{{ thread.title }}" thread. Click on a post to view its details.</small>
        </strong>
      </div>
      <div class="card-body">
        {% if posts %}
          {% for post in posts %}
            <hr>
            <div class="card card-border-shadow-primary p-8 post">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>Posted by:</strong> {{ post.created_by.username }} <br>
                  <small>on {{ post.created_at }}</small>
                </div>
              </div>
              <div class="post-content border border-primary border-2 mt-3 p-4 rounded mb-4 overflow-auto"
                   style="max-height: 400px;">
                {{ post.content|linebreaks }}
              </div>

              <!-- Comments Section -->
              <div class="comments mt-4">
                <h6><strong>Comments</strong></h6>
                {% if post.ordered_comments %}
                  {% for comment in post.ordered_comments %}
                    <div
                      class="comment alert alert-secondary {% if comment == post.verified_comment %} border border-2 border-success rounded{% endif %}">
                      {% if comment == post.verified_comment %}
                        <div class="badge bg-success my-2 p-4 w-100"><i class="fa fa-check-circle me-4"></i><strong>Merited
                          Comment</strong></div>
                      {% endif %}
                      <div class="card card-border-shadow-primary m-2 p-4 w-25">
                        <div>
                          <strong><i class="fa fa-user-astronaut me-2"></i>{{ comment.created_by.username }}</strong>
                        </div>
                        <div>
                          <small><i class="fa fa-clock ms-4 me-2"></i>{{ comment.created_at }}</small>
                        </div>
                        <div class="mt-2">
                          <strong>
                            <small class="ms-4 bg-primary p-1 text-white rounded"><small>Role: </small><span
                              class="ms-4 me-4">&nbsp;&nbsp; ♟️</span>{{ comment.created_by.profile.user_forum_role|field_name_to_label }}
                            </small>
                          </strong>
                        </div>
                        <div class="mt-2">
                          <strong>
                            <small class="ms-4 bg-primary p-1 text-white rounded"><small>Score: </small><span
                              class="ms-4 me-4">⭐</span>{{ comment.created_by.profile.user_forum_points }}</small>
                          </strong>
                        </div>
                        <div class="mt-2">
                          <strong>
                            <small
                              class="ms-4 bg-primary p-1 text-white rounded"><small>Rank: </small>
                              <span class="ms-4 me-4">&nbsp; 🎖️</span>
                              {{ comment.created_by.profile.user_forum_rank|field_name_to_label }}
                            </small>
                          </strong>
                        </div>
                      </div>
                      <hr>
                      <h6><span class="me-4">💬</span><strong>Replied: </strong></h6>
                      <hr>
                      <div class="comment-content mt-2 text-dark overflow-auto" style="max-height: 400px;">
                        {{ comment.content|linebreaks }}
                      </div>
                      <!-- Like/Dislike Button -->
                      <div class="d-flex justify-content-end mt-2">
                        <form action="{% url 'community_forum:like_comment' comment.id %}" method="post">
                          {% csrf_token %}
                          {% if comment.user_has_liked %}
                            <button type="submit" class="btn btn-outline-danger bg-danger-subtle btn-sm">
                              <i class="fa fa-thumbs-down me-2"></i><strong>Dislike ({{ comment.like_count }})</strong>
                            </button>
                          {% else %}
                            <button type="submit" class="btn btn-outline-primary bg-primary-subtle btn-sm">
                              <i class="fa fa-thumbs-up me-2"></i><strong>Like ({{ comment.like_count }})</strong>
                            </button>
                          {% endif %}
                        </form>
                      </div>

                      <!-- Verification Button (Only for Post Owner) -->
                      {% if post.created_by == request.user and comment != post.verified_comment %}
                        <div class="d-flex justify-content-end mt-2">
                          <form action="{% url 'community_forum:verify_comment' post.id comment.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-success bg-success-subtle btn-sm">
                              <strong class="me-2">✅</strong><strong>Merit</strong>
                            </button>
                          </form>
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                  <!-- Pagination for Comments -->
                  <nav aria-label="Comments Pagination">
                    <ul class="pagination pagination-rounded justify-content-center">
                      {% if post.comment_page_obj.has_previous %}
                        <li class="page-item">
                          <a class="page-link" href="?page={{ post_page_obj.number }}&comment_page_{{ post.id }}=1"
                             aria-label="First">
                            <i class="ti ti-chevrons-left ti-sm"></i>
                          </a>
                        </li>
                        <li class="page-item">
                          <a class="page-link"
                             href="?page={{ post_page_obj.number }}&comment_page_{{ post.id }}={{ post.comment_page_obj.previous_page_number }}"
                             aria-label="Previous">
                            <i class="ti ti-chevron-left ti-sm"></i>
                          </a>
                        </li>
                      {% endif %}
                      {% for page_num in post.comment_page_obj.paginator.page_range %}
                        <li class="page-item {% if post.comment_page_obj.number == page_num %}active{% endif %}">
                          <a class="page-link"
                             href="?page={{ post_page_obj.number }}&comment_page_{{ post.id }}={{ page_num }}">{{ page_num }}</a>
                        </li>
                      {% endfor %}
                      {% if post.comment_page_obj.has_next %}
                        <li class="page-item">
                          <a class="page-link"
                             href="?page={{ post_page_obj.number }}&comment_page_{{ post.id }}={{ post.comment_page_obj.next_page_number }}"
                             aria-label="Next">
                            <i class="ti ti-chevron-right ti-sm"></i>
                          </a>
                        </li>
                        <li class="page-item">
                          <a class="page-link"
                             href="?page={{ post_page_obj.number }}&comment_page_{{ post.id }}={{ post.comment_page_obj.paginator.num_pages }}"
                             aria-label="Last">
                            <i class="ti ti-chevrons-right ti-sm"></i>
                          </a>
                        </li>
                      {% endif %}
                    </ul>
                  </nav>
                {% else %}
                  <p class="text-muted">No comments yet. Be the first to comment!</p>
                {% endif %}
              </div>

              <!-- Comment Form -->
              <div class="comment-form mt-4 col-6">
                <form method="post" enctype="multipart/form-data" class="mt-4">
                  {% csrf_token %}
                  <div class="row">
                    <div class="mb-2 col-12">
                      <label class="form-label" for="comment-content">
                        <strong>Add Comment</strong>
                      </label>
                      <textarea
                        id="comment-content"
                        name="content"
                        class="form-control"
                        placeholder="Enter your comment here"
                        rows="3"
                        style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc;"></textarea>
                    </div>
                  </div>
                  <input type="hidden" name="post_id" value="{{ post.id }}">
                  <button type="submit" class="btn btn-primary d-grid w-50 mt-0"><strong>
                    <i class="fa fa-comment me-2"></i>
                    Submit Comment
                  </strong>
                  </button>
                </form>
              </div>
            </div>
          {% endfor %}

          <!-- Pagination for Posts -->
          <nav aria-label="Posts Pagination" class="mt-4">
            <ul class="pagination pagination-rounded justify-content-center">
              {% if post_page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1" aria-label="First">
                    <i class="ti ti-chevrons-left ti-sm"></i>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ post_page_obj.previous_page_number }}" aria-label="Previous">
                    <i class="ti ti-chevron-left ti-sm"></i>
                  </a>
                </li>
              {% endif %}
              {% for page_num in post_page_obj.paginator.page_range %}
                <li class="page-item {% if post_page_obj.number == page_num %}active{% endif %}">
                  <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                </li>
              {% endfor %}
              {% if post_page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ post_page_obj.next_page_number }}" aria-label="Next">
                    <i class="ti ti-chevron-right ti-sm"></i>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ post_page_obj.paginator.num_pages }}" aria-label="Last">
                    <i class="ti ti-chevrons-right ti-sm"></i>
                  </a>
                </li>
              {% endif %}
            </ul>
          </nav>
        {% else %}
          <strong>
            <p class="alert alert-warning">
              <i class="fa fa-exclamation-triangle me-4"></i>
              No posts yet. Be the first to post!
            </p>
          </strong>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}
