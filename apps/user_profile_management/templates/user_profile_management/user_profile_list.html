{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Account Profile - Account{% endblock %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/@form-validation/form-validation.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/animate-css/animate.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/sweetalert2/sweetalert2.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
<script src="{% static 'vendor/libs/@form-validation/popular.js' %}"></script>
<script src="{% static 'vendor/libs/@form-validation/bootstrap5.js' %}"></script>
<script src="{% static 'vendor/libs/@form-validation/auto-focus.js' %}"></script>
<script src="{% static 'vendor/libs/cleavejs/cleave.js' %}"></script>
<script src="{% static 'vendor/libs/cleavejs/cleave-phone.js' %}"></script>
<script src="{% static 'vendor/libs/sweetalert2/sweetalert2.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
{{ block.super }}
<script src="{% static 'js/pages-account-settings-account.js' %}"></script>
{% endblock page_js %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="nav-align-top">
      <ul class="nav nav-pills flex-column flex-md-row mb-6 gap-2 gap-lg-0">
        <li class="nav-item"><a class="nav-link active" href="#account-settings" data-bs-toggle="pill"><i class="ti-sm ti ti-users me-1_5"></i> Account</a></li>
        <li class="nav-item"><a class="nav-link" href="#billing-settings" data-bs-toggle="pill"><i class="ti-sm ti ti-bookmark me-1_5"></i> Billing & Plans</a></li>
      </ul>
    </div>
    <div class="tab-content">
      <!-- Account -->
      <div class="tab-pane fade show active" id="account-settings">
        <div class="card mb-6">
          <div class="card-body">
            <h5 class="card-title mb-8"><strong>Profile Information</strong></h5>
            <div class="alert alert-secondary alert-dismissible d-flex col-lg-10 align-items-center mb-8" role="alert">
              <img src="{% static 'img/custom-illustrations/boy-transaction-list.png' %}" width="25%" class="justify-content-end">
                <span class="alert-icon rounded">
                  <i class="ti ti-bookmark"></i>
                </span>
                <div class="d-flex flex-column ps-1">
                  <h5 class="alert-heading mb-2">Tip</h5>
                  <p class="mb-0">
                    In this page, you can modify your profile information such as your name, email, phone number,
                    address, city, country, and postal code. You can also upload a new profile picture by clicking
                    on the "Upload new photo" button. To save the changes, click on the "Save Changes" button,
                    otherwise your changes will not be saved. If you want to rollback the changes you have made, click
                    on the  "Reset Changes" button.
                  </p>
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
                  </button>
                </div>
              </div>
            <form id="formAccountSettings" method="POST" enctype="multipart/form-data" action="{% url 'user_profile_management:list' %}">
              {% csrf_token %}
              <div class="d-flex align-items-start align-items-sm-center gap-6">
                <img src="{{ request.user.profile.profile_picture.url }}" alt="user-avatar" class="d-block w-px-100 h-px-100 rounded" id="uploadedAvatar" />
                <div class="button-wrapper">
                  <label for="upload" class="btn btn-primary me-3 mb-4" tabindex="0">
                    <span class="d-none d-sm-block">Upload new photo</span>
                    <i class="ti ti-upload d-block d-sm-none"></i>
                    <input type="file" id="upload" name="profile_picture" class="account-file-input" hidden accept="image/png, image/jpeg" />
                  </label>
                  <button type="button" class="btn btn-label-secondary account-image-reset mb-4" id="resetImage">
                    <i class="ti ti-refresh-dot d-block d-sm-none"></i>
                    <span class="d-none d-sm-block">Reset</span>
                  </button>
                  <div>Allowed JPG, GIF or PNG. Max size of 800K</div>
                  <div id="upload-warning" class="card rounded bg-label-warning d-none ps-2 pe-2 pt-1 pb-1"><strong>The changes are not saved yet. Please click the save button to proceed.</strong></div>
                </div>
              </div>
              <div class="row pt-4">
                <div class="mb-4 col-md-6">
                  <label for="first_name" class="form-label">First Name</label>
                  <input class="form-control" type="text" id="first_name" name="first_name" value="{{ request.user.profile.first_name }}" autofocus />
                </div>
                <div class="mb-4 col-md-6">
                  <label for="last_name" class="form-label">Last Name</label>
                  <input class="form-control" type="text" id="last_name" name="last_name" value="{{ request.user.profile.last_name }}" />
                </div>
                <div class="mb-4 col-md-6">
                  <label for="email" class="form-label">E-mail</label>
                  <input class="form-control" type="text" id="email" name="email" value="{{ request.user.profile.email }}" />
                </div>
                <div class="mb-4 col-md-6">
                  <label class="form-label" for="phone_number">Phone Number</label>
                  <input type="text" id="phone_number" name="phone_number" class="form-control" value="{{ request.user.profile.phone_number }}" />
                </div>
                <div class="mb-4 col-md-6">
                  <label for="address" class="form-label">Address</label>
                  <input type="text" class="form-control" id="address" name="address" value="{{ request.user.profile.address }}" />
                </div>
                <div class="mb-4 col-md-6">
                  <label for="city" class="form-label">City</label>
                  <input class="form-control" type="text" id="city" name="city" value="{{ request.user.profile.city }}" />
                </div>
                <div class="mb-4 col-md-6">
                  <label for="country" class="form-label">Country</label>
                  <select id="country" name="country" class="select2 form-select">
                    <option value="">Select</option>
                    {% for country in countries %}
                    <option value="{{ country }}" {% if request.user.profile.country == country %}selected{% endif %}>{{ country }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-4 col-md-6">
                  <label for="postal_code" class="form-label">Postal Code</label>
                  <input type="text" class="form-control" id="postal_code" name="postal_code" value="{{ request.user.profile.postal_code }}" />
                </div>
              </div>
              <div class="mt-2">
                <button type="submit" class="btn btn-primary me-3">Save Changes</button>
                <button type="reset" class="btn btn-label-secondary">Reset Changes</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- Billing & Plans -->
      <div class="tab-pane fade" id="billing-settings">
        <!-- Visual Cards for Saved Cards -->
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title mb-8"><strong>Saved Cards</strong></h5>
            <div class="alert alert-secondary alert-dismissible d-flex col-lg-10 align-items-center" role="alert">
              <img src="{% static 'img/custom-illustrations/boy-gold-1.png' %}" width="25%" class="justify-content-end">
                <span class="alert-icon rounded">
                  <i class="ti ti-bookmark"></i>
                </span>
                <div class="d-flex flex-column ps-1">
                  <h5 class="alert-heading mb-2">Tip</h5>
                  <p class="mb-0">
                    In this section, you can view all the credit cards you have saved in our system. To remove a card,
                    click on the "Remove Card" button. Please note that once you remove a card, we will irreversibly
                    delete your card from our system and there is no way to recover it.
                  </p>
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
                  </button>
                </div>
              </div>
            <div class="row mt-4">
              {% for item in saved_cards %}
              <div class="col-md-4 mb-4 mt-4">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h6 class="mb-0"><strong>{{ item.card.name_on_card }}</strong></h6>
                        <br>
                        <small class="text-muted"><strong>Card Number: &nbsp;&nbsp;</strong>{{ item.card.card_number|slice:":2" }}** **** **** {{ item.card.card_number|slice:"-4:" }}</small>
                        <br>
                        <small class="text-muted"><strong>Expiration Date: &nbsp;&nbsp;</strong>{{ item.card.card_expiration_month }} / {{ item.card.card_expiration_year }}</small>
                        <br>
                        <small class="text-muted"><strong>CVC: &nbsp;&nbsp;**</strong>{{ item.card.card_cvc|slice:":1" }}</small>
                      </div>
                      <img src="{% static 'img/icons/payments/'|add:item.card_type|add:'.png' %}" alt="{{ item.card_type }}" height="24">
                    </div>
                    <button type="button" class="btn btn-sm btn-danger mt-5 remove-card-btn" data-card-id="{{ item.card.id }}">Remove Card</button>
                    <form method="post" action="{% url 'user_profile_management:remove_card' item.card.id %}" id="removeCardForm-{{ item.card.id }}" class="d-none">
                      {% csrf_token %}
                    </form>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
  <div class="card mb-6">
    <div class="card-body">
      <h5 class="card-title mb-8"><strong>Add Credit Card</strong></h5>
      <div class="alert alert-secondary alert-dismissible d-flex col-lg-10 align-items-center mb-8" role="alert">
        <img src="{% static 'img/custom-illustrations/boy-transaction-list.png' %}" width="25%" class="justify-content-end">
          <span class="alert-icon rounded">
            <i class="ti ti-bookmark"></i>
          </span>
          <div class="d-flex flex-column ps-1">
            <h5 class="alert-heading mb-2">Tip</h5>
            <p class="mb-0">
              In this section, you can add a new credit card to your account. Please fill in the required fields
              and click on the "Save Changes" button to proceed. If you want to rollback the changes you have made,
              click on the "Reset Information" button.
            </p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
            </button>
          </div>
        </div>
      <form id="creditCardForm" method="POST" action="{% url 'user_profile_management:billing' %}">
        {% csrf_token %}
        <div class="row">
          <div class="mb-4 col-sm-6">
            <label for="name_on_card" class="form-label">Name on Card</label>
            <input type="text" id="name_on_card" name="name_on_card" class="form-control" required />
          </div>
          <div class="mb-4 col-sm-6">
            <label for="card_number" class="form-label">Card Number</label>
            <input type="text" id="card_number" name="card_number" class="form-control" maxlength="19" required />
          </div>
          <div class="mb-4 col-sm-2">
            <label for="card_expiration_month" class="form-label">Expiration Month</label>
            <input type="text" id="card_expiration_month" name="card_expiration_month" class="form-control" maxlength="2" required />
          </div>
          <div class="mb-4 col-sm-2">
            <label for="card_expiration_year" class="form-label">Expiration Year</label>
            <input type="text" id="card_expiration_year" name="card_expiration_year" class="form-control" maxlength="2" required />
          </div>
          <div class="mb-4 col-sm-2">
          </div>
          <div class="mb-4 col-sm-2">
            <label for="card_cvc" class="form-label">CVC</label>
            <input type="text" id="card_cvc" name="card_cvc" class="form-control" maxlength="4" required />
          </div>
        </div>
        <div class="mt-4">
          <button type="submit" class="btn btn-primary me-3">Save Changes</button>
          <button type="reset" class="btn btn-label-secondary">Reset Information</button>
        </div>
      </form>
    </div>
  </div>
</div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const uploadInput = document.getElementById('upload');
  const uploadedAvatar = document.getElementById('uploadedAvatar');
  const resetImage = document.getElementById('resetImage');
  const uploadWarning = document.getElementById('upload-warning');

  if (uploadInput) {
    uploadInput.addEventListener('change', function(event) {
      const [file] = event.target.files;
      if (file) {
        uploadedAvatar.src = URL.createObjectURL(file);
        uploadWarning.classList.remove('d-none');
      }
    });
  }

  if (resetImage) {
    resetImage.addEventListener('click', function() {
      uploadedAvatar.src = '{{ request.user.profile.profile_picture.url }}';
      uploadWarning.classList.add('d-none');
      uploadInput.value = ''; // Clear the file input
    });
  }

  // Handle form submission
  const formAccountSettings = document.getElementById('formAccountSettings');
  formAccountSettings.addEventListener('submit', function(event) {
    uploadWarning.classList.add('d-none');
  });

  // Credit Card Input Formatting
  const cardNumberInput = document.getElementById('card_number');
  cardNumberInput.addEventListener('input', function(event) {
    let value = event.target.value.replace(/\D/g, ''); // Remove non-digit characters
    let formattedValue = value.replace(/(\d{4})(?=\d)/g, '$1-'); // Add hyphens
    event.target.value = formattedValue;
  });

  const form = document.getElementById('creditCardForm');
  form.addEventListener('submit', function(event) {
    cardNumberInput.value = cardNumberInput.value.replace(/\D/g, ''); // Remove hyphens before submitting
  });

  // Popover for card removal confirmation
  const removeCardButtons = document.querySelectorAll('.remove-card-btn');
  removeCardButtons.forEach(button => {
    button.addEventListener('click', function(event) {
      event.preventDefault();
      const cardId = button.getAttribute('data-card-id');
      Swal.fire({
        title: 'Are you sure?',
        text: 'Once you remove the card, we will irreversibly delete your card from our system. Please approach this action with caution.',
        icon: 'warning',
        confirmButtonText: 'Remove Card',
        showCancelButton: true,
        customClass: {
          confirmButton: 'btn btn-danger me-2 waves-effect waves-light',
          cancelButton: 'btn btn-label-secondary waves-effect waves-light'
        },
      }).then((result) => {
        if (result.isConfirmed) {
          document.getElementById(`removeCardForm-${cardId}`).submit();
        }
      });
    });
  });
});
</script>

{% endblock %}
