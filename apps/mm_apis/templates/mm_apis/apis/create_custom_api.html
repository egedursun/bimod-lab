<!--
~ Copyright (c) 2024 BMD™ Autonomous Holdings. All rights reserved.
~
~ Project: Bimod.io™
~ File: create_custom_api.html
~ Last Modified: 2024-10-05 01:39:48
~ Author: Ege Dogan Dursun (Co-Founder & Chief Executive Officer / CEO @ BMD™ Autonomous Holdings)
~ Created: 2024-10-05 14:42:33
~
~ This software is proprietary and confidential. Unauthorized copying,
~ distribution, modification, or use of this software, whether for
~ commercial, academic, or any other purpose, is strictly prohibited
~ without the prior express written permission of BMD™ Autonomous
~ Holdings.
~
~  For permission inquiries, please contact: admin@Bimod.io.
~
-->

{% extends layout_path %}

{% load static %}
{% load i18n %}
{% load field_to_label %}

{% block title %}Create Custom API{% endblock %}

{% block vendor_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/libs/flatpickr/flatpickr.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/material.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/cleavejs/cleave.js' %}"></script>
  <script src="{% static 'vendor/libs/cleavejs/cleave-phone.js' %}"></script>
  <script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
  <script src="{% static 'vendor/libs/flatpickr/flatpickr.js' %}"></script>
  <script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock vendor_js %}

{% block page_js %}
  {{ block.super }}
  <script src="{% static 'js/form-layouts.js' %}"></script>
{% endblock page_js %}

{% block content %}
  <!-- Basic Layout -->
  <div class="row">
    <div class="col-xl mb-6">
      <div class="card">
        <div class="card-datatable table-responsive">
          <a href="{% url 'mm_apis:list' %}">
            <button class="btn btn-secondary ms-4 mt-4 mb-8">
              <i class="fa fa-dashboard me-4"></i>
              <strong> Manage Custom APIs</strong>
            </button>
          </a>
        </div>
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <strong>Create New Custom API</strong>
          </h5>
          <small class="text-muted float-end"></small>
        </div>
        <div class="card-body">
          <div class="tips-section alert alert-secondary alert-dismissible d-flex col-lg-12 align-items-center"
               role="alert">
            <img src="{% static 'img/custom-illustrations-v2/i2-77.png' %}" width="25%" style="border-radius: 25px;"
                 class="justify-content-end me-8" alt="Illustration for tip">
            <span class="alert-icon rounded">
            <i class="ti ti-bookmark"></i>
          </span>
            <div class="d-flex flex-column ps-1">
              <h5 class="alert-heading mb-2">Tip</h5>
              <p class="mb-0">
                In this page, you can create a new custom API. Fill out the form fields and click on the "Create" button
                to create the custom API. You can also share the API in the API store by checking the "Share in API
                Store" checkbox.
              </p>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
              </button>
            </div>
          </div>
          {% if messages %}
            {% for message in messages %}
              <div
                class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-danger{% endif %}"
                role="alert">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row p-8">
              <div class="mb-6 col-6">
                <label class="form-label" for="name">Name</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="Enter API name" required />
              </div>
              <div class="mb-6 col-6">
                <label class="form-label" for="description">Description</label>
                <textarea class="form-control" id="description" name="description" placeholder="Enter API description"
                          rows="1"
                          required></textarea>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="api_picture">Thumbnail Image</label>
                <input type="file" class="form-control" id="api_picture" name="api_picture" />
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="authentication_type">Authentication Type</label>
                <select name="authentication_type" class="form-select">
                  {% for value, label in CUSTOM_API_AUTHENTICATION_TYPES %}
                    <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="authentication_token">Authentication Token</label>
                <input type="text" class="form-control" id="authentication_token" name="authentication_token"
                       placeholder="Enter authentication token" />
              </div>
              <div class="mb-6 col-3">
                <label class="form-label" for="base_url">Base URL</label>
                <input type="text" class="form-control" id="base_url" name="base_url" placeholder="Enter base URL"
                       required />
              </div>
              <div class="mb-6 col-12" style="overflow-x: scroll;">
                <label class="form-label" for="endpoints">Endpoints</label>
                <table id="endpointsTable" class="table table-bordered">
                  <thead>
                  <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Path</th>
                    <th>Method</th>
                    <th>Header Params</th>
                    <th>Path Params</th>
                    <th>Query Params</th>
                    <th>Body Params</th>
                    <th></th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr data-endpoint-index="0">
                    <td style="min-width: 240px;"><input type="text" name="endpoints[0][name]"
                                                         placeholder="Enter endpoint name" class="form-control"></td>
                    <td style="min-width: 240px;"><input type="text" name="endpoints[0][description]"
                                                         placeholder="Enter description" class="form-control"></td>
                    <td style="min-width: 240px;"><input type="text" name="endpoints[0][path]" placeholder="Enter path"
                                                         class="form-control"></td>
                    <td style="min-width: 180px;">
                      <select name="endpoints[0][method]" class="form-select">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                      </select>
                    </td>
                    <td>
                      <div class="paramsContainer" style="min-width: 240px;">
                        <div class="paramRow">
                          <input type="text" name="endpoints[0][header_params][]" placeholder="Header name"
                                 class="form-control w-100">
                          <button type="button" class="btn btn-sm btn-danger w-100 mt-1 mb-2"
                                  onclick="removeParam(this)">
                            <i class="fa fa-trash"></i>
                          </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary w-100"
                                onclick="addParam(this, 'header_params', 0)">
                          <strong>Add Header Param</strong>
                        </button>
                      </div>
                    </td>
                    <td>
                      <div class="paramsContainer" style="min-width: 240px;">
                        <div class="paramRow">
                          <input type="text" name="endpoints[0][path_params][]" placeholder="Path parameter name"
                                 class="form-control w-100">
                          <button type="button" class="btn btn-sm btn-danger w-100 mt-1 mb-2"
                                  onclick="removeParam(this)">
                            <i class="fa fa-trash"></i>
                          </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary w-100"
                                onclick="addParam(this, 'path_params', 0)">
                          <strong>Add Path Parameter</strong>
                        </button>
                      </div>
                    </td>
                    <td>
                      <div class="paramsContainer" style="min-width: 240px;">
                        <div class="paramRow">
                          <input type="text" name="endpoints[0][query_params][]" placeholder="Query parameter name"
                                 class="form-control w-100">
                          <button type="button" class="btn btn-sm btn-danger w-100 mt-1 mb-2"
                                  onclick="removeParam(this)">
                            <i class="fa fa-trash"></i>
                          </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary w-100"
                                onclick="addParam(this, 'query_params', 0)">
                          <strong>Add Query Parameter</strong>
                        </button>
                      </div>
                    </td>
                    <td>
                      <div class="paramsContainer" style="min-width: 240px;">
                        <div class="paramRow">
                          <input type="text" name="endpoints[0][body_params][]" placeholder="Body parameter name"
                                 class="form-control w-100">
                          <button type="button" class="btn btn-sm btn-danger w-100 mt-1 mb-2"
                                  onclick="removeParam(this)">
                            <i class="fa fa-trash"></i>
                          </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary w-100"
                                onclick="addParam(this, 'body_params', 0)">
                          <strong>Add Body Parameter</strong>
                        </button>
                      </div>
                    </td>
                    <td>
                      <button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i
                        class="fa fa-remove"></i></button>
                    </td>
                  </tr>
                  </tbody>
                </table>
                <button type="button" onclick="addEndpointRow('endpointsTable')"
                        class="btn btn-success d-grid w-20 mt-4 mb-4"><strong>
                  <i class="fa fa-plus me-4"></i>
                  Add New Endpoint</strong></button>
              </div>
              <div class="mb-6 col-8">
                <label class="form-label" for="categories">Categories</label>
                <div id="categories" class="form-control overflow-auto" style="max-height: 200px;">
                  {% for value, label in CUSTOM_API_CATEGORIES %}
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input category-checkbox" name="categories"
                             value="{{ value }}" id="category-{{ value }}">
                      <label class="form-check-label" for="category-{{ value }}">{{ label }}</label>
                    </div>
                  {% endfor %}
                </div>
                <small id="categoryLimitAlert" class="text-danger" style="display: none;">You can select up to 5
                  categories.</small>
              </div>
              <div class="mb-6 col-4 form-check bg-label-primary p-4 rounded mt-6 border border-1 border-primary">
                <input type="checkbox" class="form-check-input ms-4 mt-4" id="is_public" name="is_public">
                <label class="form-check-label ms-4 mt-6" for="is_public">
                  <strong>Share in API Store</strong>
                  <br>
                  <small>
                    <i class="fa fa-info-circle me-2 mt-4"></i> For your contribution to the community, if you choose to
                    share your API in the public store, there will be a 50% discount on your requests for this API.
                  </small>
                </label>
              </div>
            </div>
            <hr>
            <input type="hidden" name="created_by_user" value="{{ request.user.id }}">
            <button type="submit" class="btn btn-primary d-grid mt-4 w-25"><strong>
              <strong>
                <i class="fa fa-plus me-4"></i>
                Create Custom API</strong>
            </strong></button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    let endpointCount = 1;

    function addEndpointRow(tableId) {
      const tableBody = document.querySelector(`#${tableId} tbody`);
      const newRow = `
      <tr data-endpoint-index="${endpointCount}">
        <td style="min-width: 240px;"><input type="text" name="endpoints[${endpointCount}][name]" placeholder="Enter endpoint name" class="form-control"></td>
        <td style="min-width: 240px;"><input type="text" name="endpoints[${endpointCount}][description]" placeholder="Enter description" class="form-control"></td>
        <td style="min-width: 240px;"><input type="text" name="endpoints[${endpointCount}][path]" placeholder="Enter path" class="form-control"></td>
        <td style="min-width: 180px;">
          <select name="endpoints[${endpointCount}][method]" class="form-select">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
            <option value="PATCH">PATCH</option>
          </select>
        </td>
        <td>
          <div class="paramsContainer">
            <div class="paramRow">
               <input type="text" name="endpoints[${endpointCount}][header_params][]" placeholder="Header name" class="form-control w-100" style="min-width: 240px;">
               <button type="button" class="btn btn-sm btn-danger w-100 mt-1 mb-2" onclick="removeParam(this)">
                 <i class="fa fa-trash"></i>
               </button>
            </div>
            <button type="button"  class="btn btn-sm btn-primary w-100" onclick="addParam(this, 'header_params', ${endpointCount})">
               <strong>Add Header Param</strong>
            </button>
          </div>
        </td>
        <td>
          <div class="paramsContainer">
            <div class="paramRow">
              <input type="text" name="endpoints[${endpointCount}][path_params][]" placeholder="Path parameter name" class="form-control w-100" style="min-width: 240px;">
              <button type="button" class="btn btn-sm btn-danger w-100 mt-1 mb-2" onclick="removeParam(this)">
                 <i class="fa fa-trash"></i>
              </button>
            </div>
            <button type="button" class="btn btn-sm btn-primary w-100" onclick="addParam(this, 'path_params', ${endpointCount})">
                <strong>Add Path Parameter</strong>
            </button>
          </div>
        </td>
        <td>
          <div class="paramsContainer">
            <div class="paramRow">
                <input type="text" name="endpoints[${endpointCount}][query_params][]" placeholder="Query parameter name" class="form-control w-100" style="min-width: 240px;">
                <button type="button" class="btn btn-sm btn-danger w-100 mt-1 mb-2" onclick="removeParam(this)">
                  <i class="fa fa-trash"></i>
                </button>
            </div>
            <button type="button" class="btn btn-sm btn-primary w-100" onclick="addParam(this, 'query_params', ${endpointCount})">
                <strong>Add Query Parameter</strong>
            </button>
          </div>
        </td>
        <td>
          <div class="paramsContainer">
            <div class="paramRow">
                <input type="text" name="endpoints[${endpointCount}][body_params][]" placeholder="Enter body param" class="form-control w-100" style="min-width: 240px;">
                <button type="button" class="btn btn-sm btn-danger w-100 mt-1 mb-2" onclick="removeParam(this)">
                  <i class="fa fa-trash"></i>
                </button></div>
            <button type="button" class="btn btn-sm btn-primary w-100" onclick="addParam(this, 'body_params', ${endpointCount})">
                <strong>Add Body Parameter</strong>
            </button>
          </div>
        </td>
        <td><button class="btn bg-label-danger" type="button" onclick="removeRow(this)"><i class="fa fa-remove"></i></button></td>
      </tr>
    `;
      tableBody.insertAdjacentHTML('beforeend', newRow);
      endpointCount++;
    }

    function addParam(button, paramType, index) {
      const container = button.closest('.paramsContainer');
      const newParam = `
            <div class="paramRow">
                <input type="text" name="endpoints[${index}][${paramType}][]" placeholder="Enter new name" class="form-control w-100 mt-2">
                <button type="button" class="btn btn-sm btn-danger w-100 mt-1 mb-2" onclick="removeParam(this)">
                    <i class="fa fa-trash"></i>
                </button>
            </div>`;
      container.insertAdjacentHTML('beforeend', newParam);
    }

    function removeParam(button) {
      const paramRow = button.closest('.paramRow');
      paramRow.remove();
    }

    function removeRow(button) {
      const row = button.closest('tr');
      row.remove();
    }

    document.addEventListener('DOMContentLoaded', function() {
      const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
      const maxCategories = 5;
      const categoryLimitAlert = document.getElementById('categoryLimitAlert');

      categoryCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const checkedCheckboxes = document.querySelectorAll('.category-checkbox:checked');
          if (checkedCheckboxes.length > maxCategories) {
            this.checked = false;
            categoryLimitAlert.style.display = 'block';
          } else {
            categoryLimitAlert.style.display = 'none';
          }
        });
      });
    });
  </script>

{% endblock %}
