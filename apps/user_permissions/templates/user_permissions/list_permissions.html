{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Permissions List{% endblock %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-bs5/datatables.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/@form-validation/form-validation.css' %}" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.7.2/font/bootstrap-icons.min.css">
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/datatables-bs5/datatables-bootstrap5.js' %}"></script>
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
<script src="{% static 'vendor/libs/@form-validation/popular.js' %}"></script>
<script src="{% static 'vendor/libs/@form-validation/bootstrap5.js' %}"></script>
<script src="{% static 'vendor/libs/@form-validation/auto-focus.js' %}"></script>
<script src="{% static 'vendor/libs/cleavejs/cleave.js' %}"></script>
<script src="{% static 'vendor/libs/cleavejs/cleave-phone.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
{{ block.super }}
<script src="{% static 'js/app-permissions-list.js' %}"></script>
{% endblock page_js %}

{% block content %}
<div class="row g-6 mb-6">
  <div class="col-sm-6 col-xl-4">
    <h3 class="mb-0">Permissions Management</h3>
  </div>
</div>

{% for organization, data in org_users_permissions.items %}
  <div class="card mb-6">
    <div class="card-header border-bottom mb-10">
      <h4>{{ organization.name }}</h4>
    </div>
    <div class="card-body">
      {% for user, permissions in data.users.items %}
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <a class="collapsed" data-bs-toggle="collapse" href="#collapse-{{ user.id }}" role="button" aria-expanded="false" aria-controls="collapse-{{ user.id }}">
                <strong>{{ user.username }}</strong>
              </a>
            </h6>
            <i class="fa fa-edit toggle-icon" data-target="#collapse-{{ user.id }}"></i>
          </div>
          <div id="collapse-{{ user.id }}" class="collapse">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table">
                  <thead class="border-top">
                    <tr>
                      <th>Permission</th>
                      <th>Active</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for permission in permissions %}
                      <tr>
                        <td>{{ permission.get_permission_type_name }}</td>
                        <td>
                          <form method="post" action="{% url 'user_permissions:list_permissions' %}">
                            {% csrf_token %}
                            <input type="hidden" name="permission_id" value="{{ permission.id }}">
                            <input type="hidden" name="action" value="toggle_active">
                            <input type="checkbox" name="is_active" {% if permission.is_active %}checked{% endif %} onchange="this.form.submit();">
                          </form>
                        </td>
                        <td>
                          <form method="post" action="{% url 'user_permissions:list_permissions' %}">
                            {% csrf_token %}
                            <input type="hidden" name="permission_id" value="{{ permission.id }}">
                            <input type="hidden" name="action" value="delete">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                          </form>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endfor %}

<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('.toggle-icon').forEach(function(icon) {
    icon.addEventListener('click', function() {
      var target = document.querySelector(this.getAttribute('data-target'));
      var bootstrapCollapse = new bootstrap.Collapse(target, {
        toggle: false
      });
      if (target.classList.contains('show')) {
        bootstrapCollapse.hide();
      } else {
        bootstrapCollapse.show();
      }
    });
  });

  document.querySelectorAll('.collapse').forEach(function(collapse) {
    collapse.addEventListener('show.bs.collapse', function() {
      var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
      if (icon) {
        icon.classList.remove('fa-edit');
        icon.classList.add('bi-chevron-up');
      }
    });

    collapse.addEventListener('hide.bs.collapse', function() {
      var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
      if (icon) {
        icon.classList.remove('bi-chevron-up');
        icon.classList.add('fa-edit');
      }
    });
  });
});
</script>

{% endblock %}
