{% extends layout_path %}
{% load static %}
{% load i18n %}

{% block title %}Manage Permissions{% endblock %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-bs5/datatables.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/@form-validation/form-validation.css' %}" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.7.2/font/bootstrap-icons.min.css">
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/datatables-bs5/datatables-bootstrap5.js' %}"></script>
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
<script src="{% static 'vendor/libs/@form-validation/popular.js' %}"></script>
<script src="{% static 'vendor/libs/@form-validation/bootstrap5.js' %}"></script>
<script src="{% static 'vendor/libs/@form-validation/auto-focus.js' %}"></script>
<script src="{% static 'vendor/libs/cleavejs/cleave.js' %}"></script>
<script src="{% static 'vendor/libs/cleavejs/cleave-phone.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
{{ block.super }}
<script src="{% static 'js/app-permissions-list.js' %}"></script>
{% endblock page_js %}

{% block content %}
<div class="row g-6 mb-6">
  <div class="col-sm-6 col-xl-4">
    <h3 class="mb-0">Permission Management</h3>
  </div>
</div>

<div class="alert alert-secondary alert-dismissible d-flex col-lg-10 align-items-center" role="alert">
        <img src="{% static 'img/custom-illustrations/boy-power.png' %}" width="25%" class="justify-content-end">
        <span class="alert-icon rounded">
          <i class="ti ti-bookmark"></i>
        </span>
        <div class="d-flex flex-column ps-1">
          <h5 class="alert-heading mb-2">Tip</h5>
          <p class="mb-0">
            In this page, you can view all the permissions of the organizations you have created. You can also edit or
            delete any permission that belongs to you as an administrator. To create a new permission, click on the
            "Create Permission" button, which is located in the tab on the left side of your screen. Inactivating
            user permissions will not remove the permission from the system, but it will prevent the user from using
            the permission. Keep in mind that if you delete a permission, it will be removed from the system entirely.
          </p>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
          </button>
        </div>
      </div>

{% for organization, data in org_users_permissions.items %}
  <div class="card mb-6">
    <div class="card-header border-bottom mb-10">
      <a class="collapsed" data-bs-toggle="collapse" href="#collapse-{{ organization.id }}" role="button" aria-expanded="false" aria-controls="collapse-{{ organization.id }}">
        <h4>
          {{ organization.name }}
        </h4>
      </a>
      <p>
        <i class="fa fa-user-astronaut"></i>
        <strong>&nbsp; Number of Users: </strong> {{ data.users|length }}
      </p>
      <i class="fa fa-arrow-alt-circle-down toggle-icon" data-target="#collapse-{{ organization.id }}"></i>
      <span data-bs-toggle="collapse" href="#collapse-{{ organization.id }}" role="button" aria-expanded="false" aria-controls="collapse-{{ organization.id }}">
        <strong>&nbsp; See Users of Organization &amp; Permissions</strong>
      </span>
    </div>
    <div id="collapse-{{ organization.id }}" class="card-body collapse">
      {% for user, permissions in data.users.items %}
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <a class="collapsed" data-bs-toggle="collapse" href="#collapse-{{ user.id }}" role="button" aria-expanded="false" aria-controls="collapse-{{ user.id }}">
                <strong>{{ user.username }}</strong>
              </a>
              <br>
              <a class="collapsed" data-bs-toggle="collapse">
                <strong>{{ user.profile.first_name }} {{ user.profile.last_name }}</strong>
              </a>
              <br>
              <a class="collapsed" data-bs-toggle="collapse">
                <strong>{{ user.email }}</strong>
              </a>
              <a class="collapsed" data-bs-toggle="collapse">
                <div>
                  <p>
                    <br>
                    <i class="fa fa-key toggle-icon"></i>
                    <strong>Number of Permissions: {{ permissions|length }}</strong>
                    <br>
                    <span data-bs-toggle="collapse" href="#collapse-{{ user.id }}" role="button" aria-expanded="false" aria-controls="collapse-{{ user.id }}">
                      <strong>See &amp; Manage Permissions</strong>
                    </span>
                    <i class="fa fa-arrow-alt-circle-down toggle-icon mt-5" data-target="#collapse-{{ user.id }}"></i>
                  </p>
                </div>
              </a>
            </h6>
            <i class="fa fa-arrow-alt-circle-down toggle-icon" data-target="#collapse-{{ user.id }}"></i>
          </div>
          <div id="collapse-{{ user.id }}" class="collapse">
            <div class="card-body">
              <div class="card-datatable table-responsive">
                <a href="{% url 'user_permissions:add_permissions' %}">
                  <button class="btn btn-success mt-4">
                    <i class="fa fa-add me-4"></i>
                    <strong> Add Permission to User</strong>
                  </button>
                </a>
              </div>
              <div class="table-responsive">
                <form method="post" action="{% url 'user_permissions:list_permissions' %}">
                  {% csrf_token %}
                  <input type="hidden" name="user_id" value="{{ user.id }}">
                  <table class="table">
                    <thead class="border-top">
                      <tr>
                        <th>Permission</th>
                        <th>Activate / Deactivate Permission</th>
                        <th>Delete Permission</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for permission in permissions %}
                        <tr>
                          <td>{{ permission.get_permission_type_name }}</td>
                          <td>
                            <input type="checkbox" name="permissions" value="{{ permission.id }}" {% if permission.is_active %}checked{% endif %}>
                          </td>
                          <td>
                            <input type="checkbox" name="delete_requests" value="{{ permission.id }}">
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                  <div class="alert alert-solid-warning d-flex align-items-center mt-6" role="alert">
                    <span class="alert-icon rounded">
                      <i class="ti ti-alert-circle"></i>
                    </span>
                    <strong>IMPORTANT WARNING: </strong> &nbsp; If you don't click the update button, your changes will not be saved when you leave or refresh this page.
                  </div>
                  <button type="submit" class="btn btn-primary col-lg-4">Update User Permissions</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endfor %}

<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('.toggle-icon').forEach(function(icon) {
    icon.addEventListener('click', function() {
      var target = document.querySelector(this.getAttribute('data-target'));
      var bootstrapCollapse = new bootstrap.Collapse(target, {
        toggle: false
      });
      if (target.classList.contains('show')) {
        bootstrapCollapse.hide();
      } else {
        bootstrapCollapse.show();
      }
    });
  });

  document.querySelectorAll('.collapse').forEach(function(collapse) {
    collapse.addEventListener('show.bs.collapse', function() {
      var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
      if (icon) {
        icon.classList.remove('fa-arrow-alt-circle-down');
        icon.classList.add('fa-arrow-alt-circle-up');
      }
    });

    collapse.addEventListener('hide.bs.collapse', function() {
      var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
      if (icon) {
        icon.classList.remove('fa-arrow-alt-circle-up');
        icon.classList.add('fa-arrow-alt-circle-down');
      }
    });
  });
});
</script>

{% endblock %}
