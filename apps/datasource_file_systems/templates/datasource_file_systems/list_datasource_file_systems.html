{% extends layout_path %}

{% load static %}
{% load i18n %}
{% load field_to_label %}

{% block title %}File System Connections{% endblock %}

{% block vendor_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/sweetalert2/sweetalert2.css' %}"/>
  <style>
    .text-wrap {
      white-space: normal;
      word-break: break-all;
    }
  </style>
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
  <script src="{% static 'vendor/libs/sweetalert2/sweetalert2.js' %}"></script>
{% endblock vendor_js %}

{% block content %}
  <div class="row g-6 mb-6">
    <div class="col-sm-6 col-xl-6">
      <h3 class="mb-0"><strong>File System Connections</strong></h3>
    </div>
  </div>

  <div class="tips-section alert alert-secondary alert-dismissible d-flex col-lg-12 align-items-center" role="alert">
    <img src="{% static 'img/custom-illustrations-v2/i2-54.png' %}" width="25%" style="border-radius: 25px;"
         class="justify-content-end me-8">
    <span class="alert-icon rounded">
    <i class="ti ti-bookmark"></i>
  </span>
    <div class="d-flex flex-column ps-1">
      <h5 class="alert-heading mb-2">Tip</h5>
      <p class="mb-0">
        In this page, you can manage your file system connections for your assistants. You must be aware of the fact
        that the file system connections are assistant-based. This means that the assistants will be able to use
        the file system connections that you have created here, and if you want another assistant to use the same file
        system connection, you need to create another connection for that assistant.
      </p>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  </div>

  <!-- File System Connections Cards -->
  {% for organization, assistants in connections_by_organization.items %}
    <div class="card mb-6">
      <div class="card-header border-bottom">
        <a class="collapsed" data-bs-toggle="collapse" href="#collapse-org-{{ organization.id }}" role="button"
           aria-expanded="false" aria-controls="collapse-org-{{ organization.id }}">
          <div class="d-flex">
            <img src="

              {% if organization.organization_image %}{{ organization.organization_image.url }}{% else %}{% static 'img/avatars/org-0.png' %}{% endif %}"
                 class="rounded me-4" width="60" height="60">
            <h4>
              <strong>{{ organization.name }}</strong>
            </h4>
          </div>
        </a>
        <i class="fa fa-arrow-alt-circle-down toggle-icon mt-8" data-target="#collapse-org-{{ organization.id }}"></i>
        <span data-bs-toggle="collapse" href="#collapse-org-{{ organization.id }}" role="button" aria-expanded="false"
              aria-controls="collapse-org-{{ organization.id }}">
      <strong class="mt-8">&nbsp; See File System Connections</strong>
    </span>
      </div>
      <div id="collapse-org-{{ organization.id }}" class="card-datatable table-responsive collapse">
        {% for assistant, connections in assistants.items %}
          <div class="assistant-group m-8 card card-border-shadow-primary p-4">
            <div class="d-flex">
              <img src="

                {% if assistant.assistant_image %}{{ assistant.assistant_image.url }}{% else %}{% static 'img/avatars/org-0.png' %}{% endif %}"
                   class="rounded me-4" width="80" height="80">
              <h5 class="assistant-title mt-4"><strong>{{ assistant.name }}</strong></h5>
            </div>
            <div class="card-datatable table-responsive mt-4">
              <a href="{% url 'datasource_file_systems:create' %}">
                <button class="btn btn-success mb-8">
                  <i class="fa fa-add me-4"></i>
                  <strong> Add File System Connection</strong>
                </button>
              </a>
            </div>
            <div class="row g-6 mb-2">
              {% for connection in connections %}
                <div class="col-xl-6 col-md-6">
                  <div class="card h-100">
                    <div class="card-header d-flex justify-content-between">
                      <div class="card-title mb-0">
                        <p class="card-subtitle mb-4"><strong>
                          <i class="fa fa-id-badge me-4"></i> Connection Name: &nbsp;&nbsp;</strong>
                          {{ connection.name }}
                        </p>
                        <p class="card-subtitle mb-4"><strong>
                          <i class="fa fa-desktop me-4"></i> OS Type: &nbsp;&nbsp;</strong>
                          {{ connection.get_os_type_display }}
                        </p>
                      </div>
                    </div>
                    <hr>
                    <div class="card-body mt-2">
                      <ul class="p-0 m-0">
                        <li class="mb-4 d-flex justify-content-between align-items-center">
                          <span class="text-body me-4"><strong>
                            <i class="fa fa-info-circle me-4"></i>
                            Description:
                          </strong></span>
                          <span class="text-wrap">{{ connection.description|linebreaksbr }}</span>
                        </li>
                        <li class="mb-4 d-flex justify-content-between align-items-center">
                          <span class="text-body"><strong>
                            <i class="fa fa-server me-4"></i>
                            Host:
                          </strong></span>
                          <span
                            class="text-wrap">
                            <strong class="border border-warning p-1 rounded">
                              {{ connection.host_url }}
                            </strong></span>
                        </li>
                        <li class="mb-4 d-flex justify-content-between align-items-center">
                          <span class="text-body"><strong>
                            <i class="fa fa-plug me-4"></i>
                            Port:
                          </strong></span>
                          <span
                            class="text-wrap">
                            <strong class="border border-warning p-1 rounded">
                              {{ connection.port }}
                            </strong></span>
                        </li>
                        <li class="mb-4 d-flex justify-content-between align-items-center">
                          <span class="text-body"><strong>
                            <i class="fa fa-user me-4"></i>
                            Username:
                          </strong></span>
                          <span
                            class="text-wrap">
                            <strong class="border border-info p-1 rounded">
                              {{ connection.username }}
                            </strong></span>
                        </li>
                        <li class="mb-4 d-flex justify-content-between align-items-center">
                          <span class="text-body"><strong>
                            <i class="fa fa-lock me-4"></i>
                            Read Only:
                          </strong></span>
                          <span
                            class="text-wrap border {% if connection.is_read_only %}border-success{% else %}border-danger{% endif %} rounded p-1"><strong>{{ connection.is_read_only|yesno:"Yes,No" }}</strong></span>
                        </li>
                        <li class="mb-4 d-flex justify-content-between align-items-center">
                          <span class="text-body"><strong>
                            <i class="fa fa-database me-4"></i>
                            Max Records per Retrieval:
                          </strong></span>
                          <span
                            class="text-wrap">
                            <strong class="border border-info rounded p-1">
                              {{ connection.os_read_limit_tokens }}
                            </strong></span>
                        </li>
                      </ul>
                      <hr>
                      <div class="d-flex justify-content-center">
                        <a href="{% url 'datasource_file_systems:update' connection.id %}" class="btn btn-primary me-3"><i
                          class="ti ti-edit me-2"></i><strong>Edit Connection</strong></a>
                        <a href="{% url 'datasource_file_systems:delete' connection.id %}" class="btn btn-danger"><i
                          class="ti ti-trash"></i><strong> Delete </strong></a>
                      </div>
                    </div>
                  </div>
                </div>
              {% empty %}
                <div class="alert alert-warning p-8 m-4" role="alert">
                  <div class="">
                    <i class="fa fa-exclamation-triangle me-4"></i>
                    <strong>No File System Connections have been created for this organization yet.</strong>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
          <hr>
        {% endfor %}
      </div>
    </div>
  {% endfor %}

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll('.toggle-icon').forEach(function (icon) {
        icon.addEventListener('click', function () {
          var target = document.querySelector(this.getAttribute('data-target'));
          var bootstrapCollapse = new bootstrap.Collapse(target, {
            toggle: false
          });
          if (target.classList.contains('show')) {
            bootstrapCollapse.hide();
          } else {
            bootstrapCollapse.show();
          }
        });
      });

      document.querySelectorAll('.collapse').forEach(function (collapse) {
        collapse.addEventListener('show.bs.collapse', function () {
          var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
          if (icon) {
            icon.classList.remove('fa-arrow-alt-circle-down');
            icon.classList.add('fa-arrow-alt-circle-up');
          }
        });

        collapse.addEventListener('hide.bs.collapse', function () {
          var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
          if (icon) {
            icon.classList.remove('fa-arrow-alt-circle-up');
            icon.classList.add('fa-arrow-alt-circle-down');
          }
        });
      });

      document.querySelectorAll('.btn-danger').forEach(function (button) {
        button.addEventListener('click', function (event) {
          event.preventDefault();
          const form = button.closest('a').getAttribute('href');

          Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this action.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            customClass: {
              confirmButton: 'btn btn-danger me-2 waves-effect waves-light',
              cancelButton: 'btn btn-label-secondary waves-effect waves-light'
            },
            buttonsStyling: false
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = form;
            }
          });
        });
      });
    });
  </script>

{% endblock %}
