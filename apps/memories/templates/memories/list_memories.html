{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}List Assistant Memories{% endblock %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-bs5/datatables.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/@form-validation/form-validation.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/datatables-bs5/datatables-bootstrap5.js' %}"></script>
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
<script src="{% static 'vendor/libs/@form-validation/popular.js' %}"></script>
<script src="{% static 'vendor/libs/@form-validation/bootstrap5.js' %}"></script>
<script src="{% static 'vendor/libs/@form-validation/auto-focus.js' %}"></script>
<script src="{% static 'vendor/libs/cleavejs/cleave.js' %}"></script>
<script src="{% static 'vendor/libs/cleavejs/cleave-phone.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
{{ block.super }}
<script src="{% static 'js/app-assistants-list.js' %}"></script>
{% endblock page_js %}

{% block content %}
<div class="row g-6 mb-6">
  <div class="col-sm-6 col-xl-4">
    <h3 class="mb-0">Assistant Memories</h3>
  </div>
</div>

<div class="alert alert-secondary alert-dismissible d-flex col-lg-10 align-items-center" role="alert">
  <img src="{% static 'img/custom-illustrations/boy-core-list.png' %}" width="25%" class="justify-content-end">
  <span class="alert-icon rounded ms-4">
    <i class="ti ti-bookmark"></i>
  </span>
  <div class="d-flex flex-column ps-1">
    <h5 class="alert-heading mb-2">Tip</h5>
    <p class="mb-0">
      In this page, you can view all the memories of the assistants of the organizations you have created. You can also
      delete any memory that belongs to you as an administrator. To create a new memory, click on the "Create Memory"
      button, which is located in the tab on the left side of your screen. The user-specific memory is a memory that is
      specific to a user, in which the memory will only be accessible for the chats of that user. The assistant-specific
      memory is a memory that is specific to the assistant, in which the memory will be accessible for all the chats of
      the assistant, independent of the user.
    </p>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
    </button>
  </div>
</div>

{% for organization, memories in org_assistants.items %}
<!-- Organization's Memories List Table -->
<div class="card mb-6">
  <div class="card-header border-bottom">
    <a class="collapsed" data-bs-toggle="collapse" href="#collapse-{{ organization.id }}" role="button" aria-expanded="false" aria-controls="collapse-{{ organization.id }}">
      <h4>
        {{ organization.name }}
      </h4>
    </a>
    <p>
      <i class="fa fa-robot"></i>
      <strong>&nbsp; Number of Memories: </strong> {{ memories|length }}
    </p>
    <i class="fa fa-arrow-alt-circle-down toggle-icon" data-target="#collapse-{{ organization.id }}"></i>
    <span data-bs-toggle="collapse" href="#collapse-{{ organization.id }}" role="button" aria-expanded="false" aria-controls="collapse-{{ organization.id }}">
      <strong>&nbsp; See Memories of Organization</strong>
    </span>
  </div>
  <div id="collapse-{{ organization.id }}" class="card-datatable table-responsive collapse">
    <table class="datatables-memories table">
      <thead class="border-top">
        <tr>
          <th></th>
          <th>Assistant</th>
          <th>Creator</th>
          <th>Memory Type</th>
          <th>Memory Content</th>
          <th>Created At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for memory in memories %}
          <tr>
            <td>
               <img class="rounded" src="{{ memory.assistant.assistant_image.url }}" alt="Assistant Image" width="50">
            </td>
            <td>{{ memory.assistant.name }}</td>
            <td>{{ memory.user.username }}</td>
            <td>
              {% if memory.get_memory_type_display == "User-Specific" %}
                <span class="card p-1 card-border-shadow bg-label-danger"><strong>{{ memory.get_memory_type_display }}</strong></span>
              {% else %}
                <span class="card p-1 card-border-shadow bg-label-info"><strong>{{ memory.get_memory_type_display }}</strong></span>
              {% endif %}
            </td>
            <td>{{ memory.memory_text_content }}</td>
            <td>{{ memory.created_at }}</td>
            <td>
              <a href="{% url 'memories:delete' memory.id %}" class="btn btn-sm btn-danger">Delete Memory</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endfor %}

<script>
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.toggle-icon').forEach(function(icon) {
      icon.addEventListener('click', function() {
        var target = document.querySelector(this.getAttribute('data-target'));
        var bootstrapCollapse = new bootstrap.Collapse(target, {
          toggle: false
        });
        if (target.classList.contains('show')) {
          bootstrapCollapse.hide();
        } else {
          bootstrapCollapse.show();
        }
      });
    });

    document.querySelectorAll('.collapse').forEach(function(collapse) {
      collapse.addEventListener('show.bs.collapse', function() {
        var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
        if (icon) {
          icon.classList.remove('fa-arrow-alt-circle-down');
          icon.classList.add('fa-arrow-alt-circle-up');
        }
      });

      collapse.addEventListener('hide.bs.collapse', function() {
        var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
        if (icon) {
          icon.classList.remove('fa-arrow-alt-circle-up');
          icon.classList.add('fa-arrow-alt-circle-down');
        }
      });
    });
  });
</script>

{% endblock %}
