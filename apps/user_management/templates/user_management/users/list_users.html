<!--
~ Copyright (c) 2024 BMD™ Autonomous Holdings. All rights reserved.
~
~ Project: Bimod.io™
~ File: list_users.html
~ Last Modified: 2024-10-05 01:39:48
~ Author: Ege Dogan Dursun (Co-Founder & Chief Executive Officer / CEO @ BMD™ Autonomous Holdings)
~ Created: 2024-10-05 14:42:43
~
~ This software is proprietary and confidential. Unauthorized copying,
~ distribution, modification, or use of this software, whether for
~ commercial, academic, or any other purpose, is strictly prohibited
~ without the prior express written permission of BMD™ Autonomous
~ Holdings.
~
~  For permission inquiries, please contact: admin@Bimod.io.
~
-->

{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Users{% endblock %}

{% block vendor_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-bs5/datatables.bootstrap5.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/@form-validation/form-validation.css' %}" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.7.2/font/bootstrap-icons.min.css">
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
  <script src="{% static 'vendor/libs/datatables-bs5/datatables-bootstrap5.js' %}"></script>
  <script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
  <script src="{% static 'vendor/libs/@form-validation/popular.js' %}"></script>
  <script src="{% static 'vendor/libs/@form-validation/bootstrap5.js' %}"></script>
  <script src="{% static 'vendor/libs/@form-validation/auto-focus.js' %}"></script>
  <script src="{% static 'vendor/libs/cleavejs/cleave.js' %}"></script>
  <script src="{% static 'vendor/libs/cleavejs/cleave-phone.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
  {{ block.super }}
  <script src="{% static 'js/app-user-list.js' %}"></script>
{% endblock page_js %}

{% block content %}
  <div class="row g-6 mb-6">
    <div class="col-sm-6 col-xl-4">
      <h3 class="mb-0"><strong>User Management</strong></h3>
    </div>
  </div>

  <div class="tips-section alert alert-secondary alert-dismissible d-flex col-lg-12 align-items-center" role="alert">
    <img src="{% static 'img/custom-illustrations-v2/i2-33.png' %}" width="25%" style="border-radius:25px;"
         class="justify-content-end me-8" alt="Illustration for tip">
    <span class="alert-icon rounded">
    <i class="ti ti-bookmark"></i>
  </span>
    <div class="d-flex flex-column ps-1">
      <h5 class="alert-heading mb-2">Tip</h5>
      <p class="mb-0">
        In this page, you can view all the users of the organizations you have created. You can also edit or
        delete any user that belongs to you as an administrator. To create a new user, click on the
        "Add New User" button, which is located in the tab on the left side of your screen. Keep in mind that
        dissociating a user from an organization will only remove the user from that organization, not from the system.
        However, if you delete a user from his/her only organization, the user will be deleted from the system entirely.
      </p>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
      </button>
    </div>
  </div>

  <hr>

  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %}"
           role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- Search Form -->
  <div class="row g-4 mt-4 mb-4 card card-border-shadow-primary p-4">
    <div class="col-xl-12">
      <h6 class="text-muted"><strong>Search Users</strong></h6>
      <div class="card text-center mb-4">
        <div class="card-header">
          <div class="nav-align-top">
            <form method="get" action=".">
              <div class="input-group mb-3">
                <input type="text" name="search" value="{{ request.GET.search }}" class="form-control"
                       placeholder="Search by username, email, first name, or last name">
                <button type="submit" class="btn btn-primary"><strong>Search</strong></button>
                <a href="." class="btn btn-secondary"><strong>Clear</strong></a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% for organization, user_data in org_users.items %}
    <div class="card mb-6">
      <div class="card-header border-bottom">
        <a class="collapsed" data-bs-toggle="collapse" href="#collapse-{{ organization.id }}" role="button"
           aria-expanded="false" aria-controls="collapse-{{ organization.id }}">
          <div class="d-flex">
            <img src="


              {% if organization.organization_image %}{{ organization.organization_image.url }}{% else %}{% static 'img/avatars/org-0.png' %}{% endif %}"
                 class="rounded" width="60" height="60" alt="Organization Image">
            <h4><strong class="ms-4">{{ organization.name }}</strong></h4>
          </div>
        </a>
        <p class="mt-4">
          <i class="fa fa-user-astronaut"></i>
          <strong>&nbsp;Total Users: </strong> {{ user_data.page_obj.paginator.count }}
        </p>
        <i class="fa fa-arrow-alt-circle-down toggle-icon" data-target="#collapse-{{ organization.id }}"></i>
        <span data-bs-toggle="collapse" href="#collapse-{{ organization.id }}" role="button" aria-expanded="false"
              aria-controls="collapse-{{ organization.id }}">
        <strong>&nbsp; See Users of this Organization</strong>
      </span>
      </div>
      <div id="collapse-{{ organization.id }}" class="card-datatable table-responsive collapse p-8">
        <div class="card-datatable table-responsive">
          <a href="{% url 'user_management:add' %}">
            <button class="btn btn-success mt-4 ms-4">
              <i class="fa fa-add me-4"></i>
              <strong> Invite New User</strong>
            </button>
          </a>
          <a href="{% url 'user_management:add_user_to_organization' %}">
            <button class="btn btn-info mt-4 ms-4">
              <i class="fa fa-chain me-4"></i>
              <strong> Add Existing User to Organization</strong>
            </button>
          </a>
        </div>
        <table class="datatables-users-management table">
          <thead class="border-top">
          <tr>
            <th></th>
            <th style="min-width: 150px; max-width: 150px;">Username</th>
            <th style="min-width: 150px; max-width: 150px;">Added by</th>
            <th style="min-width: 200px; max-width: 200px;">Email</th>
            <th style="min-width: 200px; max-width: 200px;">First Name</th>
            <th style="min-width: 200px; max-width: 200px;">Last Name</th>
            <th style="min-width: 150px; max-width: 150px;">Phone Number</th>
            <th style="min-width: 250px; max-width: 250px;">Address</th>
            <th style="min-width: 200px; max-width: 200px;">City</th>
            <th style="min-width: 200px; max-width: 200px;">Country</th>
            <th style="min-width: 150px; max-width: 150px;">Postal Code</th>
            <th style="min-width: 100px; max-width: 100px;">Is Active</th>
            <th style="min-width: 100px; max-width: 100px;">Verified</th>
            <th>Actions</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          {% for user, profile in user_data.user_profiles %}
            <tr>
              <td>
                {% if user.profile.profile_picture %}
                  <img src="{{ user.profile.profile_picture.url }}" class="rounded" width="60" height="60"
                       alt="User Image">
                {% else %}
                  <img src="{% static 'img/avatars/user-0.png' %}" class="rounded" width="60" height="60"
                       alt="User Image">
                {% endif %}
              </td>
              <td><strong>{{ user.username }}</strong></td>
              <td>{{ profile.created_by_user.username }}</td>
              <td><strong>{{ user.email }}</strong></td>
              <td>{{ profile.first_name }}</td>
              <td>{{ profile.last_name }}</td>
              <td>{{ profile.phone_number }}</td>
              <td style="min-width: 400px;">{{ profile.address }}</td>
              <td>{{ profile.city }}</td>
              <td>{{ profile.country }}</td>
              <td>{{ profile.postal_code }}</td>
              <td>
                {% if user.id != context_user.id %}
                  <form method="post" action="{% url 'user_management:list' %}" class="status-form">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <input type="checkbox" name="is_active" class="form-check-input status-checkbox"
                           {% if profile.is_active %}checked{% endif %} onchange="this.form.submit();">
                  </form>
                {% endif %}
              </td>
              <td>{{ profile.is_verified|yesno:"Yes,No" }}</td>
              <td style="min-width: 200px;">
                {% if user.id != context_user.id %}
                  <a href="{% url "user_management:remove_user_from_organization" user.id organization.id %}"
                     class="btn btn-sm btn-warning">
                    <strong>
                      <i class="fa fa-building"></i><i class="fa fa-user-minus me-2"></i>
                      Remove from This
                    </strong>
                  </a>
                {% else %}
                  <div class="alert-warning p-2 rounded">
                    <strong>
                      <i class="fa fa-info-circle me-2"></i>
                      Your Account
                    </strong>
                  </div>
                {% endif %}
              </td>
              <td style="min-width: 200px;">
                {% if user.id != context_user.id %}
                  <a href="{% url "user_management:remove_user_from_all_organizations" user.id %}"
                     class="btn btn-sm btn-warning">
                    <strong>
                      <i class="fa fa-city"></i><i class="fa fa-user-minus me-2"></i>
                      Remove from All
                    </strong>
                  </a>
                {% endif %}
              </td>
              <td style="min-width: 200px;">
                {% if user.id != context_user.id %}
                  <a href="{% url "user_management:remove" user.id %}" class="btn btn-sm btn-danger">
                    <strong>
                      <i class="fa fa-trash"></i><i class="fa fa-user-minus me-2"></i>
                      Delete User Account
                    </strong>
                  </a>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>

        <!-- Pagination controls -->
        <nav aria-label="Page navigation">
          <ul class="pagination pagination-rounded overflow-auto justify-content-center p-4">
            {% if user_data.page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1&search={{ user_data.search_query }}" aria-label="First">
                  <i class="bi bi-chevron-double-left"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ user_data.page_obj.previous_page_number }}&search={{ user_data.search_query }}"
                   aria-label="Previous">
                  <i class="bi bi-chevron-left"></i>
                </a>
              </li>
            {% endif %}

            {% for num in user_data.page_obj.paginator.page_range %}
              {% if user_data.page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% elif num > user_data.page_obj.number|add:'-5' and num < user_data.page_obj.number|add:'5' %}
                <li class="page-item"><a class="page-link"
                                         href="?page={{ num }}&search={{ user_data.search_query }}">{{ num }}</a></li>
              {% endif %}
            {% endfor %}

            {% if user_data.page_obj.has_next %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ user_data.page_obj.next_page_number }}&search={{ user_data.search_query }}"
                   aria-label="Next">
                  <i class="bi bi-chevron-right"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ user_data.page_obj.paginator.num_pages }}&search={{ user_data.search_query }}"
                   aria-label="Last">
                  <i class="bi bi-chevron-double-right"></i>
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
  {% endfor %}

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.toggle-icon').forEach(function(icon) {
        icon.addEventListener('click', function() {
          var target = document.querySelector(this.getAttribute('data-target'));
          var bootstrapCollapse = new bootstrap.Collapse(target, {
            toggle: false
          });
          if (target.classList.contains('show')) {
            bootstrapCollapse.hide();
          } else {
            bootstrapCollapse.show();
          }
        });
      });

      document.querySelectorAll('.collapse').forEach(function(collapse) {
        collapse.addEventListener('show.bs.collapse', function() {
          var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
          if (icon) {
            icon.classList.remove('fa-arrow-alt-circle-down');
            icon.classList.add('fa-arrow-alt-circle-up');
          }
        });

        collapse.addEventListener('hide.bs.collapse', function() {
          var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
          if (icon) {
            icon.classList.remove('fa-arrow-alt-circle-up');
            icon.classList.add('fa-arrow-alt-circle-down');
          }
        });
      });
    });
  </script>

{% endblock %}
