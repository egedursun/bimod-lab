{% extends layout_path %}
{% load custom_filters %}
{% load static %}
{% load i18n %}

{% block title %}BMDâ„¢ Autonomous Holdings - ML Model Integrations{% endblock %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
{{ block.super }}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Initialize select2 components
    $('.select').select2();

    // Search functionality
    document.getElementById('modelSearch').addEventListener('input', function () {
      const searchValue = this.value.toLowerCase();
      document.querySelectorAll('.model-card').forEach(card => {
        const title = card.querySelector('.card-title').textContent.toLowerCase();
        const description = card.querySelector('.card-text').textContent.toLowerCase();
        if (title.includes(searchValue) || description.includes(searchValue)) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    });

    // Modal trigger functionality
    document.querySelectorAll('.integrate-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const modelId = this.getAttribute('data-model-id');
        const modelName = this.getAttribute('data-model-name');
        document.getElementById('modalModelName').textContent = modelName;
        document.getElementById('modelIdInput').value = modelId;
        $('#integrationModal').modal('show');
      });
    });
  });
</script>
{% endblock page_js %}

{% block content %}
<div class="app-integration-ml-models">
  <h2><strong><i class="fa fa-plug me-4"></i>ML Model Integrations</strong></h2>
  <hr>

  <div class="tips-section alert alert-secondary alert-dismissible d-flex col-lg-12 mt-4 align-items-center" role="alert">
    <img src="{% static 'img/custom-illustrations-v2/i2-87.png' %}" width="25%" style="border-radius:25px;" class="justify-content-end me-8" alt="Illustration for tip">
    <span class="alert-icon rounded">
      <i class="ti ti-bookmark"></i>
    </span>
    <div class="d-flex flex-column ps-1">
      <h5 class="alert-heading mb-2">Tip</h5>
      <p class="mb-0">
        You can integrate your ML models with the ML Model Store to make them available for use in your applications.
        The ML Model Store provides a centralized location to store, manage, and deploy your ML models, without the
        need to manage the infrastructure.
      </p>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div
        class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-danger{% endif %}"
        role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <hr>

  <input type="search" id="modelSearch" placeholder="Search through models..." class="form-control mb-4 border border-primary border-3 rounded" style="min-height: 60px;">

  <ul class="nav nav-tabs mt-4" id="modelTabs">
    {% for category, models in category_groups.items %}
    <li class="nav-item">
      <a class="nav-link {% if forloop.first %}active{% endif %}" data-bs-toggle="tab" href="#{{ category|slugify }}" role="tab">
        <strong>{{ category }}</strong>
      </a>
    </li>
    {% endfor %}
  </ul>

  <div class="tab-content card bg-card rounded mt-4 mb-4">
    {% for category, models in category_groups.items %}
    <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="{{ category|slugify }}" role="tabpanel">
      <div class="row">
        {% for model in models %}
        <div class="col-md-3 model-card">
          <div class="card mt-3 border border-secondary-subtle rounded">
            <img src="{{ model.model_image_url }}" class="card-img-top p-4" alt="{{ model.name }}">
            <div class="card-body">
              <h5 class="card-title">
                <strong>{{ model.name }}</strong>
              </h5>
              <p class="card-text">{{ model.description }}</p>
              <button type="button" class="btn btn-primary integrate-btn w-100" data-model-id="{{ model.id }}" data-model-name="{{ model.name }}">
                <strong>
                  <i class="fa fa-plug me-2"></i>
                  Integrate
                </strong>
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Modal for Integration -->
<div class="modal fade" id="integrationModal" tabindex="-1" aria-labelledby="integrationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header btn-primary">
        <h5 class="modal-title mb-4" id="integrationModalLabel">
          <strong class="text-white">Integrate Model: <span id="modalModelName"></span></strong>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{% url 'ml_model_store:integrate' %}" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <p>Select ML Model Storage Connection</p>
          <select name="connection_id" class="form-control select" required>
            {% for connection in ml_store_connections %}
            <option value="{{ connection.id }}">{{ connection.name }}</option>
            {% endfor %}
          </select>
          <input type="hidden" id="modelIdInput" name="model_id">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <strong>
              <i class="fa fa-times me-2"></i>
              Close
            </strong>
          </button>
          <button type="submit" class="btn btn-primary">
            <strong>
              <i class="fa fa-plug me-2"></i>
              Integrate Now
            </strong>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
