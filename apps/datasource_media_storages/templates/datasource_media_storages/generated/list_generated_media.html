{% extends layout_path %}

{% load static %}
{% load i18n %}
{% load markdown_extras %}

{% block title %}Generated Media Files{% endblock %}

{% block vendor_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-bs5/datatables.bootstrap5.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/libs/sweetalert2/sweetalert2.css' %}"/>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.7.2/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/styles/default.min.css">
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
  <script src="{% static 'vendor/libs/datatables-bs5/datatables-bootstrap5.js' %}"></script>
  <script src="{% static 'vendor/libs/sweetalert2/sweetalert2.js' %}"></script>
  <script src="{% static 'vendor/libs/plyr/plyr.js' %}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
{% endblock vendor_js %}

{% block page_js %}
  {{ block.super }}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Function to store the collapsed tab state
      function storeCollapsedTabState() {
        const collapsedTabs = [];
        document.querySelectorAll('.collapse:not(.show)').forEach(collapse => {
          collapsedTabs.push(collapse.id);
        });
        localStorage.setItem('collapsedTabs', JSON.stringify(collapsedTabs));
      }

      // Function to restore the collapsed tab state
      function restoreCollapsedTabState() {
        const collapsedTabs = JSON.parse(localStorage.getItem('collapsedTabs'));
        if (collapsedTabs && Array.isArray(collapsedTabs)) {
          collapsedTabs.forEach(tabId => {
            const collapseElement = document.getElementById(tabId);
            if (collapseElement) {
              new bootstrap.Collapse(collapseElement, {
                toggle: true
              });
            }
          });
        }
      }

      // Store the collapsed tab state on collapse and expand events
      document.querySelectorAll('.collapse').forEach(collapse => {
        collapse.addEventListener('show.bs.collapse', storeCollapsedTabState);
        collapse.addEventListener('hide.bs.collapse', storeCollapsedTabState);
      });

      // Restore the collapsed tab state on page load
      restoreCollapsedTabState();

      // Toggle icon logic
      document.querySelectorAll('.toggle-icon').forEach(function (icon) {
        icon.addEventListener('click', function () {
          var target = document.querySelector(this.getAttribute('data-target'));
          var bootstrapCollapse = new bootstrap.Collapse(target, {
            toggle: true
          });
          if (target.classList.contains('show')) {
            bootstrapCollapse.hide();
            icon.classList.remove('fa-arrow-alt-circle-up');
            icon.classList.add('fa-arrow-alt-circle-down');
          } else {
            bootstrapCollapse.show();
            icon.classList.remove('fa-arrow-alt-circle-down');
            icon.classList.add('fa-arrow-alt-circle-up');
          }
        });
      });

      // Update toggle icons based on collapse state
      document.querySelectorAll('.collapse').forEach(function (collapse) {
        collapse.addEventListener('show.bs.collapse', function () {
          var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
          if (icon) {
            icon.classList.remove('fa-arrow-alt-circle-down');
            icon.classList.add('fa-arrow-alt-circle-up');
          }
        });

        collapse.addEventListener('hide.bs.collapse', function () {
          var icon = document.querySelector(`.toggle-icon[data-target="#${this.id}"]`);
          if (icon) {
            icon.classList.remove('fa-arrow-alt-circle-up');
            icon.classList.add('fa-arrow-alt-circle-down');
          }
        });
      });

      // Select all checkboxes
      document.querySelectorAll('.select-all-checkbox').forEach(function (checkbox) {
        checkbox.addEventListener('change', function () {
          const storageId = this.getAttribute('data-storage-id');
          const checkboxes = document.querySelectorAll(`.select-item-checkbox[data-storage-id="${storageId}"]`);
          checkboxes.forEach(cb => cb.checked = this.checked);
        });
      });

      // Confirmation dialog for delete buttons
      document.querySelectorAll('.delete-selected-btn, .delete-all-btn').forEach(function (button) {
        button.addEventListener('click', function (event) {
          event.preventDefault();
          const form = button.closest('form');

          Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this action.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete the documents.',
            customClass: {
              confirmButton: 'btn btn-danger me-2 waves-effect waves-light',
              cancelButton: 'btn btn-label-secondary waves-effect waves-light'
            },
            buttonsStyling: false
          }).then((result) => {
            if (result.isConfirmed) {
              form.submit();
            }
          });
        });
      });
    });
  </script>
{% endblock page_js %}

{% block content %}
  <div class="container-fluid">
    <div class="row mb-4">
      <div class="col-12">
        <h3 class="mb-0">
          <strong>Generated Media Files</strong>
        </h3>
      </div>
    </div>

    <div class="alert alert-secondary alert-dismissible d-flex col-lg-12 align-items-center" role="alert">
      <img src="{% static 'img/custom-illustrations-v2/i2-100.png' %}" width="25%" style="border-radius:25px;"
           class="justify-content-end me-8">
      <span class="alert-icon rounded">
          <i class="ti ti-bookmark"></i>
        </span>
      <div class="d-flex flex-column ps-1">
        <h5 class="alert-heading mb-2">Tip</h5>
        <p class="mb-0">
          This page displays all the generated media files by the assistants. You can view and download the generated
          media files from here. You can also view the generated media files by the assistants in the respective
          organizations. Please note that the files listed here also include the files you sent to the assistants
          through the chat interface in addition to the files that were automatically generated by the assistants.
        </p>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
        </button>
      </div>
    </div>
    {% if messages %}
      {% for message in messages %}
        <div
          class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-danger{% endif %}"
          role="alert">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
    <hr>

    {% for organization_data in data %}
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <p>
                <a data-bs-toggle="collapse" href="#collapse-org-{{ organization_data.organization.id }}" role="button"
                   aria-expanded="true" aria-controls="collapse-org-{{ organization_data.organization.id }}">
                  <div class="d-flex">
                    <img src="



                      {% if organization_data.organization.organization_image %}{{ organization_data.organization.organization_image.url }}{% else %}{% static 'img/avatars/org-0.png' %}{% endif %}"
                         class="rounded me-2" height="60" width="60">
                    <h4 class="mb-0 mt-4">
                      <strong>{{ organization_data.organization.name }}</strong>
                    </h4>
                  </div>
                  <small class="text-muted"><strong>{{ organization_data.organization.email }}</strong></small>
                </a>
              </p>
              <i class="fa fa-arrow-alt-circle-up toggle-icon mt-5"
                 data-target="#collapse-org-{{ organization_data.organization.id }}"></i>
              <span data-bs-toggle="collapse" href="#collapse-org-{{ organization_data.organization.id }}" role="button"
                    aria-expanded="true" aria-controls="collapse-org-{{ organization_data.organization.id }}">
                        <strong>&nbsp;
                          See Generated Media Files
                        </strong>
                    </span>
            </div>
            <div id="collapse-org-{{ organization_data.organization.id }}" class="card-body collapse show">
              {% for assistant_data in organization_data.assistants %}
                <div class="card mb-4">
                  <div class="card-header">
                    <div class="d-flex">
                      <img src="




                        {% if assistant_data.assistant.assistant_image %}{{ assistant_data.assistant.assistant_image.url }}{% else %}{% static 'img/avatars/org-0.png' %}{% endif %}"
                           class="rounded me-2" height="60" width="60">
                      <h4 class="mb-0 ms-4">
                        <strong>{{ assistant_data.assistant.name }}</strong>
                      </h4>
                    </div>
                  </div>
                  <div id="collapse-assistant-{{ assistant_data.assistant.id }}" class="card-body collapse show">
                    <h5><strong>Generated Images</strong></h5>
                    <div class="table-responsive mb-4">
                      <table class="table datatables-document">
                        <thead>
                        <tr>
                          <th>Preview</th>
                          <th>Chat Name</th>
                          <th>User</th>
                          <th>Output Prompt</th>
                          <th>Generated At</th>
                          <th>Download</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for item in assistant_data.messages_with_images %}
                          <tr>
                            <td>
                              <img src="{{ item.image }}" width="50" height="50" class="rounded">
                            </td>
                            <td><strong>{{ item.message.multimodal_chat.chat_name }}</strong></td>
                            <td><strong>{{ item.message.multimodal_chat.user }}</strong></td>
                            <td><strong>
                              <pre><code class="json overflow-auto rounded"
                                         style="max-width: 500px; min-width: 500px;">
                                {{ item.message.message_text_content|safe|linebreaks }}
                              </code></pre>
                            </strong></td>
                            <td>{{ item.message.sent_at }}</td>
                            <td>
                              <a href="{{ item.image }}" target="_blank" class="text-dark">
                                <i class="fa fa-download"></i>
                              </a>
                            </td>
                          </tr>
                        {% empty %}
                          <div class="card-body">
                            <div class="alert alert-warning" role="alert">
                              <i class="fa fa-exclamation-triangle me-4"></i>
                              <strong>No generated images found for this assistant.</strong>
                            </div>
                          </div>
                        {% endfor %}
                        </tbody>
                      </table>
                      <nav aria-label="Page navigation">
                        <ul class="pagination pagination-rounded overflow-auto pt-8">
                          {% if assistant_data.messages_with_images.has_previous %}
                            <li class="page-item">
                              <a class="page-link" href="?page_images=1"><i class="ti ti-chevrons-left ti-sm"></i></a>
                            </li>
                            <li class="page-item">
                              <a class="page-link"
                                 href="?page_images={{ assistant_data.messages_with_images.previous_page_number }}"><i
                                class="ti ti-chevron-left ti-sm"></i></a>
                            </li>
                          {% endif %}
                          {% for page_num in assistant_data.messages_with_images.paginator.page_range %}
                            <li
                              class="page-item {% if assistant_data.messages_with_images.number == page_num %}active{% endif %} mb-4">
                              <a class="page-link" href="?page_images={{ page_num }}">{{ page_num }}</a>
                            </li>
                          {% endfor %}
                          {% if assistant_data.messages_with_images.has_next %}
                            <li class="page-item">
                              <a class="page-link"
                                 href="?page_images={{ assistant_data.messages_with_images.next_page_number }}"><i
                                class="ti ti-chevron-right ti-sm"></i></a>
                            </li>
                            <li class="page-item">
                              <a class="page-link"
                                 href="?page_images={{ assistant_data.messages_with_images.paginator.num_pages }}"><i
                                class="ti ti-chevrons-right ti-sm"></i></a>
                            </li>
                          {% endif %}
                        </ul>
                      </nav>
                    </div>
                    <hr>
                    <h5><strong>Generated Files</strong></h5>
                    <div class="table-responsive">
                      <table class="table datatables-document">
                        <thead>
                        <tr>
                          <th>Chat Name</th>
                          <th>User</th>
                          <th>URL</th>
                          <th>Output Prompt</th>
                          <th>Generated At</th>
                          <th>Download</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for item in assistant_data.messages_with_files %}
                          <tr>
                            <td style="min-width: 150px; max-width: 150px;">
                              <strong>{{ item.message.multimodal_chat.chat_name }}</strong></td>
                            <td style="min-width: 150px; max-width: 150px;">
                              <strong>{{ item.message.multimodal_chat.user }}</strong></td>
                            <td style="min-width: 350px; max-width: 350px;">
                              <a href="{{ item.file }}" target="_blank" class="text-dark">
                                <i class="fa fa-link me-2"></i>
                                <span>
                                  {{ item.file }}
                                </span>
                              </a>
                            </td>
                            <td><strong>
                              <pre><code class="json overflow-auto rounded"
                                         style="max-width: 500px; min-width: 500px;">{{ item.message.message_text_content|safe|linebreaks }}</code></pre>
                            </strong></td>
                            <td style="min-width: 250px; max-width: 250px;">{{ item.message.sent_at }}</td>
                            <td>
                              <a href="{{ item.file }}" target="_blank" class="text-dark">
                                <i class="fa fa-download"></i>
                              </a>
                            </td>
                          </tr>
                        {% empty %}
                          <div class="card-body">
                            <div class="alert alert-warning" role="alert">
                              <i class="fa fa-exclamation-triangle me-4"></i>
                              <strong>No generated files found for this assistant.</strong>
                            </div>
                          </div>
                        {% endfor %}
                        </tbody>
                      </table>
                      <nav aria-label="Page navigation">
                        <ul class="pagination pagination-rounded pt-8">
                          {% if assistant_data.messages_with_files.has_previous %}
                            <li class="page-item">
                              <a class="page-link" href="?page_files=1"><i class="ti ti-chevrons-left ti-sm"></i></a>
                            </li>
                            <li class="page-item">
                              <a class="page-link"
                                 href="?page_files={{ assistant_data.messages_with_files.previous_page_number }}"><i
                                class="ti ti-chevron-left ti-sm"></i></a>
                            </li>
                          {% endif %}
                          {% for page_num in assistant_data.messages_with_files.paginator.page_range %}
                            <li
                              class="page-item {% if assistant_data.messages_with_files.number == page_num %}active{% endif %} mb-4">
                              <a class="page-link" href="?page_files={{ page_num }}">{{ page_num }}</a>
                            </li>
                          {% endfor %}
                          {% if assistant_data.messages_with_files.has_next %}
                            <li class="page-item">
                              <a class="page-link"
                                 href="?page_files={{ assistant_data.messages_with_files.next_page_number }}"><i
                                class="ti ti-chevron-right ti-sm"></i></a>
                            </li>
                            <li class="page-item">
                              <a class="page-link"
                                 href="?page_files={{ assistant_data.messages_with_files.paginator.num_pages }}"><i
                                class="ti ti-chevrons-right ti-sm"></i></a>
                            </li>
                          {% endif %}
                        </ul>
                      </nav>
                    </div>
                  </div>
                </div>
              {% empty %}
                <div class="card-body">
                  <div class="alert alert-warning" role="alert">
                    <i class="fa fa-exclamation-triangle me-4"></i>
                    <strong>No generated media stored for this organization yet.</strong>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <script src="{% static 'vendor/libs/plyr/plyr.js' %}"></script>

{% endblock %}
